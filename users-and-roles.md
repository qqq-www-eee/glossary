# Пользователи, исполнители, технадзоры, <br> должности, доступы, приглашения

<br>

## Введение (проблематика):

> В бизнес-логике системы представлены сущности, которые не являются зарегистрированными (авторизованными) пользователями, а являются, скорее, **контактами** (неавторизованными пользователями, dummy-пользователями, кандидатами в пользователи). И **контакты**, и **пользователи** соответствуют реальным людям - в частности, имеют атрибуты "ФИО" и "Телефон".
>   - **Контактами** могут являться исполнители и технадзоры, которых просто внесли в списки шахматок "Исполнители" и "Технадзоры", но которые сами не являются пользователями (т.е., это "атрибут" шахматки).  
>
>   - **Пользователями** могут являться прорабы и технадзоры, ведущие операционную деятельность в шахматке ("субъекты" по отношению к шахматке).  
>
> > Отсюда видно, что, как минимум, **технадзоры не позволяют полностью отделить пользователей от контактов** - список "Технадзор" в шахматке не подразумевает подтягивание данных из разных мест БД и сложную логику для их обработки, избежания дублей и т. д.

<br>

Решение 1: Разделение
> Минусы решения, в котором всех исполнителей (рабочий, бригадир) причисляют к **Контактам**, а основных пользователей (прораб/мастер участка/технадзор/начальник участка/др.) - к **Пользователям**:
> - вопрос с технадзорами (см. выше, с остальными при желании можно было продолжить); 
> - есть шанс запутать пользователя: вопрос либо перетекания контактов в пользователи + мерджа пользователей (когда аналогичный пользователь заводится из другого справочника), либо конфликнтый пользовательский опыт многократного использования одного и того же номера телефона в системе в разных ипостасях (шахматку меняет редактор-пользователь, а в списках он же значится просто как текст);
> - вопрос корректировки пользователем своих данных и невозможности подтягивания данной информации в списки шахматки;
> - плодим сущности без надобности с точки зрения БД, создаем много дублей (но это не критично);
> - затруднение дальнейшего сбора статистики и анализа; 
> - все равно надо будет вести таблицу, в которой записаны те же исполнители с привязкой к конкретному проекту (шахматке). Объем его будет сопоставим или больше, чем база никнеймов (алиасов): если никнейм в каждом проекте свой, то объем похож, а если никнеймы привязывать только к пользователю - то никнеймы даже выигрывают;
> 
> Аргументы за:
> - Простота реализации;
> - Мобильного приложения для рабочего, по всей видимости, не предвидится.

<br>

Решение 2: Единая база пользователей, сквозное отображение имен
> Другой вариант - мы вообще не отличаем пользователей от контактов и храним их в одной таблице в БД, отражение ФИО в системе сквозное. Возникают вопросы:
>   - Нормально ли явление коллективного редактирование имени? Это ведет к:
>     - потере пользовательских данных;
>     - путанице при использовании.
>   - Даже если коллективное редактирование для нас ОК, то кто именно вправе задавать сквозное имя для такого пользователя-контакта (его в разных шахматках вписывают в свои списки разные пользователи) - все, никто, система? Какое имя более правильное - первое или последнее? И пр.
>   - Можем ли мы распространять чувствительные данных по фио, телефону, телеграму и пр.?
> 
> Аргументы за:
> - Простота реализации;
> - Простота для пользователя.

## Вывод:

Решение 3: Никнеймы (алиасы)
> Ввод никнеймов в систему (говорим пока о ФИО и, возможно, о должности).  
> 
> **Плюсы**:  
> - Никнеймы потребовались бы, даже если **контакты** хранить отдельно от **пользователей** - сквозное изменение имен все равно проявилось бы для пользователей-технадзоров.  
> - Для реализации никнеймов необходима всего одна таблица, хранящая связь "ФИО данного пользователя для другого пользователя" или "Должность данного пользователя для другого пользователя". 
> - ~~Уже есть таблица, связывающая проект и пользователя - **project_role**. Смысл ее совсем другой (управление доступами), но при желании возможно добавить в эту связь "ФИО данного пользователя в данном проекте" и "Должность данного пользователя в данном проекте"~~.  
> - Никнеймы решат проблемы разных отображений имени в системе - то тремя полями, то одним полем. Тремя полями заполняем user (доступно только на экране "Учетная запись") и не показываем пока нигде, а одним полем - во всех остальных местах - в доступах, списках и т. д. (но можно было бы и перейти к одному и там, и там)
> - Если потребуется, на основе никнеймов возможно будет решить проблему управления доступами к контактным данным пользователей (один пользователь видит основной рабочий email технадзора, который сам и ввел, другой - личный email, третий - не видит ничего и т. д.);
> 
> **Минус**:  
> - Возможность видеть чужие никнеймы для знакомого мне пользователя (избыточность).  
> "Я записал Васю у себя как Василия Иванова и при этом смотрю в чужую шахматку, где он же записан как Василуалий Иванкевич. Я могу не сообразить, что речь идет об одном и том же человеке. Однако, ради создания в чужой шахматке единообразных нарядов и реестров, которые будут в коллективном пользовании у всех редакторов, я обязан в чужой шахматке видеть имена людей ровно так, как они записаны у создателя шахматки (либо как отражено в 1С, но это потом). Такая особенность есть только у имен; остальные данные (почта, зарплата, телеграм, семейный статус и прочее) - пользователь видит так, как знает из-под своего аккаунта). Если появится карточка пользователя, в ней теоретически можно будет отразить "мой никнейм", "никнейм в проекте" и пр."
> 
> Изменения в таблицу никнеймов (или другое место хранения никнеймов) могут вносить создатель проекта (шахматки) и редакторы проекта.  

## Предложения:

### Основные тезисы по типам пользователей:

> - **Контакты и пользователи** с точки зрения архитектуры не различимы;
> - "ФИО" ~~и "Должность"~~ пользователя в системе отображаются как алиасы - для каждого пользователя свои;
> - Для этого необходимо сделать таблицу, которая будет содержать отражение реальных системных пользователей на профиль текущего пользователя (кажется, нет смысла привязыват к каждому отдельному проекту);
> - Мы не хотим заставлять пользователей вести учет Фамилий, Имен и Отчеств, поэтому предлагается везде в интерфейсах перейти к единому полю - "ФИО" (а в разделе "Мой профиль" можно как поменять, так и оставить три поля, потому что таблица никнеймов позволяет это провернуть. Давайте пока оставим три поля).

### Основные тезисы по доступам:

> - "Чтение". Могут просматривать шахматку (объемы работ, исполнители, этажи), просматривать списки (справочники), просматривать наряды, просматривать все замечания. Могут создавать, менять и удалять свои замечания. Не видят доступы.
> - "Редактирование". Все то же, что "Чтение", плюс: редактировать шахматку, редактировать справочники и наряды (в т. ч. настраивать чужие никнеймы), создавать/редактировать свои замечания, а также менять статусы чужих замечаний. Могут редактировать доступы.
> - "Владелец". Создатель шахматки может делать все, в том числе редактировать и удалять чужие замечания и настраивать доступы.
> - ~~Человек сейчас может самовыпилиться из доступов, но это ок.~~

<br>

**Общая структура доступов**

| Функциональность                | Действия                                           | RE | ED | OW |
| ------------------------------- | -------------------------------------------------- | -- | -- | -- |
| Замечания                       | Просмотр чужих замечаний                           | +  | +  | +  |
|                                 | Смена статуса чужих замечаний                      |    | +  | +  |
|                                 | Создание, редактирование, удаление своих замечаний |    | +  | +  |
|                                 | Редактирование чужих замечаний                     |    |    | +  |
| Шахматки (статусы, объем работ) | Просмотр шахматки                    | +  | +  | +  |
|                                 | - Редактирование шахматки            |    | +  | +  |
| Списки (справочники)            | Просмотр                             |    | +  | +  |
|                                 | - Создание, редактирование, удаление |    | +  | +  |
| Наряды и реестры                | Просмотр                             | +  | +  | +  |
|                                 | - Создание, удаление, просмотр       |    | +  | +  |
| Доступы                         | Управление доступами                 |    | +  | +  |

### Дополнительные тезисы:

> - Доступы необходимо отвязать от должностей пользователей.
> - В одном и том же помещении могут быть замечания, оставленные разными технадзорами (т. е. разными пользователями с доступом редактирования). Какая-либо связь комментирующих пользователей с тем технадзором, который "закреплен" за помещением в шахматке (в боковой панели справа), технически отсутсвтует.
> - **Для каждого среза работ должны быть свои замечания**! Необходимо предусмотреть переключение между видами работ для замечаний (хотим мы работу/вид работы выбирать на экране замечаний либо хотим изначально навигироваться по работам, а замечания вынести в **Панель действий**). 
> - Вообще говоря, человек на двух объектах, тем более в разных должностях - кейс практически нереальный, и это аргумент в пользу задать job_title как сквозной атрибут пользователя. Но тогда должность, которая идет часто рядом с ФИО, будет самопроизвольно меняться, в то время как ФИО - не будет. Поэтому по итогу лучше относить должности тоже в **user_alias**. С должностями надо подумать, надо ли заморачиваться, но их отражение в системе желательно.

<br>

### Data base

<br>

> - Необходимо отвязать понятие "Должность" от доступов пользователей (role):  
Из таблицы  **project_role** убрать все записи, кроме "Чтение" и "Редактирование". Почти все остальные строки необходимо вынести в отдельную таблицу с должностями (напр., **user_job_title_d**, справочник, см. ниже) - либо просто иметь ее в виду и создать, когда станет необходима. В этой же таблице **project_role** нужно удалить поле (**status**) (это legacy). 
>  
> - В таблице **user** нужно убрать поля gender, status, comment и добавить поле job_title с uuid должности из справочника **user_job_title_d** (или строка, если не хотим заводить словарь). 
> - Необходимо реализовать новую таблицу для никнеймов (см. **user_alias** ниже). Поля в нем повторяют таблицу **user**, однако вместо полей first_name, middle_name, last_name необходимо использовать одно поле - full_name.
> - Таблицу **permissions**, вероятно, необходимо дропнуть (role и permissions вдвоем доставляют очень близкий по смыслу функционал регулирования доступов - мы имеем возможность и желание от этого дробления уйти).
> - Таблицу **role_permission**, вероятно, необходимо дропнуть.  
>
> - Предлагается в таблицах **role** ~~и **permission**~~ перейти в айдишниках от _serial4_ в пользу _uuid_.  
> - ~~В будущем у исполнителей может быть словарь из своих должностей: "бригадир" и "рабочий" (пока можно просто иметь в виду)~~.
> - Также далить поле _code_ в таблице **role**, перейти от serial4 к uuid и другие предложения (см. ниже).

<br>

### Back-end

<br>

> - Из настройки доступов, технадзоров и исполнителей информация (обычно это "ФИО" и "Должность") сохраняется в таблице с названием вроде **user_alias**. Телефон лучше хранить в основной таблице - **user**.
> - В экране "Моя учетная запись" добавить и сохранять поле "Должность".
> - При сохранении данных из экрана "Моя учетная запись" информация сохраняется в user.
> - Необходимо для редакторов и создателя шахматки добавить возможность корректировки исполнителя в справочнике проекта "Исполнители" без удаления строки.
> - Необходимо для редакторов и создателя шахматки добавить возможность корректировки технадзора в справочнике проекта "Технадзоры" без удаления строки.

<br>

### Design + Front-end

<br>

> - В экране "Мой профиль": необходимо добавить поле "Должность" на front-end в виде селектора (справочника) с единичным выбором;  
> - В экране "Настройка доступов" поле "Роль" переименовать в "Должность".
> - В экране "Редактирование спика ХХХ": когда на проект добавляется новый технадзор или исполнитель, при вводе номера телефона пользователь должен заранее видеть, как зовут в системе этого человека (поиск по таблицам user и worker).
> - Необходимо добавить возможность корректировки исполнителя - без удаления строки. Разлочить поля на фронт-енд.
> 

<br>

## Предложения по изменению в БД:

### Таблица user

_Изменение состава полей_

| Как сейчас:              | Как предлагается сделать:   | Комментарий |
| ------------------------ | --------------------------- | ----------- |
| id                       | id                          |             |
| first_name               | first_name                  |             |
| middle_name              | middle_name                 |             |
| last_name                | last_name                   |             |
| email                    | email                       |             |
| phone                    | phone                       |             |
| pic                      | pic                         |             |
| **status**               |                             |             |
| created                  | created                     |             |
| updated                  | updated                     |             |
| last_login               | last_login                  |             |
| **login**                | **(login?)**                |             |
| **pwd**                  | **(pwd?)**                  |             |
| **salt**                 | **(salt?)**                 |             |
| **password_set_by_user** | **(password_set_by_user?)** |             |
| **gender**               |                             |             |
| **comment**              |                             |             |
| telegram_id              | telegram_id                 |             |
| last_project_id          | last_project_id             |             |
|                          | job_title                   | Вместо таблицы **project_role** |

Сюда же можно прикрепить идентификатор в 1С на будущее (идентификатор "Исполниитель") - но тогда можно и в другие таблицы поле для идентификатора "Проект" и идентификатора "Работа" добавлять. Пока предлагается этому внимания не уделять.

<br> 

### Таблица user_alias (привязка пользователя к пользователям)

_Новая таблица_


| Как предлагается:  | Комментарий                                                             |
| ------------------ | ----------------------------------------------------------------------- |
| alias_uuid         | not null                                                                |
| user_uuid          | not null, **who**                                                       |
| account_owner_uuid | not null, **to whom**                                                   |
| full_name          | not null, **FIO alias**                                                 |
| email              |                                                                         |
| ~~phone~~          | ~~not null, но эта информация лежит в оригинальной таблице user~~       |
| telegram_id        |                                                                         |
| job_title          | **job title alias**                                                           |
| comment            | Пользовательский комментарий в свободной форме: "всегда пропадают мешалки", varсhar(255) |
| created            |                                                                         |
| updated            |                                                                         |

Позволит разным содателям именовать исполнителя/технадзора по-разному в своих шахматках. Переименование исполнителя одним пользователем теперь не отразится на шахматках других пользователей.  

<br> 


### Таблица permissions

_Удаление таблицы?_

<br> 

### Таблица role_permission

_Удаление таблицы?_

<br> 

### Таблица project_role

_Предложение по составу полей_
- Накаких статусов, кроме "активно", у записей нет, поэтому статус можно удалить, а при смене роли пользователя делать UPDATE существующей записи?

_Изменение состава полей_  

| Как сейчас: | Как предлагается: |
| ----------- | ----------------- |
| id          | id                |
| **status**  |                   |
| project_id  | project_id        |
| role_id     | role_id           |
| user_id     | user_id           |
| comment     | comment           |
| created     | created           |`
| updated     | updated           |

<br> 

### Таблица role

_Предложение по составу полей_
- Перейти от serial4 к uuid?
- Удалить поле code?

_Изменение содержимого_
- Убрать все, кроме редактора и читателя
- В целом, предполагается также роль "Владелец" - но мы ее отдельно не формализуем. Она дает доступ до настроек профиля, создания/удаления объектов, а также редактирования/удаления всех заметок, даже чужих.

| id  | name     | code |
| --- | -------- | ---- |
| 18  | Читатель | RE   |
| 19  | Редактор | ED   |

<br> 

### Таблица user_job_title_d

_Новая таблица_  
Отделилась от **role**. Возможно создать ее попозже или даже указывать должности пользователям строками, без использования словаря.

- Сразу uuid?
- Не переиспользовать поле code?
- Наполнение: ниже приведены должности, которые нужно будет отразить в селекторе на front-end и, соответственно, положить в таблицу user_job_titles:

| Должность          |
| ------------------ |
| Начальник участка  |
| Прораб             |
| Технический надзор |
| Мастер участка     |
| Сметчик            |
| Инженер ПТО        |
| Рабочий            |
| Бригадир           |
