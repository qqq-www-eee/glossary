# Пользователи, роли, доступы

### Должности, контакты, принадлежность к объекту, приглашения и прочее

<br>

## Введение

> - Необходимо переделать логинку поля "Должность" (справочник) и отвязать "Должность" от харадкодженых доступов.  
> - При редкатировании списка "Исполнители" должно быть четко написано, что вот мол эти люди увидят шахматку, как только зарегистрируются в системе. 
> - К замечаниям надо добавить автора!

Предложения по изменению в БД:

### Таблица user

| Как сейчас:          | Как предлагается сделать: | Комментарий |
| -------------------- | ------------------------- |-|
| id                   | id                        | |
| first_name           | full_name                 | not null|
| middle_name          |                           | |
| last_name            |                           | |
| email                | email                     | |
| phone                | phone                     | |
| pic                  | pic                       | |
| status               |                           | |
| created              | created                   | |
| updated              | updated                   | |
| last_login           | last_login                | |
| login                | (login)                   | |
| pwd                  | (pwd)                     | |
| salt                 | (salt)                    | |
| password_set_by_user | (password_set_by_user)    | |
| gender               |                           | |
| comment              | comment                   | Комментарий в свободной форме: "всегда пропадают мешалки", "прикапывается к углам" и пр., varсhar(255) |
| telegram_id          | telegram_id               | |
| last_project_id      | last_project_id           | |
|                      | job_title                 | Должность: справочник с возможностью добавления/удаления пользовательских должностей |

### Таблица project_role

| Как сейчас: | Как предлагается сделать: | Комментарий |
| ----------- | ------------------------- | ----------- |
| id          | id                        |             |
| status      | status                    |             |
| project_id  | project_id                |             |
| role_id     | role_id                   |             |
| user_id     | user_id                   |             |
| comment     | comment                   |             |
| created     | created                   |             |
| updated     | updated                   |             |

тут ничего не меняем

### Таблица role

> В идеале "Технический надзор" надо переименовать в "Инженер строительного контроля", потому что технадзор - термин, перекочевавший из СССР.
> 
> В таблице Прораб и произовдитель работ - задублированная информация. 

### Как отображается Таблица role в UI (и какие id выбраны):

| Должность в UI     | role.id в БД                   |
| ------------------ | ------------------------------ |
| Начальник участка  |                                |
| Прораб             |                                |
| Технический надзор | Инженер строительного контроля |
| Мастер участка     |                                |
| Бригадир           |                                |
| Рабочий            |                                |
| Сметчик            |                                |
| Инженер ПТО        |                                |
| Читатель           |                                |
| Редактор           |                                |

### Таблица permission

ЕЕ НАДО КАТЕГОРИЧЕСКИ СОКРАЩАТЬ! Если нигде не используется она, по фату так-то.

КАРТИНКА

Вместо uuid возможно использовать _serial4.

Как предлагается реализовать наполнение справочника:

| code              | comment |
| ----------------- | ------- |
| Начальник участка |         |
| Прораб            |         |
|                   |         |
|                   |         |
|                   |         |
|                   |         |
|                   |         |







Аргументы:
1. 3 поля под Фамилию, Имя и Отчетство вводить не нужны, достаточно фамилии почти всегда. Сейчас в 1С все равно вся верификация и выплаты будут в любом случае идти через человека (бухгалтера). В перспективе, когда нам потребуется интеграция с 1С будем просто из него получать и в него отдавать идентификаторы идентификаторы справочников из 1С (проект, работа, исполнитель). три поля не нужны.
2. логин-пароли не нужны, только телефон-смс?
3. Необходимо отвязать должность пользователя от его доступов.


### Проблема 1

**Требуется сложное разграничение доступов, не только по принципу "право на просмотр" / "право редактировать любые разделы"**.  
На одном проекте один и тот же пользователь Х может быть технадзором (оставлять замечания и производить приемку), на другом проекте - фигурировать как исполнитель работ.  
При этом, если пользователь - технадзор на двух проектах, на одном проекте может быть доступ с правом редактирования работ в помещениях (+ заметки), на другом - доступ с правом только на чтение шахматки (+ заметки).  
Если пользователь системы - исполнитель на нескольких проектах (так будет редко, и тогда он все равно по факту и.о. прораба), ему на разных проектах могут выдать доступ с разными правами:

- редактирования шахматки
- редактирования шахматки и справочников (работ, исполнителей), данных дефектовки и др. (бригадир)
- только на перевод работы в статус завершена
- с правом только на просмотр
- другие комбинации.

### Решение 1

1. Cистема должна предоставлять пользователю возможность **гибко настраиваить все доступы для всех пользователей**, являющихся участниками проекта, кроме себя.
2. Cистема должна предоставлять пользователю возможность удобно **просматривать данные по доступам** на проекте.
3. Система должна давать возможность проставлять должности пользователям и dummy-пользователям.
4. Система должна давать возможность просматривать должности пользователей и dummy-пользователям.
5. Должность пользователя напрямую жестко не связана с доступом к функционалу (связь подразуемевается, но не форсируется).
6. При создании пользователя и выборе ему должности права доступа автоматически предзаполняются!
7. В дальнейшем права доступа каждого из пользователей могут быть скорректированы.
8. Доступы существуют только в контексте данного объекта.

Возможная реализация:

- в разделе управления доступами к шахматке представлены категории функциональности;
  - в каждую категорию функциональности можно провалиться и увидеть перечень пользователей, имеющих к ней доступ;
    - в перечне пользователей для каждого пользоватея указываются
      - Телефон
      - ФИО
      - "Должность/Роль"
      - "Комментарий" (видны ± первые 50 символов)
      - Является ли пользователем ("Пользователь" / " " - flag, а может, просто иконка каски, например. потом сможет отображать онлайновость пользователей)
      - ~~измерение, по которому уже и произведена фильтрация - это сами доступы. Это набор из 8 флагов) 
  - в перечене категорий функционала должна быть отражена группа, в которую внесены все НЕ-пользователи и пользователи без доступа к шахматке (т.е. можно быть пользователем, числиться на объекте и при этом не иметь никаких доступов) - функционала у этой группы нет никакого, даже просмотра;
  - в каждой категории функциональности можно добавлять и удалять пользователей, имеющих к ней доступ.
  - ~~в каждого пользователя далее можно провалиться и увидеть профиль со сводной информацией по нему: телефон, ФИО, доступы, должность, комментарий~~
- система поддерживает отображение в виде перечня пользователей, с фильтрацией(поиском);
  - ~~из общего перечня пользователей можно также провалиться в пользователя и увидеть профиль со сводной информацией по нему~~.


У каждого пользователя системы есть поля "Должность" и "Является ли пользователем". В зависимости от их комбинации есть несколько вариантов дефолтного доступа:

Если кто-то не является пользователем, то он не может в системе ничего.
Если "Контакт" тел_1 имеет ссылку на шахматку, он все еще не может ее просмотреть, просто зарегистрировавшись - для этого ему должны быть выданы минимальные права.
Все Контакты, прикрепленные к проекту, зарегистрировавшись, смогут просматривать шахматку (над которой они и работают).
Но в редкатировании справочника исполнители - должно быть четко написано, что вот мол эти люди будут видеть шахматку.

В таблице считаем, что все, кто не прикреплены к объекту через списки (справочники), могут иметь доступ только к просмотру шахматок (со статусами и объемами работ) и к замечаниям.

При этом создатель шахматки всегда может делать все, вплоть до нарядов/реестров и списков

| Должность   | Что может по умолчанию | Комментарий |
|---------------------|----------------------|-----------|
| Контакт (unregistered) | Не может ничего. Может только зарегистрироваться. | - |
| Исполнитель (workman)  | Просмотр чужих шахматок (со статусами и объемами работ) и замечаний | Рабочие будут редко регаться, но если вдруг зарегистрируются, они смогут только читать и менять статус работ, и только если принадлежать к проекту |
| Пользователь или Прораб или Нач. уч. или Технадзор (user, foreman, techman, etc)| Может делать все с чужими шахматками и замечаниями. Работа с нарядами/реестрами и с списками - только по доступу создателя шахматки| |
| ИО (manager) | Режим полной свободны. Может делать с шахматкой все. Не может удалить объект. Не может редактировать наряды и реестры (никто не может). Может выдавать и забирать доступы, кроме создателя, у него на все карт-бланш всегда. |

Могу только я (создатель):
- создание и удаление шахматок в моем профиле
- Пользовательские (свои) настройки меняют только я
- Редактировать наряды и реестры нельзя вообще никому. Даже система этого делать не умеет. Можно только перейти в предыдущую версию и создать новый отчет на ту же дату.

| Функциональность | Комментарий | Кому дефолтно выдаются |
|--------------------|---------------------------------------------------------------------|----|
| Замечания          | Просмотр                                                            | Технадзор |
|                    | - Создание, редактирование (в том управление файламии), удаление замечаний, смена статуса замечания |
| Шахматки (статус и объем работ) | Просмотр                                                            |
|                    | - редактирование                                |
| Списки (aka справочники) | Просмотр                                                      |
|                    | - Создание, редактирование, удаление                                |
| Наряды и реестры   | Просмотр                                                            |
|                    | - Создание, удаление                                |





Только я и создатель шахматки можем создавать замечания и закрывать их. Другие замечания просматривают.
При этом если я исполнитель, то только я и создатель шахматки можем создавать работы и закрывать их. Другие работы просматривают.
Наряды и отчеты вообще никто, кроме пользователя, не видит.

**Проблема 2**: сквозные данные по ФИО - путают пользователяю, потому что это коллективное редактирование.
С точки зрения системы, оно должно быть

**Проблема 3**: чувствительные данные - я может даже и не хочу, чтобы мои данные кто-то видел, кроме начальника-прораба.

Что такое есть должность в нашей системе?
Не более, чем комментарий сейчас. Привязать разграничение доступов к должности можно, но нужно ли?
Так или иначе, лучше словарь должностей завести, если эта должность так уж нужна.
Нужен ли нам внутренний комментарий по всем нашим исполнителям?

Ролевая модель в системе на текущий момент отсутствует. То есть:
Пользователи никак не отличаются в системе друг от друга, даже если обладают разными должностями (прораб, начальник участка, технадзор, бригадир, мастер участка и др.). Во-первых, их функции могут меняться со временем, во-вторых иногда они совмещают разную деятельность. Например, Пользователь может быть
одновременно прорабом и технадзором, не говоря уже о разных ролях на разных объектах.

Основные функции, доступные любому пользователию в своем аккаунте - CRUD-операции для шахматок, нарядов/отчетов/реестров, справочников (работы, технадзоры, исполнители), замечаний, настройка (аккаунт, статусы, виды работ).

При этом надо понимать, что пользователь при формировании реестров на выплату все равно узнает ФИО работников. А вот работникам знать друг друга совсем не обязательно?

Могу ли я как пользователь видеть чувствительные данные исполнителей в шахматках, к которым у меня доступ на чтение? На редактирование?

| Кто | Что хочет | Для чего |
|-----|------|-------|
||||
|| Работа со своими шахматками ||
||||
| User | (!) Видеть полные ФИО своих исполнителей        | Формирование корректных нарядов, реестров, других документов |
| User | (!) Не вводить вручную ФИО своих исполнителей   | Ускорение и упрощение работы с продуктом                     |
| User | Совершать CRUD-операции над справочниками (работ, технадзоров, исполнителей) | Выполнение базовых действий с шахматкой, замечаниями, нарядами |
|      | - Изменять данные исполнителей                | Поддержка актуальной контактной информации - исполнители       |
|      | - Изменять данные технадзоров                 | Поддержка актуальной контактной информации - технадзор         |
| User | Совершать CRUD-операции над шахматками        | Базовая работа с шахматкой                                     |
| User | Совершать CRUD-операции над нарядами          | Базовая работа с нарядами                                      |
| User | Совершать CRUD-операции над замечаниями       | Базовая работа с замечаниями                                   |
| User | (!) НЕ изменяемость моих шахматок третьими лицами  | Не путаться, не терять реальные данные и не подозревать систему в скомпрометирвоанности |
| User | (!) Изменяемость моих шахматок третьими лицами     | Актуализация данных |
| User | (!) НЕ изменяемость моих замечаний третьими лицами | Не путаться, не терять реальные данные и не подозревать систему в скомпрометирвоанности |
| User | (!) Изменяемость моих замечаний третьими лицами    | Актуализация данных                                       |
| User | Давать возможность оставлять замечания как технадзору, так и исполнителю (бригадиру, например) | ?             |
| User | Давать возможность редактировать работы как исполнителю, так и технадзору                      | ?             |
| User | Изменять свои пользовательские настройки           | Поддержка актуальной контактной информации (своей) и персонализация |
| User | НЕ изменяемость моих настроек третьими лицами      | Не путаться, не терять реальные данные и не подозревать систему в скомпрометированности |
| User | Импортировать контакты из телефонной книги         | Быстрое заполнение справочников                         |
| User | Назначать себя исполнителем                        | Для удобства                                            |
| User | Назначать себя тезнадзором                         | Для удобства                                            |
| User | Назначать исполнителем dummy-пользователей         | Для упрощения/ускорения/удобства работы                 |
| User | Назначать исполнителем других пользователей        | Для избежания дублей между dummy- и full-пользователями |

| User | Создавать dummy-исполнителей                       | Для операционного учета, когда телефон человек неизвестен или его ФИО неизвестны, но создать надо |
| System | Превращать dummy-исполнителей в настоящих пользователей | Для того, чтобы впоследствии однозначно идентифицировать и анализировать связи людей, а еще если у нас телефон - не только логин, но и ключ к просто сущности, могут случиться перепутаница в ...  |
право выдавать доступы
|
||||
|| Смотрю чужие шахматки - просмотр ||
||||
| User | НЕ изменяемость моих настроек третьими лицами | Не путаться, не терять реальные данные и не подозревать систему в скомпрометирвоанности |

||||
|| Смотрю чужие шахматки - редактирование ||
||||

||||
|| Другие смотрям мои шахматки - просмотр ||
||||
||||
|| Другие смотрям мои шахматки - редактирование ||
||||
| Non-user | НЕ видимость моих данных никому, кроме непосредственного руководителя/прораба !!! | Сохранение конфиденциальности        |
| Non-user | Видимость моих данных всем                                                    !!! | Оперативное решение рабочих вопросов |
| System | Обеспечить возможность передавать все данные пользователей третьим лицам в неограниченном количестве | Юридическая чистота |

Пользователь всегда может менять свои системные настройки
Пользователь никогда может менять чужие системные настройки
При этом пользователь хочет всегда помечать другие телефоны так, как удобно ему. При этом чем ближе этот никнейм к реальному имени, тем меньше проблем с документами.
Но и бегать уточнять, как кого зовут, пользователь не хочет. Он хочет обозвать исполнителя как угодно. Потому через интеграцию с 1С надо нужны будут реальные имена.
Я могу хотеть дать возможность исполнителю вносить правки в работы на шахматке, но не вносить в замечания
Я могу хотеть дать возможность технадзорв вносить правки в замечния на шахматке, но не вносить в работы
Корректировать замечания может только их создатель или создатель шахматки.
Права на редактирование справочников должно быть отдельной вещью. Особенно работ
