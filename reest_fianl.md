## Реестры на выплату

###  Используемые понятия

| Термин           | Комментарий                                                                                        | Таблица             |
| ---------------- | -------------------------------------------------------------------------------------------------- | ------------------- |
| Название работы  | Название работы                                                                                    | work                |
| Работа           | Процесс выполнения некоторой строительной работы в некотором помещении                             | task                |
| Запись о работе  | Данные о работе, попавшей в реестр (одна строка реестра)                                           | payment_report_task |
| Запись об оплате | Данные о работе, попавшей в реестр в статусе "Оплачено" (одна строка реестра в статусе "Оплачено") | payment_report_task |

1) почасовая оплата эта, как для нее высчитывать стоимость работ?
2) "Расценка одна на все объекты." - звучит так, как будто нам надо в шаблоне работ work template хранить данные о цене работы. Но потом ниже идут строки о том что у нас цены только локально внутри объекта существуют . Это путает, непонятно в итоге. При создании самого первого реестра цены не должны быть указаны?
для меня все звучит так будто у нас есть дефолтные цены на все объекты ( лежат в work template). Когда создается справочник работ, эта цена копируется в сущность work. А дальше при создании реестра юзер уже может изменить цену конкретно для текущего объекта (обновится work, а work template - нет)
3) возможно на будущее надо подумать что делать с тезками исполнителями ( у которых ФИО одинаковое) - как их идентифицировать ? 
4) в комментах еще написала про то, нужно ли на страницу таски (работы) добавить ссылки на реестры, такие же как в сайдпанели
5) непонятно что происходит при массовом выделении ячеек - в сайдбаре выводятся данные о реестрах или нет ? это тоже в комментах есть

1) Надо будет ввести новую единицу измерения - час

и добавить несколько работ в шаблон, которые измеряются в часах, например
"Реставрация в Люберцах" - 100руб/час
"Реставрация Лефортово" - 20руб/час 

для меня все звучит так будто у нас есть дефолтные цены на все объекты ( лежат в work template). Когда создается справочник работ, эта цена копируется в сущность work. А дальше при создании реестра юзер уже может изменить цену конкретно для текущего объекта (обновится work, а work template - нет)
сделаем поле price в work_template и пусть копирует хоть из одного шаблона, хоть из другого, и пусть расценка меняется, кто его просил) Спасибо! Давай сделаем с дефолтными ценами
а цены дефолтные есть откуда взять?
прост если они поменяются, то надо будет в шаблоне их менять
3) пользователи и технадзоры будут храниться отдельно от user'ов. Они будут лежать скорее всего в новой общей таблице типа "Контакты данного user'а". 
Отличить тезку можно только по номеру телефона, но в нарядах его нет. Так что, скорее всего, останется, как есть 
4) Добавить в карточку "работы"
4) там история изменений есть
кстати надо будет добавить логов для истории изменений таски
типа "задачу внесли в реестр"
если это нужно
5) Я подумала, что незачем вроде выводить кучу всех реестров шахматки. Так что предлагаю ничего не выводить 

Я постараюсь подготовить руками, но через полгода или год они протухнут. С другой стороны:
1. кажется, что протухшие лучше, чем ничего
2. возможно, у нас будет начата интеграция с 1С

Надо еще попросить, чтобы в эту карточку можно было провалиться из работы, а то только из профиля "Вид работ" как-то не очень логично
Даже наоборот, из "Вида работ" очень хочется провалиться в обычную работу, а не в карточку. Но это скорее к Петру, и мне кажется оно со временем само нормализуется


### Предложения по БД

1. Использовать существующие таблицы: **task**, **payment_report**, **payment_report_task**
2. Добавить в **work_template** поле **price**.

###  Бизнес-требования

1. Пользователь должен иметь возможность в своей шахматке создавать и просматривать реестры на выплату для того, чтобы своевременно производить оплату труда на площадке.
2. Пользователи системы должны иметь возможность просматривать реестры хотя бы годичной давности для решения проблем, возникающих спустя значительное время после проведенной работы.
3. Пользователь должен иметь возможность давать другим пользователям доступ к функционалу просмотра и/или создания/редактирования реестров (т. е., иметь возможность жестко ограничить круг лиц, имеющих доступ к просмотру и созданию реестров), поскольку это чувствительная информация.

> а может быть такое что у кого-то есть доступ к шахматке, но нет к реестрам в этой шахматке?
> Сейчас нет, потому что мы закопаемся в доступах) но желательно рано или поздно разнести доступ к шахматке, заметкам, реестрам

4. Пользователи, имеющие право на просмотр и/или редактирование реестров, должны иметь возможность просматривать и редактировать шахматку.
5. Система запрещает пользователям (в том числе создателю реестра и владельцу шахматки), редактировать существующие реестры во избежание искажения или потери информации (реестр - слепок данных шахматки на определенный момент времени).
6. Система запрещает пользователям безвозвратно удалять реестры во избежание случайной потери информации.
7. Пользователь системы должен иметь возможность создавать, хранить и просматривать реестры, даже если в них лежат неполные, некорректные, противоречивые или дублирующие друг друга данные с целью гибкого использования реестров.
8. Система позволяет пользователю вручную назначать реестрам статус "Удален", по которому пользователи смогут идентифицировать реестры, не предполагающие дальнейшей работы.
9. Система позволяет пользователю вручную назначать реестрам статус "Оплачен", благодаря чему реестр начинает учитываться в системе как оплаченный при подсчете расхождений факта с проектом.
10. Система позволяет пользователю вручную назначать реестрам нейтральный статус "Сформирован".
11. При создании нового реестра система присваивает ему статус "Сформирован".
12. В сформированных реестрах система должна в табличном виде отображать пользователю следующую информацию:
    1. "Название работ";
    2. "Исполнитель";
    3. "Этаж";
    4. "Помещение";
    5. "Объем выполненных работ";
    6. "Расценка";
    7. "К выплате";
    8. "Накопительный итог".
13. Расценки на работу:
    1. Расценка зависит только от названия конкретной работы.
        1. Работы по объёму:
            1. Расценка одна на все объекты.
            2. Расценка одна для всех мастеров, делающих одну и ту же работу.
        2. Работы по часам:
            1. У разнорабочих бывают разные расценки из-за удалённости объекта (но все равно проще завести новую отдельную работу под данный объект). 
    2. В дальнейшем предполагается централизованное ценообразование из 1С.

> сейчас расценки подтягиваются только внутри одного объекта
> Переделывать не будем, так как технически сдельные и почасовые работы реализуются одинаково, а еще при клонировании (основной способ получить работы) цены также будут клонироваться. Отмечу это в требованиях ниже) спасибо!
> Короче, это не требование а вести с полей, непонятные пользователю

14. Система должна предоставлять пользователю возможность указать разные расценки для одинаково называемых работ, если они используются на разных объектах (work имеет поле price, по нему проверка заполнения).

> Есть уже расценки для каждой работы?

15. Сейчас в мобильных устройствах функционал реестров не реализуется. ~~Будет необходим в мобильном приложении как только будет реализована интеграция с 1C. Он будет работать только если устройство онлайн.~~
16. Система должна отображать в боковой панели рядом с информацией об объемах работ ("Всего"/"Дефектовка", "Выдано", "Выполнено") информацию обо всех записях об оплате, связанных с данной работой.
17. Система должна подсказывать пользователю, если он хочет оплатить работы, которые ведутся в помещении с незакрытыми замечаниями.

###  Ключевые тезисы

1. Частичных оплат нет:
    1. Каждая работа попадает в реестры сколь угодно много раз; работы нельзя "закрыть" какой-либо оплатой;
    2. При формировании реестра новые записи о работах "на остаток" не создаются;

    > таски автоматически не создаются на оставшийся объем? 
    > Ни автоматически, ни руками, никак не создаются. Живет одна таска и всегда попадает в наряды (разве что, пока ее бэкэнд как-нибудь не убьет)

    3. Общее число работ в проекте в стандартном случае постепенно становится равно **числу_этажей * число_комнат * число_названий_работ**.
2. Реестры на оплату сближаются по функциональности с отчетами, однако их предназначение и структура их полей отличаются. Цель отчетов - финансовое и операционное планирование, реестров - подсчет текущих выплат.
3. Критерии попадания работы в реестр упрощаются с:
    1. Статус "Завершено";
    2. Указаны "Исполнители";
    3. Указаны "Объемы";
    4. Отсутствует отметка об оплате.  
    до
    1. Указаны "Исполнители";
    2. Указаны "Объемы" (Выполненных работ).
4. Реестр невозможно отредактировать.
5. Реестр невозможно жестко удалить, но можно скрыть.
6. Реестры могут иметь статусы "Сформирован", "Оплачен", "Удален":
    1. "Сформирован" - нейтральный статус, реестр отображается в списке реестров, выдается по умолчанию;
    2. "Оплачен" - реестр должен отображаться в боковой панели шахматки - И в карточке работы тоже! обязательно;
    2. "Удален" - реестр непригоден или не интересен для дальнейшей работы; не отображается в списке реестров; однако может быть возвращен к статусу "Сформирован" или "Оплачен";
7. Статус реестра возможно менять вручную.
8. В готовый наряд необходимо добавить колонку "Накопительный итог" - сумма всех выплат, предназначенных данному человеку в этом наряде (executor_user_full_name). Вычисляемое значение. Встретится в таблице столько раз, сколько у исполнителя встретилось отдельных работ в данном реестре.
9. Спектр отображаемых данных в готовом реестре:
    1. Название работы
    2. Этаж
    3. Помещение
    4. Исполнитель
    5. Объем (выполненных работ)
    6. Расценка (на шаге 1 отсутствует)
    7. К выплате
    8. Накопительный итог (на шаге 1 отсутствует)

### Функциональные требования

1. Общие требования:
    1. Переход в раздел "Реестры на оплату" осуществляется:
        1. из шахматки через **Панель действий**, по клику на контрол "Реестр на выплату";
        2. из шахматки через **Боковую панель**, когда в **Левой панели** выбран профиль некоторой работы (но не профиль Замечаний и не профиль Вида работ) - в боковой панели в этом случае приведены кликабельные записи об оплатах для данной работы.
            1. в записях об оплате отображены:
                1. Дата формирования реестра,
                2. Исполнитель,
                3. Объем работ.
            2. Переходим в конкретный реестр, на который кликнул юзер. Другой вариант возможен, если у нас будет что-то вроде поиска/фильтрации в готовых нарядах. Но сейчас нет, поэтому проще всего кажется провалиться в конкретный наряд.
        3. **Со страницы просмотра работ!!**
    2. Пользователь с правом на "Чтение", на "Редактирование" и "Владелец" одинаково взаимодействуют с контролами как в **Панели действий**, так и в **Боковой панели**; они попадают на одни и те же страницы с реестрами, могут нажать на контролы "Создать реестр на выплату" вверху экрана или в заглушке.
    3. "Чтец" может просматривать список реестров и просматривать содержимое реестров, но не может создать новый реестр или изменить статус существующего реестра.
        1. Для пользователя с правом "Чтение" форма, открываемая на Шаге 1 формирования реестра, будет задизейблена; соответственно, он не сможет выбрать ни одну работу, и формирование реестра на этом остановится;
        2. Смена статуса существующего реестра (предположительно) останавлиается на экране просмотра наряда, где контрол смены статуса наряда будет [задизейблен](https://zpl.io/9qAW38y).
    4. "Редактор" и "Владелец" могут просмотреть список реестров, просмотреть содержимое любого реестра, создать новый реестр и изменить статус существующего реестра.
    5. Кнопка для перехода в раздел "Закрытие реестров" скрыта, пока в шахматке не настроены все справочники:
        1. сам объект;
        2. список работ на объекте; 
        3. список исполнителей;
        4. список технадзоров.
2. Просмотр списка реестров.
    1. В разделе "Реестры" система предоставляет пользователю возможность просмотреть наряды в статусах "Удален", "Оплачен", "Сформирован". 
    2. Пользователь может скрыть реестры в статусе "Удален".
    3. По умолчанию реестры в статусе "Удален" скрыты.
    4. Система предоставляет пользователю возможность создать новый реестр на выплату.
    5. Система предоставляет пользователю возможность вернуться назад к шахматке.
    6. Если для данной шахматки еще не было создано ни одного реестра, в разделе "Реестры" отображается заглушка с контролом на создание нового реестра.
    7. Если для данной шахматки создан хотя бы один реестр, система отображает таблицу реестров, в столбцах которой:
        1. Порядковый номер реестра;
        2. Дата создания реестра;
        3. Статус реестра. 
    8. Система предоставляет пользователю возможность осуществить сортировку таблицы реестров:
        1. Порядковый номер реестра: прямой и обратный алфавитный порядок;
        2. Дата создания реестра: прямой и обратный хронологический порядок;
        3. Статус реестра: прямой и обратный алфавитный порядок. 
3. Формирование нового реестра.
    1. Шаг 1 формирования нового реестра: Работы
        1. Система предоставляет пользователю возможность выбрать одну или несколько работ шахматки, которые войдут в наряд; 
        2. Система предоставляет возможность фильтровать работы:
            1. по названию работы; 
            2. по месту проведения работ (этаж + room_group);
            3. по исполнителю.
        3. Система предоставляет возможность сортировать работы по столбцам таблицы:
            1. по названию работы;
            2. по месту проведения работ (этаж);
            3. по месту проведения работ (room_group);
            4. по исполнителю;
            5. по объемам выполненных работ;
            6. по сумме к выплате.
        4. Система должна отображать для каждой работы ее текущий статус ("Завершено", "Ожидает дефектовку" и др.) ~~(вариант: светофор около каждой работы?)~~.
        5. Система должна помечать работы, которые проводятся в помещении, в котором есть незакрытые замечания.
        5. Система предоставляет возможность перейти из списка работ в карточку конкретной работы.
        5. Система предоставляет возможность по клику на отметку о наличии незакрытых замечаний в помещении увидеть список этих замечаний (в сайд-панели?) и перейти в них.
        6. Система должна отображать количество выбранных пользователем работ:
            1. если пользователь выбрал А работ, а результаты фильтрации/поиска вернули B работ, отображать число A.
        6. Система предоставляет возможность сбросить каждый из фильтров к исходному состоянию.
        7. Система предоставляет возможность выбрать все отфильтрованные работы с сохранением выбранных ранее позиций.
        8. Система предоставляет возможность снять выделение с отфильтрованных работ с вычитанием этих позиций из перечня ранее выбранных позиций.
        9. Если не выбрана ни одна работа, то по нажатии на кнопку "Продолжить" пользователь останется на экране и увидит уведомление с предложением выбрать хотя бы одрну работу ("желтое").
    2. Шаг 2 формирования нового реестра: Расценки
        1. Система предоставляет пользователю возможность указать расценку для каждой из названий работ, попавших в реестр.
            1. Расценка на работу зависит от названия работы (мы работаем в рамках одного объекта);
            2. Расценка на работу для разных мастеров одинакова.
        2. Работам, которые были выставлены в фильтрах, но не были реально найдены в шахматке, расценки указать нельзя. 
        3. Если расценка на работу с данным именем и на данном объекте:
            1. ранее указывалась пользователем в этой шахматке, предзаполнить поле "Цена" этим значением;
            2. ранее не указывалась пользователем в этой шахматке, оставить поле "Цена" непредзаполненным.
        4. Порядок отображения полей "Цена" - алфавитный.
        5. Система позволяет пользователю вернуться на экран выбора работ для наряда без сохранения значений полей "Цена", даже если они были заполнены пользователем.
        6. Если хотя бы для одной работы поле "Цена" не заполнено, система отрисовывает ошибку для этих инпутов и не позволяет перейти далее (**сейчас инпут подписывается и горит красным, но нужно "желтое" уведомление для единообразия опыта. В любом случае, тот же вопрос "Красный инпут vs уведомление" существует и при вводе телефона и кодов при регистрации, нужно, скорее всего, одно решение на всех**). Показать желтое уведомление с текстом "Заполните все расценки" и треугольником.
    3. Шаг 3 формирования нового реестра: Реестр создан
        1. Во время создания реестра, показывается заглушка в ширину экрана;
        2. После успешного создания система возвращает пользователя к списку реестров, в котором содержится новый реестр:
            1. Новому реестру автоматически присваивается порядковый номер, больший чем самый большой порядковый номер существующих реестров на 1.
            2. Новому реестру автоматически проставляются текущие дата и время.
            3. Новому реестру автоматически проставляются статус "Сформирован".
4. Просмотр реестра и смена статуса реестра.
    1. Система позволяет пользователю перейти из списка реестров в конкретный реестр через клик по строке таблицы.
    2. Система отображает конкретный реестр как таблицу со столбцами:
        1. Название работы;
        2. Этаж;
        3. Помещение;
        4. Исполнитель;
        5. Объем;
        6. **Расценка**;
        7. К выплате;
        8. **Накопительный итог** - сумма всех выплат, предназначенных данному исполниителю (встретится в таблице столько раз, сколько в данном реестре нашлось работ для данного исполниителя). Зависит от числа и содержимого конкретных записей о работе, вошедших в наряд.
    3. ~~Система позволяет направить реестр на выплату в 1С.~~
    4. Система позволяет скачать файл в формате xlsx ~~и pdf~~.
5. Отображение записей об оплате в боковой панели.
    1. В интерфейсе шахматки: если в левой панели выбрана некоторая работа и в рабочей области выбрана некоторая ячейка, в боковой панели система отображает данные по всем записям об оплате (payment_report_task) для данной комбинации **название_работы** + **этаж** + **room_group**, если связанный с ней наряд имеет статус "Оплачено". Отображаемые данные:
        1. ~~Номер наряда~~ (если помещается);
        2. Дата наряда без времени;
        3. Исполнитель;
        4. Объем;
        5. ~~К выплате~~ (если помещается).
    2. Порядок сортировки записей об оплате - хронологический. Самые недавние записи раполагаются выше, самые старые - ниже.
    3. Данные кликабельны. По клику на строку осуществляется переход к просмотру соответствующего реестра.
        1. Возврат назад в шахматку осуществляется пока через список реестров ("Назад к списку" -> "Назад к шахматке").
    4. Если в рабочей области выбрано несколько ячеек, то данные об оплатах в боковой панели:
        1. не отображаются.
6. Другие требования.
    1. При копировании названия работы из справочника работ
