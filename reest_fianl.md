## Реестры на выплату

###  Используемые понятия

| Термин           | Комментарий                                                                                        | Таблица             |
| ---------------- | -------------------------------------------------------------------------------------------------- | ------------------- |
| Название работы  | Название работы                                                                                    | work                |
| Работа           | Процесс выполнения некоторой строительной работы в некотором помещении                             | task                |
| Запись о работе  | Данные о работе, попавшей в реестр (строка реестра)                                           | payment_report_task |
| Запись об оплате | Данные о работе, попавшей в реестр в статусе "Оплачено" (строка реестра в статусе "Оплачено") | payment_report_task |

### Природа статусов

- У реестров есть как минимум два важных кейса применения:
    - Всевозможные завершенные работы за последнюю неделю. Составляется технадзором или прорабом для оплаты в бухгалтерии, содержит всевозможные фамилии мастеров (таким реестрам, скорее всего, будут проставлять статус "Оплачено"). 
    - Выписка по работам одного мастера и другие пользовательские реестры. Прорабам и технадзорам теперь запрещено скидывать в общие чаты общие реестры, так как в последних содержится чувствительная информация. Поэтому теперь крайне желательно иметь возможность скидывать работнику сводку в результатами только его труда (для одного отчетного периода этого возможно добиться с помощью фильтров).
- Если два человека имеют доступ к созданию реестров и преследуют при этом разные цели (например, технадзор формирует реестр на выплату + помощник прораба хочет распечатать работы какого-то мастера), то два и более реестра с одной и той же работой вынуждены будут сосуществовать одновременно. Однако сама работа, как правило, должна быть посчитана в лимитах лишь единожды, поэтому система предоставляет пользователю возможность напрямую проставить нужному реестру статус "Оплачено" (позже будет интеграция с 1С).

### Резюме  

1. Реестры на выплату могут находиться в двух статусах: "Сформирован" и "Оплачен":
    1. "**Сформирован**" - дефолтный статус (по сути 'черновик').
    2. "**Оплачен**" - статус означает, что система учитывает этот реестр при подсчете лимитов. Будет автоматически проставляться после интеграции с 1С, сейчас проставляется руками через некоторый контрол.
2. Реестр невозможно отредактировать или удалить.
3. При просмотре информации о работе система отобразит все реестры в статусе "Оплачено", куда вошла данная работа:
    1. в **боковой панели** шахматки;
        1. при массовом выделении ячеек в боковой панели данные о реестрах (записи об оплате) не выводятся;
    2. в **карточке работы**.
4. Необходимо добавить новый тип логов в историю изменений работы: "Задача внесена в реестр №ХХ".
5. К **сдельным** добавляются **почасовые** работы. Техническая реализация - в work_template добавятся нескольких новых почасовых работ с единицей измерения "час" (см. раздел Action Points).  
6. (продублировано в дизайн-доке "Настройка списка работ") При настройке списка работ: копирование работы из шаблона в шахматку подразумевает не только копирование названия работы, но также и дефолтной расценки (из work_template.price в work.price):
    1. Позже, при создании реестра, пользователь сможет скорректировать расценку работы на текущем объекте (обновится work.price).
7. Статусы работ, статусы замечаний, статусы реестров - разные сущности, не имеюшие между собой ничего общего.
8. Доступы не разделяются: доступ на редактирование шахматки = доступ на создание/редактирование замечаний = доступ на создание реестров.
9. В реестрах на выплату необходимо добавить "Накопительный итог":
    1. Реализация - новый столбец (если Иванов встретился пять раз в реестре, то после Шага 2 формирования реестра сложить на back-end все его выплаты в данном реестре и написать в последнем столбце суммарную цифру пять раз, в соответствующих строках).  
    2. ~~Альтернатива - выводить накопительный итог по исполнителям в отдельной таблице.~~
10. Необходима возможность поставить реестру название (комментарий), поскольку можно создать в один день несколько реестров (например, реестры с работами разных исполнителей конкретно по ним).
11. Частичных оплат нет:
    1. Каждая работа попадает в реестры сколь угодно много раз;
    2. Новые записи о работах "на остаток" не создаются ни руками, ни автоматически;
    3. Общее число работ в проекте постепенно станется равно **числу_этажей * число_комнат * число_названий_работ**.
12. Критерии попадания работы в реестр упрощаются с:
    1. Статус "Завершено";
    2. Указаны "Исполнители";
    3. Указаны "Объемы";
    4. Отсутствует отметка об оплате.  
    до
    1. Указаны "Исполнители";
    2. Указаны "Объемы" (Выполненных работ).
13. Сейчас в мобильных устройствах функционал реестров не реализуется ~~(позже будет вместе с интеграцией с 1C, будет работать только онлайн)~~.

### Функциональные требования

1. Общие требования:
    1. Переход в раздел "Реестры на оплату" осуществляется:
        1. из шахматки через **панель действий**, по клику на контрол "Реестр на выплату";
            1. Кнопка для перехода в раздел "Реестры на оплату" скрыта, пока в шахматке не будут настроены все справочники (сам объект, список работ на объекте, список исполнителей, список "технадзоров").
        2. из шахматки через **боковую панель**, когда в **левой панели** выбран профиль некоторой работы (но не профиль "Замечания" и не профиль "Вид работ") - в боковой панели тогда приведены кликабельные **записи об оплатах** для данной работы;
        3. Из **карточки работы**, где приведены кликабельные **записи об оплатах** для данной работы;
        4. Для **боковой панели** и для **карточки работы**:
            1. В записях об оплате отображены:
                1. Дата формирования реестра
                2. Исполнитель
                3. Объем работ.
            2. Переход осуществляется в конкретный реестр, на который кликнул юзер, в новом окне.
    3. Пользователи с правом на "Чтение", на "Редактирование" и "Владелец" одинаково взаимодействуют с контролами в **панели действий** и с ссылками в **боковой панели** и **карточке работы** - все попадают на одни и те же страницы с реестрами, могут просматривать реестры, нажимать на контролы "Создать реестр на выплату" вверху экрана или в заглушке. При этом:
        1. "Чтец":
            1. может просматривать список реестров, просматривать содержимое реестров;
            2. не может создать новый реестр, изменить статус реестра, изменить название реестра:
                1. **создание**: форма, открываемая на Шаге 1 формирования реестра, будет задизейблена; пользователь не сможет выбрать ни одну работу, и формирование реестра на этом остановится (с уведомлением "Выберите работы");
                2. **смена статуса**: контрол смены статуса реестра [задизейблен](https://zpl.io/9qAW38y) либо не отрабатывает, показывая уведомление (см. макет);
                3. **смена названия**: заблокирован контрол редактирования.
            3. никто не может редактировать и удалять реестры.
        2. "Редактор" и "Владелец":
            1. могут просматривать список реестров, просматривать содержимое любого реестра, создавать новый реестр, изменять статус реестра, изменять название реестра.
            2. могут давать другим пользователям доступ к функционалу просмотра и/или создания/редактирования реестров через обычный функционал доступов. Доступ на редактирование шахматки = доступ на создание/редактирование замечаний = доступ на создание реестров.
            3. никто не может редактировать и удалять реестры (в том числе создатель реестра и владелец шахматки).
2. Просмотр списка реестров.
    1. В разделе "Реестры" система предоставляет пользователю возможность просмотреть реестры в статусах "Оплачен", "Сформирован".
    2. ~~Пользователь может скрыть реестры в статусе "Удален".~~
    3. ~~По умолчанию реестры в статусе "Удален" скрыты.~~
    4. Система предоставляет пользователю возможность создать новый реестр на выплату.
    5. Система предоставляет пользователю возможность вернуться назад к шахматке.
    6. Если для данной шахматки еще не было создано ни одного реестра, в разделе "Реестры" отображается заглушка с контролом "Cоздать реестр на выплату".
    7. Если для данной шахматки создан хотя бы один реестр, система отображает таблицу реестров, в столбцах которой:
        1. Порядковый номер реестра;
        2. Дата создания реестра;
        3. Название реестра (комментарий к реестру);
        4. Статус реестра:
            1. Может быть "Сформирован" и "Оплачен".
    8. Система предоставляет пользователю возможность осуществить сортировку таблицы реестров:
        1. Порядковый номер реестра: прямой/обратный алфавитный порядок;
        2. Дата создания реестра: прямой/обратный хронологический порядок;
        3. ~~Название реестра: прямой/обратный алфавитный порядок;~~ 
        4. Статус реестра: прямой/обратный алфавитный порядок. 
    9. Существующие реестры невозможно удалить или отредактировать.
3. Формирование нового реестра.
    1. Шаг 1 формирования нового реестра: "Работы".
        1. В исходный список попадают работы, у которых: 
            1. Указаны "Исполнители";
            2. Указаны "Объемы" (Выполненных работ).
        1. Система предоставляет пользователю возможность выбрать одну или несколько работ шахматки, которые войдут в реестр; 
        2. Система предоставляет возможность отфильтровать работы:
            1. по названию работы; 
            2. по месту проведения работ (этаж + room_group);
            3. по исполнителю;
            4. по статусу работы.
        3. Система предоставляет возможность сортировать работы по столбцам таблицы:
            1. по названию работы;
            2. по месту проведения работ (этаж);
            3. по месту проведения работ (room_group);
            4. по исполнителю;
            5. по объемам выполненных работ;
            6. по сумме к выплате.
            7. по статусу работы (порядок согласно бизнес-логике: volumeEdit - draft - inProgress - readyToCheckTechnicalSupervisor - hasRevisions - completed и обратный)
        4. Система должна отображать для каждой работы ее текущий статус ("Завершено", "Ожидает дефектовку" и др.) ~~(вариант: светофор около каждой работы?)~~.
        5. Система должна помечать работы, которые проводятся в помещении, в котором есть незакрытые замечания. Система должна подсказывать пользователю, если он хочет оплатить работы, которые ведутся в помещении с незакрытыми замечаниями.
        5. Система предоставляет возможность перейти из списка работ в карточку конкретной работы.
        5. Система предоставляет возможность по клику на отметку о наличии незакрытых замечаний в помещении увидеть список этих замечаний (в сайд-панели?) и перейти в них.
        6. Система должна отображать количество выбранных пользователем работ:
            1. если пользователь выбрал А работ, а результаты фильтрации/поиска вернули B работ, отображать число A.
        6. Система предоставляет возможность сбросить каждый из фильтров к исходному состоянию.
        7. Система предоставляет возможность выбрать все отфильтрованные работы с сохранением выбранных ранее позиций.
        8. Система предоставляет возможность снять выделение с отфильтрованных работ с вычитанием этих позиций из перечня ранее выбранных позиций.
        9. Если не выбрана ни одна работа, то по нажатии на кнопку "Продолжить" пользователь останется на экране и увидит уведомление с предложением выбрать хотя бы одрну работу ("желтое").
        10. Система высчитывает стоимость работ почасовых работ: умножает стоимость часа на количество часов - точно так же, как для остальных более привычных единиц измерения.
    2. Шаг 2 формирования нового реестра: "Расценки".
        1. Система предоставляет пользователю возможность указать расценку для каждой из названий работ, попавших в реестр.
            1. ~~Расценка на работу зависит от названия работы~~ (мы работаем в рамках одного объекта);
            2. ~~Расценка на работу для разных мастеров одинакова~~.
        2. Для работ, которые были выставлены в фильтрах, но не были реально найдены в шахматке, расценки указать невозможно (отсутствует инпут). 
        3. Если расценка на работу с данным именем на данном объекте:
            1. ранее указывалась пользователем в этой шахматке ИЛИ изначально скопирована вместе с работой из шаблона, предзаполнить поле "Цена" этим значением (work.price);У тех работ, что взяты из шаблона, но цена в шаблоне была 0 или  null, цена не предзаполнена;
            2. была создана пользователем и ранее не указывалась пользователем в этой шахматке () оставить поле "Цена" непредзаполненным. У тех работ, что созданы руками, цена не предзаполнена.
            3. В итоге при создании самого первого реестра цены должны быть предзаполнены для тех работ, которые были взяты из шаблона, и в шаблоне была указана ненулевая расценка (не 0 и не null).
            4. По-хорошему сразу при создании работ надо указывать расценку, но мы редактируем через реестры. Так можно и цену скорректировать, и название работы не трогать.
        4. Порядок отображения полей "Цена" - алфавитный.
        5. Система позволяет пользователю вернуться на экран выбора работ для реестра без сохранения значений полей "Цена", даже если они были заполнены пользователем.
        6. Если хотя бы для одной работы поле "Цена" не заполнено, система отрисовывает ошибку для этих инпутов и не позволяет перейти далее (**сейчас инпут подписывается и горит красным, но нужно "желтое" уведомление для единообразия опыта. В любом случае, тот же вопрос "Красный инпут vs уведомление" существует и при вводе телефона и кодов при регистрации, нужно, скорее всего, одно решение на всех**). Показать желтое уведомление с текстом "Заполните все расценки" и треугольником.
        7. > расценки подтягиваются только внутри одного объекта - переделывать не будем, так как технически сдельные и почасовые работы реализуются одинаково, а еще при клонировании (основной способ получить работы) цены также будут клонироваться
            1. Есть расценки для каждой работы - [тут]
    3. Шаг 3 формирования нового реестра: "Реестр создан".
        1. Во время создания реестра, показывается заглушка в ширину экрана;
        2. После успешного создания система возвращает пользователя к списку реестров, в котором содержится новый реестр:
            1. Новому реестру автоматически присваивается порядковый номер, больший чем самый большой порядковый номер существующих реестров на 1.
            2. Новому реестру автоматически проставляются текущие дата и время.
            3. Новому реестру автоматически присваивается имя "Реестр на выплату № НОМЕР от ДАТА" ("Реестр на выплату № 6 от 15 февраля 2023")
            4. Новому реестру автоматически проставляются статус "Сформирован".
4. Просмотр реестра, смена статуса реестра, изменение названия реестра.
    1. Система позволяет пользователю перейти из списка реестров в конкретный реестр через клик по строке таблицы.
    2. Система отображает конкретный реестр как таблицу со столбцами:
        1. Название работы;
        2. Этаж;
        3. Помещение;
        4. Исполнитель;
        5. Объем;
        6. **Расценка**;
        7. К выплате;
        8. **Накопительный итог** - сумма всех выплат, предназначенных данному исполниителю (встретится в таблице столько раз, сколько в данном реестре нашлось работ для данного исполниителя). Зависит от числа и содержимого конкретных записей о работе, вошедших в реестр.
    9. Спектр отображаемых данных в готовом реестре:
        1. Название работы
        2. Этаж
        3. Помещение
        4. Исполнитель
        5. Объем (выполненных работ)
        6. Расценка (на шаге 1 отсутствует)
        7. К выплате
        8. Накопительный итог (на шаге 1 отсутствует) - сумма всех выплат, предназначенных данному человеку в этом реестре (executor_user_full_name). Вычисляемое значение. Встретится в таблице столько раз, сколько у исполнителя встретилось отдельных работ в данном реестре.
    12. В сформированных реестрах система должна в табличном виде отображать пользователю следующую информацию:
        1. "Название работ";
        2. "Исполнитель";
        3. "Этаж";
        4. "Помещение";
        5. "Объем выполненных работ";
        6. "Расценка";
        7. "К выплате";
        8. "Накопительный итог".
    3. ~~Система позволяет направить реестр на выплату в 1С.~~
    4. Система позволяет скачать файл в формате xlsx ~~и pdf~~.
    5. Необходима возможность поставить реестру название (комментарий)
5. Отображение записей об оплате в боковой панели.
    1. В интерфейсе шахматки:
        1. если в левой панели выбрана некоторая работа и в рабочей области выбрана некоторая ячейка, в боковой панели система отображает данные по всем записям об оплате (payment_report_task) для данной комбинации **название_работы** + **этаж** + **room_group**, если связанный с ней реестр имеет статус "Оплачено". Отображаемые данные:
            1. ~~Номер реестра~~ (если помещается);
            2. Дата реестра без времени;
            3. Исполнитель;
            4. Объем;
            5. ~~К выплате~~ (если помещается).
        2. Порядок сортировки записей об оплате - хронологический. Самые недавние записи раполагаются выше, самые старые - ниже.
        3. Данные кликабельны. По клику на строку осуществляется переход к просмотру соответствующего реестра.
            1. Возврат назад в шахматку осуществляется пока через список реестров ("Назад к списку" -> "Назад к шахматке").
        4. Если в рабочей области выбрано несколько ячеек, то данные об оплатах в боковой панели:
            1. не отображаются.
    2. В карточке работы;
    3. Добавить новый тип логов в историю изменений работы: "Задача внесена в реестр №ХХ".
    4. Можно менять статус "Оплачен" и "Сформирован" - пока что туда и обратно без ограничений. Статус реестра возможно менять вручную.
6. Другие требования.
    1. В карточку работы должно быть можно перейти из боковой панели в профиле работы (не только из профиля "Вид работ").
    2. При этом из профиля "Вид работ" очень хочется переходить сначала в профиль работы, а уже потом в карточку работы и логи.
    3. Всегда при копировании "Названия работы" из шаблона работ в список работ шахматки ([макет](https://zpl.io/xmgKoB3)) должна копироваться расценка. Скопированная расценка нигде на макетах не отображается. - данное требование из фичи **"Настройка списка работ"**. (work.price - а оттуда она была скопирована из work_template.price)
    4. Если новый прайс 0 или null, он не перезатирает существующее значени стоимости работ!!!
    5. В карточку работы можно перейти из боковой панели в профиле работы (не только из профиля "Вид работ").
    6. Более того, из "Вида работ" очень хочется переходить сначала в профиль работ, а не в карточку работы? А из сайдбара в профиле работы уже есть переход в карточку с логами.

### Предложения по БД

1. Использовать существующие таблицы: **task**, **payment_report**, **payment_report_task**
2. Добавить в **payment_report_task** поля:
    - float **price** для хранения расценок (чтобы не считать total_price / volume);
    - float **executor_total** - "Накопительный итог", просуммированный итог этого конкретного исполнителя в этом наряде;
    - varchar **task_status** - статус работ на момент формирования реестра;
3. ~~Замечания на момент формирования наряда требуют отдельной таблицы. Пересечение с фичей "Версионирование"~~.
4. Добавить в **work_template** поле **price**.
5. Добавить в шаблон work_template почасовые работы (9 работ):  

| work_template_id | user_id | template_id | name                                                  | despription      | unit_id | price  | created | updated |
| ---------------- | ------- | ----------- | ----------------------------------------------------- | ---------------- | ------- | ------ | ------- | ------- |
| my_uuid          | [NULL]  | [NULL]      | Ремонт наливного пола ЛК (ЧАС)                        | Почасовая работа | 26      | [NULL] | now()   | now()   |
| my_uuid          | [NULL]  | [NULL]      | Монтаж панелей албес после демонтажа смежниками (ЧАС) | Почасовая работа | 26      | [NULL] | now()   | now()   |
| my_uuid          | [NULL]  | [NULL]      | Монтаж подрезков плитки и кабанчика (ЧАС)             | Почасовая работа | 26      | [NULL] | now()   | now()   |
| my_uuid          | [NULL]  | [NULL]      | Зачеканка некратных мест (ЧАС)                        | Почасовая работа | 26      | [NULL] | now()   | now()   |
| my_uuid          | [NULL]  | [NULL]      | Замазка штроб и подрозетников (ЧАС)                   | Почасовая работа | 26      | [NULL] | now()   | now()   |
| my_uuid          | [NULL]  | [NULL]      | Подготовка под покраску калошницы ЛК (ЧАС)            | Почасовая работа | 26      | [NULL] | now()   | now()   |
| my_uuid          | [NULL]  | [NULL]      | Мелкие работы по подвалу (ЧАС)                        | Почасовая работа | 26      | [NULL] | now()   | now()   |
| my_uuid          | [NULL]  | [NULL]      | Шлифовка ступеней ЛК (ЧАС)                            | Почасовая работа | 26      | [NULL] | now()   | now()   |
| my_uuid          | [NULL]  | [NULL]      | Реставрация (ЧАС)                                     | Почасовая работа | 26      | [NULL] | now()   | now()   |

6. Добавить в **work_template** остальные шаблонные работы (сдельные) с расценками согласно [таблице]().

### LATER 

Подумать еще, будет ли у нас что-то вроде поиска/фильтрации в готовых реестрах. Сейчас запроса нет, можно обойтись сортировкой.