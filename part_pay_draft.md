## Реестры на выплату. Частичное закрытие работ

###  Используемые понятия

Контрол "Реестры на выплату" - новое название контрола "Закрытие нарядов"

| Термин                        | Значение, синонимы | Таблица в БД |
| ----------------------------- | ------------------------------ |------------- |
| **Реестр на выплату**, **реестр** | Сводная таблица с результатами работы мастеров за характерное время с указанием объемов и расценок (обычно объемы работ указывают при закрытии **наряда**, а итоговую сумму для исполнителей - в **реестрах на выплату**. У наc реализовано единое представление с объемами и выплатами, называемое реестром). | **payment_report** |
| **Расчетный период**          | Диапазон времени, за который учитываются работы при составлении реестра. | - |
| **Название работы**                    | Название строительной работы. | **work** |
| **Работа**           | Процесс выполнения некоторой строительной работы в некотором помещении; а также сущность в системе для обозначения этого процесса. | **task** |
| **Запись о работе**   | Объем работы, попавший в реестр (одна строка реестра). | **payment_report_task** |
| **Запись об оплате**  | Объем работы, попавший в реестр в статусе "Оплачено" (одна строка реестра со статусом "Оплачено"). | **payment_report_task** |
| **Расценка**  | Стоимость работы в рублях за единицу измерения работы (час, м2 и т. д.). | **payment_report_task** |

### Предложения по БД

1. Использовать существующие таблицы: **task**, **payment_report**, **payment_report_task**

###  Бизнес-требования

1. Пользователь должен иметь возможность в своей шахматке создавать и просматривать **реестры на выплату** для того, чтобы своевременно производить оплату труда на площадке.
2. Пользователи системы должны иметь возможность просматривать реестры хотя бы годичной давности для решения проблем, возникающих спустя значительное время после проведенной работы.
3. Система должна предоставлять пользователю возможность быстро найти необходимый реестр в списке реестров.
4. Пользователь должен иметь возможность давать другим пользователям доступ к функционалу просмотра и/или создания/редактирования реестров (т. е., иметь возможность жестко ограничить круг лиц, имеющих доступ к просмотру и созданию реестров), поскольку это чувствительная информация.
5. Пользователи, имеющие право на просмотр и/или редактирование реестров, должны иметь возможность просматривать и редактировать шахматку.
6. ~~Обратное неверно. Пользователь (владелец) может ограничить право просмотра и/или редактирования реестров для других пользователей, но при этом оставить им право на просмотр и/или редактирование шахматки.~~  
7. ~~Пользователь должен иметь возможность давать право на просмотр и/или редактирование реестров отдельно от права на создание/редактирование замечаний.~~
8. Система запрещает пользователям (в том числе создателю реестра и владельцу шахматки), редактировать уже существующие реестры во избежание искажения или потери информации (реестр - слепок данных шахматки на определенный момент времени).
9. Система не дает пользователю возможности безвозвратно удалять реестры, чтобы избежать случайной потери информации.
10. Пользователи системы должны иметь возможность хранить и просматривать любые созданные реестры (даже если в них лежат неполные, некорректные, противоречащие друг другу или дублирующиеся данные) с целью гибкого использования реестров.
11. Система позволяет пользователю вручную назначать реестрам статус "**Удален**", по которому пользователи смогут идентифицировать реестры, не предполагающие дальнейшей работы.
12. Система позволяет пользователю вручную назначать реестрам статус "**Оплачен**", благодаря которому реестр учитываться в системе как оплаченный - то есть, при подсчете расхождений факта с проектом (в "Лимитах").
13. Система позволяет пользователю вручную назначать реестрам нейтральный статус "**Сформирован**".
14. При создании нового реестра система присваивает ему нейтральный статус "**Сформирован**".
16. При формировании реестра система должна в табличном виде отображать пользователю следующую информацию:
    1. "Название работ";
    2. "Исполнитель";
    3. "Этаж";
    4. "Помещение";
    5. "Объем выполненных работ";
    6. "Расценка";
    7. "К выплате";
    8. "Накопительный итог".
17. Накопительный итог - это
18. Насчет индивидуальных расценок:
    1. По объёму: в 99.9% расценки одни на все объекты, но иногда отличаются. Для мастеров, делающих одну и ту же работу, цена никогда не различается.
    2. По часам: у разнорабочих бывают разные расценки, например, из-за удалённости объекта. Но. Тогда, конечно, проще заводить новую просто работу под данный объект?
19. (?) Система должна предзаполнять инпут расценки для работ, даже если работа с таким названием еще не заполнялись на данном объекте, но заполнялась на других объектах (в work_template тоже должно быть поле "price", и оно апдейтится каждый раз, когда работа с таким же именем в некоторой шахматке обновила расценку).
20. Система должна предоставлять пользователю возможность указать разные расценки для одинаково называемых работ, если они используются на разных объектах (work имеет поле price, так что все ок).
21. ~~Функционал закрытия реестров будет необходим в мобильном приложении как только будет реализована интеграция с 1C. Он будет работать только если устройство онлайн.~~ Сейчас в мобильных устройствах функционал реестров не реализуется.
22. Система должна отображать в боковой панели рядом с информацией об объемах работ ("Всего"/"Дефектовка", "Выдано", "Выполнено", "Отстаток" (пока нет) или других) информацию обо всех **записях об оплате**, связанных с данной **работой**.

###  Ключевые тезисы

1. "Частичных оплат" более нет (частичные оплаты и полные оплаты не различимы):
    1. Каждая работа попадает в реестры сколь угодно много раз;
    2. Работы нельзя "закрыть" какой-либо оплатой - работа может получить сколь угодно много **записей об оплате**, попав в несколько разных реестров;
    3. При формировании реестра новые записи о работах "на остаток" не создаются;
    4. Общее число работ в проекте в стандартном случае постепенно становится равно **числу_этажей * число_комнат * число_названий_работ** - и далее больше не растет.
2. Реестры на оплату сближаются по функциональности с отчетами. Однако отчеты и реестры отображают разные поля и в разном порядке - несмотря на схожесть структуры, предназначение у них разное: у отчетов - финансовое и операционное планирование, у реестров - корректный подсчет текущих расходов на выплаты.
3. Критерии попадания работы в реестр упрощаются с:
    1. Статус "Завершено";
    2. Указаны "Исполнители";
    3. Указаны "Объемы";
    4. Отсутствует отметка об оплате.  
    до
    1. Указаны "Исполнители";
    2. Указаны "Объемы".
4. Реестр невозможно отредактировать.
5. Реестр на текущий момент невозможно жестко удалить, но можно скрыть (отправив в корзинку, поставив фильтр или как-то иначе).
6. Реестры могут иметь статусы "Сформирован", "Оплачен", "Удален":
    1. "Сформирован" - нейтральный статус, реестр отображается в списке реестров, выдается по умолчанию при создании реестра;
    2. "Оплачен" - реестр должен учитываться системой при работе с лимитами (должен отображаться в боковой панели шахматки);
    2. "Удален" - реестр непригоден или не интересен для дальнейшей работы; не отображается в списке реестров; однако может быть просмотрен пользователем где-то еще и возвращен к статусу "Сформирован" или "Оплачен";
7. Статус реестра возможно менять вручную.
8. Спектр отображаемых данных в реестре:
    1. Название работы
    2. Этаж
    3. Помещение
    4. Исполнитель
    5. Объем
    6. Расценка
    7. К выплате
    8. Накопительный итог
    9. ~~Остаток~~
    10. ~~Всего~~
    11. ~~Процентовка~~
    12. ~~Расценка~~
9. ~~Возможно, при формировании реестра добавится фильтр по статусу работ ("Готово", "В работе", др.).~~
10. ~~Возможно, в списке реестров добавится быстрый поиск по дате и добавится фильтр по статусу реестра ("Удален", "Оплачен", "Сформирован").~~
11. ~~Возможно, в недалеком будущем потребуется разделение прав на редактирование шахмакти, редактирование замечаний, создание реестров".~~
11. Данная фича может быть зааффекчена фичей "Версионирование шахматки".
12. Данная фича может быть зааффекчена фичей "Лимиты".

### Функциональные требования

1. Переход в раздел "Реестры" осуществляется:
    1. из шахматки через **Панель действий**, по клику на контрол "Реестр на выплату";
    2. из шахматки через **Боковую панель**, если в **Левой панели** выбран профиль некоторой работы (но не профиль замечаний и не профиль вида работ). В боковой панели шахматки в этом случае будут отображены ссылки на все реестры, в которые данная работа попала и которые имеют статус "Оплачен".
    3. "Чтец" может просматривать список реестров и просматривать содержимое реестров, но не может создавать новый реестр или менять статус существующего реестра.
    3. "Редактор" и "Владелец" могут просматривать список реестров, просматривать содержимое реестров, создавать новые реестры и менять статус существующего реестра.
    4. Пользователь с правом на "Чтение" и пользователь с правом на "Редактирование" одинаково взаимодействуют с контролами как в **Панели действий**, так и в **Боковой панели** и попадают на одинаковую страницу с реестрами. 
        1. Для пользователя с правом "Чтение" кнопка "Создать реестр на выплату" вверху экрана или в заглушке задизейблена.
    5. Пользователи с правами на "Чтение шахматки" и пользователи с правами на "Редактирование шахматки" видят состав боковой панели одинаково:
        1.  кликает на 
2. Просмотр списка реестров.
    1. В разделе "Реестры" должны отображаться все созданные для данной шахматки реестры, удовлетворяющие условию:
        1. Имеют статус "Оплачено" или "Сформирован".
    2. В верхней части экрана доступны контролы "Создать реестр на выплату" и "Назад к шахматке".
    2. Если для данной шахматки не было создано ни одного реестра, в центре экрана показывает заглушка, дублирующая контрол "Создать реестр на выплату"
    2. фвыа
    3. Фильтрация и сортировка
3. Формирование нового реестра.
    1. Шаг 1 при формировании нового реестра.
        1. фыва
        2. фыва
        3. Фильтрация и сортировка
    2. Шаг 1 при формировании нового реестра.
        1. фыва
        2. фвыа
        3. Фильтрация и сортировка
        4. Возвращение на экран списка реестров.

4. Просмотр реестра и Смена статуса реестра.
5. Отображение **записей об оплате** в **боковой панели**.
    1. Это текст. Он ни в коем случае не показывает ничего про деньги, но показывает кое-что про объемы.
    2. При этом иногда мы хотим видеть информацию и о деньгам - например, у нас сменились расценки и нужно понимать, как считается юнит-экономика для данного помещения.
    3. Порядок отображения со датам
6. ДОлжно быть можно работу просто уже нафиг закрыть руками, чтобы она в реестры больше не попадала. Почему бы и нет, очень будет удобно.

7. Чтобы не терять наполнение работ исполнителями надо дать возможность редактировать "контакты" пользователя. 
8. Система должна ругаться, если необходимые данные не заполнены пользователем.


Должен быть поиск по списку реестров, помогающий пользователю идентифицировать нужный реестр за определенный расчетный период (все такие реестры.)
1. При первом входе в раздел "Закрытие реестров" пользователь видит заглушку с кнопкой "Создать реестр"(?).
2. В разделе "Закрытие реестров" система предоставляет пользователю возможность создать новый реестр.
2. В разделе "Закрытие реестров" есть сортировка
    1. По статусу;
    2. По дате создания;
    3. По номеру.
2. В разделе "Закрытие реестров" есть фильтрация??
    1. По статусу;
    2. По дате создания;
    3. По номеру.
3. В разделе "Закрытие реестров" система предоставляет пользователю возможность вернуться в шахматку без создания реестра.
4. При нажатии на кнопку "Создать реестр на выплату" 
5. Фильтрация  
    1. Есть кнопка сброса всех фильтров
    2. Есть кнопки сброса каждого фильтра в отдельности
    3. Есть фильтры:
        1. По этажам и помещениям
        3. По исполнителям
        4. По названию работы
        4. ~~По статусу работы~~
6. ~~Статус работы выводится как светофор около каждой работы.~~
7. ~~Статус реестра выводится как поле в списке реестров.~~
8. Система предоставляет пользователю возможность сортировать реестры по номеру и по дате создания.
8. Кнопка для перехода в раздел "Закрытие реестров" недоступна, пока в шахматке не настроено хотя бы один справочник из списка:
    1. сам объект;
    2. список работ на объекте; 
    3. список исполнителей;
    4. список технадзоров.
9. Если на шаге 1 не выбрана ни одна работа, то по нажатии на кнопку "Продолжить" пользователь останется на экране и получит нотификацию с предложением выбрать хотя бы одрну работу. 
9. Система отображает 20 реестров на странице.
10. Если оставлено пустым на шаге 2, то пользователь видит либо
    1. НЕ красный инпут! ~~с предложением "Обязаетельно для заполнения"! Красным инпутом мы подсвечиваем некорректный формат вводимых в поле данных. Тем более если у нас 10 работ, на них всех напишется одно и то же, с нотификацией - экономичнее для красного цвета.~~
    2. Уведомление с текстом "Заполните все расценки" и, возможно, желтым треугольником, раз уж у нас такая ошибка на первом шаге.
10. фыва

### Нефункциональные требования

1. Быстродействие - будет постепенно уточняться.
2. Безопасность:
    1. Доступ к просмотру и редактированию реестров необходимо в будущих версиях настраивать отдельно от просмотра / редактирования самой шахматки, иначе либо редакторов будет мало, либо знать они будут слишком много.


### Backlog

1. Импорт, экспорт реестров в xlsx и pdf. Печатные формы, работа с документами. Системный подход к печати всех доков в продукте.
2. (?) "Пользовательская" сортировка работ (по бизнес-последовательности, не по алфавиту).
3. (?) Массовое действие из шахматки: выбрать несколько ячеек и сформировать по ним всем реестр (и только по ним). 
4. Приводить информацию из реестров в боковой панели шахматки: не только по объемам, но и по расценкам, особенно, если они изменились.

### Непростой пример E2E (web-версии)

1. **Пользователь** (**П**) заходит в чужую шахматку, где обладает правами "Редактора". Шахматка полностью настроена, в нее внесен ряд актуальных работ. Реестров на базе данной шахматки еще не создавалось.
2. **П** переходит в раздел "Реестр на выплату", где сможет увидеть все созданные реестры и кнопку "Создать реестр". Так как реестров не создавались, сейчас **П** видит заглушку, где дублируется предложение "Создать реестр на выплату". Нажимает на любую из кнопок "Создать реестр на выплату".
3. Запускается процесс создания нового реестра, в результате чего **П** видит таблицу со списком всех работ, которые есть в шахматке в данное время. У них:
    1. указаны исполнители;
    2. указаны объемы.
4. **П** выставляет фильтр по названию работы ("Поклейка обоев почасовая" И "Поклейка обоев в м2"), а также фильтр по месту проведения ("этаж 2, все помещения"). Видит только работу "Поклейка обоев почасовая", для которой приведены всевозможные исполнители. Для "Поклейка обоев в м2" подходящих работ не нашлось.
5. **П** выбирает с помощью чекбоксов интересующие его работы (например, все 5 досутпных), нажимает на кнопку "Продолжить".
6. **П** видит экран, предлагающий ввести расценку в инпут для единственного названия работы, для которого нашлись работы, общую по всем исполнителям. Инпут не предзаполнен.
7. **П** вводит расценку по работе и нажимает кнопку "Создать". 
8. Система короткое время показывает заглушку "5сек", после чего возвращает **П** к списку реестров, содержащий 1 реестр, для которого указаны:
    1. Номер реестра;
    2. Дата создания;
    3. Статус "Сформирован".
9. **П** кликает на только что созданный реестр и просматривает его. В реестре столько же строк, сколько было проставлено чекбоксов на Шаге 1. **П** видит ошибку в фамилии исполнителя, а также обнаруживает, что число работ оказалось меньше желаемого (не учтена одна сдельная работа), а еще что у одной работы должна была быть другая расценка (крайне редкое исключение).
10. **П** переходит "Назад к шахматке" и затем переходит в список исполнителей шахматки, где редактирует фамилию исполнителя (сейчас через создание нового исполнителя!), сохраняет. В работах, где этот исполнитель был указан, сейчас поле заменилось на null.
11. **П** в шахматке переходит в левой панели в профиль "Поклейка обоев почасовая". В тех ячейках, где был указан исполнитель с неверной фамилией, теперь можно указать исполнителя с корректной фамилией, что **П** и делает. Каждый раз сохраняет.
12. **П** в шахматке переходит в левой панели в профиль "Поклейка обоев в м2". Далее на 2-ом этаже в одном помещении проставляет исполнителя и объем.
13. Заходит в справочник работ и создает новую работу "Поклейка обоев почасовая Люберцы-102", сохраняет.
14. **П** в шахматке переходит в левой панели в профиль "Поклейка обоев почасовая". В одном из помещений удаляет все заполненные поля, в том числе Исполнитель и Объем.
15. **П** в шахматке переходит в левой панели в профиль "Поклейка обоев почасовая Люберцы-102". Далее на 2-ом этаже в том же помещении, где работал в п.13, в работе ручками проставляет все поля, в том числе исполнителя и объем.
16. **П** возвращается в раздел "Создание реестров". Проставляет старому реестру статус "Удален", после чего реестр скрывается из списка реестров. Нажимает на кнопку "Создать реестр на выплату".
17. Далее повторяются пункты 3-8 с двумя отличиями:
    - 4. Для "Поклейки обоев в м2" нашлась одна новая работа;
    - 4. Для "Поклейка обоев почасовая Люберцы-102" нашлась одна новая работа;
    - 4. Для "Поклейка обоев почасовая" фамилии всех исполнителей теперь написаны корректно и их на одну меньше, чем ранее (4);
    - 5. **П** выбирает все доступные работы (все 6);
    - 6. Инпут для работы "Поклейка обоев почасовая" предзаполнен. Инпут для работы "Поклейки обоев в м2" и "Поклейка обоев почасовая Люберцы-102" не предзаполнены.
18. **П** просматривает только что созданный реестр. В нем все корректно, и он проставляет статус "Оплачено" данному реестру (заранее). Скачивает реестр в xlsx.
19. **П** открывает скачанный xlsx, перепроверяет его. Переносит руками столбцы в 1C. Распечатывает реестр, чтобы убедиться, что данные не потеряются.
20. **П** хочет оценить, скорость и стоимость работы. Для этого он хочет сравнить три цифры:
    1. Как "расчетный период" относится к "количеству дней до дедлайна" - в разрезе конкретной работы.
    2. Как "общая сумма выплат в реестре" соотносится со "суммой в смете" - в разрезе конкретной работы. 
    3. Как "выполненный объем работ" соотносится с "общим объемом работ согласно проектому плану" - в разрезе конкретной работы.
    Чем больше соотношение п.2 к п.1 (или, что то же почти самое, п.3 к п.1), тем лучше идут дела. Можно даже такой хитрый коэффициент ввести.
