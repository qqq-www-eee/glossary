## Наряды и реестры на выплату. Частичное закрытие работ

### Используемые понятия

1. **Наряд** - таблица, отражающая объёмы выполненных работ за определенный период по всем работникам секции. Закрывается технадзором: после приемки работ, приемки отработанных замечаний, если они были, и фиксации всех фактических показателей работ. Выглядит приблизительно [так]() или [так]().
2. **Реестр на выплату** (**реестр**) - документ, формируемый после закрытия наряда руководителем координации. Это финансовая выжимка наряда с указанием сумм к выплате, направляемая в бухгалтерию. Выглядит [так]().
3. **Расчетный период** - период времени, за который составляется наряд и соответствующий реестр на выплату. Как правило, по бизнесу пользователю расчетный период заранее известен и не изменяется (обычно 7 дней). Система между периодами никак не итерируется - даты расчетного периода имеют символическое значение и подбираются автоматически при формировании наряда.
4. **Работа** - проведение определенного наименования работ в определенном помещении. Может длиться один или нескольких расчетных периодов. Работа может быть разбита на "частичные работы". Не путать с наименованием работ, которые приведены в справочнике. Работа однозначно определяется по комбинации **work_id** + **storey** + **room_group** и по сути есть слайс помещения под конкретную работу. 
5. **Частичная работа** - часть работы, длящаяся 1 расчетный период. У частичной работы за время ее жизни по бизнесу исполнитель подразумевается неизменным. Поля "Выдано работ" и "Выполнено" принадлежат именно частичной работе.
5. **Частичное закрытие наряда** (иногда **процентовка**) - процесс сбора и подготовки информации по объекту для взаиморасчета с мастерами за 1 расчетный период (т. е. за 1 частичную работу).  

### Прохладные факты

1. "Таски", "Задачи" - теперь расслоились на две сущности с понятными атрибутами и статусной моделью. Нам недостаточно для описания частичных работ одной только таски, неудобно, почти невозможно. Становятся все более очевидными требования к статусам. В частности, "Ожидает дефектовку" и "Готово к работе" - непонятно чем отличаются. Еще три серых цвета, конечно, вопросы вызывают.
2. **Дефектиовка - это характеристика помещения**. Дефектовка - это история, которую делают в самом начале объекта, когда принимают его; происходит на объекте только один раз, в самом начале самой первой работы. При этом новые замечания технадзоры оставляют каждый расчетный период. Налицо явная нестыковка в статусах, и разговор про оплату (статусов об оплате) еще даже не зашел.  
3. За частичную работу платят в рамках одного отдельно взятого расчетного периода (и наряда). После закрытия этого наряда для вошедших в него частичных работ, **если основная работа еще себя не исчерпала**, пересоздаются новые сущности частичных работ "на остаток" - чтобы уже оплаченные работы больше ни в один наряд не попали. Хотя значение дефектовки можно спокойно редактировать, при пересоздании тасок полагаемся именно на это поле.
4. Работа имеет статусы ~~"Ожидает дефектовку"~~/"Готово к работе"/"В работе"/"Ожидает технадзор"/"Есть замечания"/"Завершено" и др., никаких дефектовок и тем более статусов об оплате! 
5. Еще раз. Кашу из статусов надо распихать по трем сущностям: "помещение", "родительская работа", "частичная работа".
    1. Список:
        1. Ожидает дефектовку
        2. Отдефектовано (может совпадать с "Готово к работе")
        2. Готово к работе.
        3. В работе.
        4. Ожидает технадзор.
        5. Есть замечания.
        6. Завершено.
        7. Готово к оплате (может совпадать с "Завершено")
        8. Оплачено
    2. Распределение:
        1. "Квартире" достается ничего.
        2. Дефектовка - параметр для родительской таски, так как относится к каждому "типу работ + помещение".
            1. Ожидает дефектовку и отдефектовано = готов к работе. 
        3. Частичной работе достается - WIP, ожидает технадзор, есть замечания, завершено (=готово к оплате), оплачено.
    3. Кое-какие возникают ограничения:
        1. Значит, сначала создается шахматка, и в ней вообще нет пока работ. 
        2. Выходим на вкладку обзор - и там у нас пустые серые фасолины (например 5 шт, по числу наименований работ в группе "Вид работ") (~~и подписана с какого-то перепугу первая работа в этой группе? Видимо, идущая чисто по алфавиту, а вовсе не по бизнес-логике! Это важно. Зачем мы показываем рандомную работу? Это баг~~). Если все фасолины статусе "ожидает дефектовку" (пустые серые), то в правой панели должна показывать заглушка про отсутствие работ.
        3. Как только хотя бы одна работа в виде работ получает статус, отличный от "ожидает дефектовку", или еще как-либо изменилось хоть одно из полей работы (?), создается работа + частичная работа. Все объемы и выдано идут в частную работу, а значения по дефектовке должны относиться к родительской работе.
        4. ~~Число фасолин вычисляет почему-то на основе работ, уже представленных в шахматке. То есть если в виде работ у нас 6 наименований работ, то 6 будут только если заполнены все 6 из них хоть где-то. Наверное, это тоже баг.~~
6. У работ в группе "Вид работ" нет на самом деле бизнес-сортировки!
5. Ключевой момент - разнести "статус рабочего процесса" и "статус оплаты", потому что они попросту независимы. Вторая сущности нужна для нарядов внутри, первая - для вкладки "Обзор".
6. Считаем, что дата создания наряда совпадает с датой окончания расчетного периода.
9. Наряд - неизменяемая штука (ни пользователем, ни системой). ~~В ней, возможно, можно будет редактировать коммент-название и статус, но не факт, что они появятся.~~ 
10. Смежным лейтмотивом идет вложенность/невложенность project, storey, room_goup. Таски должны убиваться и создаваться на остаток при частичном закрытии наряда. А вот Работа должна жить до тех пор, пока живут три сущности:
    1. ее этаж
    2. ее рум_груп
    3. ее наименование работ.
    Зачем это? Это позволит делать более УДОБНЫЙ селект для сбора "всех частичные работам, относимых к данному наименованию работ в данном помещении" - по айдишнику, а не по совокупности общих характеристик (по идее этаж + room_group + наименование работы нам тоже подходит, но айдишнику проще вроде бы?). И главное - статусы мы хотим прикрепить к РАБОТЕ, а не к ТАСКЕ. Почему - потому что "Вид работ" будет становиться зеленым, когда закончен целый срез работ. Поэтому Зелеными фасолины становятся только в самом конце. Но как же тогда понять, что частичная работа готова к оплате? 
11. Частичная работа  готова к оплате, когда? Да всегда. Сформировали наряд, и в него попадают все текущие частичные работы, статус ОСНОВНОЙ работы у которых завершено? нет. Нафиг этот вообще статус нужен? Пусть прилетают все работы, у которых есть остаток? Но у них у всех есть остаток... Им просто всем нужен статус WIP-ready-paid.
12. Как будет обнуляться статус после закрытия наряда? Сразу в WIP! А у Работы будет продлжать быть статус тоже "В работе".
13. Как система понимает, пересоздавать частичную работу или нет? Если полностью выполнена вся дефектовка? Может, у нее перерасход уже случился? Вот когда работа в статусе "Готово", мы больше частичные работы не пересоздаем. Вот зачем нужен этот статус.
14. Фасолина будет зеленой, когда все частичные работы в составе фасолины либо оплачены, либо готовы к оплате. То есть как минимум "ready".
15. Когда все фасолины зеленые, красится зеленым клетка "Вида работ".
15. Может ли быть запланированный перерасход? Смотря что такое перерасход, если нормируемся на дефектовку - то да. Если на план, то, наверное, это скорее ошибка - зачесть работы и не учесть, куда взяты материалы. 
16. Еще один поинт в пользу того, что нужны частичные оплаты - это подозрение, что мы можем хотеть в будущем иметь в одном помещении несколько тасок на одну и ту же работу - под разными исполнителями. Мы бы хотели в целом на этом стуле усидеть. Это связано с тем, что могут быть ночные смены или даже 3 смены в сутки - для экстренных кейсов. Это может быть решено через создание дополнительных этажей или дополнительных проектов (как бы дублей), но в целом мы не против принципиально иметь возможность нескольких тасок в одной работе одновременно. Пока что в помещении больше одной работы для данного наименования работ быть не может, но мы думаем. Мы можем.
17. А как вычислять, кого из частичных работ мы в наряд кладем? А по статусу ready. А новую частичную работ на остаток создаем? - смотрим по по дефектовке.
18. Как создается работа - только тогда, когда пользователь тыкнул в шахматке в конкретное помещение, потом ввел какие-нибудь данные, а потом сохранил. Сейчас обязательно нужно изменение дефолтных полей! Можно использовать "готово к работе" как эвфемизм для отсутствующей таски. Это ненастоящий статус!
19. В наряды кладутся частичные работы. Больше одного раза пользователь частичную работу в наряды положить не может. Общая работа при этом может относиться к нескольким нарядам. Мы теперь даже можем собирать все наряды, которые относятся к одной и той же работе с какой-нибудь целью.
20. Пользователю необходимо давать возможность выбрать конечную дату закрытия наряда. Мы никак без этого обойтись не можем.
21. Дата начала расчетного периода определяется автоматически по дате закрытия последнего из предыдущих нарядов по этой же родительской-работе! 
    1. Если удаляем наряд, то удаляем все наряды, дата закрытия которых позже этого. Это просто решение для кучи головоной боли, например, чтобы не вводить "элементарную работу" - работу за один день, а то, может, и за час.
    2. Если дать пользователю выбирать обе даты, он может наотмечать там какие угодно дни и сколь угодно "дыряво". Это сложно учесть грамотно, а еще сложно объяснить пользователю, как оно работает. И там как раз элементарные работы возмникают.
    3. Можно дать пользователю возможнось итерироваться по расчетным периодам, в качестве альтернативы, но тогда надо еще где-то настройку расчетных периодов прикрутить? Сильно ограничивает пользователя. 
    4. По умолчанию предзаполнение должно быть с последнего наряда по сегодня или с последнего наряда + неделя?
22. В один момент времени в одной работе (родительской работе) может быть быть только одна частичная работа (таска). 
23. Частичные оплаты очень сильно связаны с функционалом версионирования шахматки. Нам нужна будет настройка - как часто сохраняем состояние шахматки? По умолчанию каждый день. Или просто по нажатию кнопки "Зафиксирвоать текущую версию". Либо и ручное, и автосохранение работают вместе... Только ручное насчегда а автоматическое, например, 2 месяца. Тогда можно будет закрывать наряд на разницу между последним закрытым нарядом и любым из сохраненных состояний шахматки.
24. Пока что можно закрыть наряд на разницу между прошлым нарядом и 
25. Важный момент - расценки указываются индивидуально для каждого мастера.
3. Строительные работы бывают сдельными (подавляющее большинство) и почасовыми (представлены мелкими доработками). К почасовым прибегают не на каждом объекте. Технически работа сдельщиков и часовщиков реализуется одинаково, отличие в единицах измерения - у сдельных работ это всегда час. Разделять сдельные и почасовые работы при закрытии нарядов можно через выставление фильтра по единицам измерения - в частности, делать два отдельных наряда.

### Предложения по БД:
1. Различать живую частичную работу от строки в наряде. Потому что первые, например, удаляются вместе с родительской работой, они отображают обновления в пользователях, в исполнителях, в объемах и т. д. А вторые - никогда и никак уже не изменяются. Могут быть только полностью ретированы через удаление наряда полностью. Ни наряд, ни нарядная дочерняя работа не редактируемы. Родительская работа и простая дочерняя работа - меняются.
3. Частичная работа должна иметь свой id, ссылаться на id родительской работы, содержать объем~~/расценки/всего_денег~~ на момент создания наряда и флаг "is_paid". Чуть ли не 4 полей должно хватить.



###  Action points:
1. Добавить единицу измерения "час" и список почасовых работ.
2. В таблицу с пользователями:
    1. добавить должность пользователя
    2. заменить три поля под ФИО на одно поле "full_name"

### Базовые функциональные требования

1. НАРЯД - у него тоже есть специфические поля:
    1. Нужны поля:
        1. Номер наряда
        2. Дата-время создания
        3. id создателя
        4. project_id
        5. Окончание расчетного периода (часто будет совпадать с полем "дата-время создания")
    2. Кажется, эти поля не нужны:
        1. Начало расчетного периода (оно всегда совпадает с окончанием расчетного периода предыдущей дочерней-таски! Поэтому будем брать оттуда джоином вместо того, чтобы следить, что в обоих полях консистентно лежит одно и то же)
        3. ФИО автора
        4. Должность автора
        5. Статус (сформирован, оплачен, удален)
        6. Название наряда
    3. Какие поля будут отображаться в списке нарядов:
        1. Номер
        2. Дата создания
        3. Дата создания предыдущего наряда по этой работе
        4. Автор (ФИО + Должность)
2. ЧАСТИЧНАЯ РАБОТА В ШАХМАТКЕ (то есть дочерняя таска~~, и оно же то, что в наряде у нас составляет одну строку - только статуса об оплате пока нема~~):
    1. Частичная работа не может же быть отрицательной! Поэтому чтобы не было казусов, пусть в полях отражается то что в текущем расчетном периоде будет учтено, если вдруг прям сейчас наряд закрыть. То есть мы про боковую панель говорим.
    2. ВАЖНО ОТЛИЧАТЬ ЧАСТИЧНУЮ РАБОТУ ОТ ЧАСТИЧНОЙ РАБОТЫ, ЗАФИКСИРОВАННОЙ В НАРЯДЕ. Первая должна держать id исполнителя и разные поля, такие как объем выполненных работ (а вот id работы, этажа и рум-группы все равно не поменяются), а вторая должна фиксануть чисто значения полей на момент подачи наряда. К сожалению, нужен дубль. Почему их нельзя объединять? Потому что что work_name и select-join name по work_id будут разными! Ну и что? Работу вообще нельзя пока менять. Зато можно удалять! И из нарядов оно пропадать не должно! Хотя бы поэтому.
    3. Нужны поля:
        1. id Исполнителя
        2. id РОДИТЕЛЬСКОЙ-ТАСКИ (а в ней же будут ссылки и на работу как в шахматке/ведомостях, и как в 1С заказчика, если надо, и единицы измерения, и дефектовка, и подтаскивание всех предыдущих частичных работ для высчитывания того, что готово)
        3. ~~Расценка - просто не нужна~~
        3. Объемы - которые он сделал
        4. is_Paid - была ли уже эта дочерняя-таска оплачена? Если true, то она старая. Если false, то это последняя актальная работка
            1. Надо отметить, что если наряд отпавляется в коризину, то присовокупленные таски должны:
                2. Либо нафиг удалиться, если нам неважно, кто и чего раньше делал.
                3. либо потерять статус is_Paid, если нам захочется потом как-то восстановить историю.
3. ЧАСТИЧНАЯ РАБОТА В НАРЯДЕ (~~то есть дочерняя таска, и оно же то, что~~ в наряде у нас составляет одну строку - только статуса об оплате пока нема):
    1. Сейчас в наряд попадут работы, у которых:
            1. в дочерней-задаче указан Исполнитель,
            2. в дочерней-задаче указан выполненный объём
            3. дочерняя-задача не попала в сформированные ранее наряды.
            4. Родительская-таска имеет рабочий статус «Завершено»???????? НЕТ! Скорее всего, статус должен быть "В работе". Потому что замечания оставляются раз в работа, а не каждую неделю. Ожидает дефектовку и проходит дефектовку работа тоже только один раз в работу, а не в частичную работу!
            14. id наряда, в которых он попал. Надо подумать. Попадание в наряд - хороший критерий оплаченности! Но и наличие закостенелого брата тоже хороший критерий оплаченности!
    1. Нужны поля:
        1. Исполнитель / Сотрудник - на момент формирования наряда
        2. Вид работ / Вид работ по ведомости - на момент формирования наряда (эти господа, вероятно, не меняются)
        3. Вид работ по 1С - потом потребуется - на момент формирования наряда (эти господа, вероятно, не меняются)
        4. Единица измерения - Выносятся отдельно ради сортировки и фильтрации - на момент формирования наряда (эти господа, вероятно, не меняются)
        5. Тип помещения (помещение) - на момент формирования наряда (эти господа, вероятно, не меняются)
        6. Этаж  - на момент формирования наряда (эти господа, вероятно, не меняются)
        7. Объем выполненных работ - на момент формирования наряда
        8. ВСЕГО - дефектовка  - на момент формирования наряда
        9. (Процентовка - высчитывается!)
        10. (Остаток - высчитывается!)
        11. Расценка - на момент формирования наряда
        12. (К выплате - высчитывается!)
        13. Свой собственный id
        14. id наряда, в которых он попал. Надо подумать. Попадание в наряд - хороший критерий оплаченности.
    2. Отметим, что все те поля, которые вероятно не меняются вообще завязаны на родительскую таску. Часть из них вообще справочники.
4. РАБОТА (РОДИТЕЛЬСКАЯ ТАСКА)
        1. id родительской таски - то есть свой id
        2. Помещение - строка, например "Квартира" / "МОП" / "ЛК" / "ЛХ" / "Вестибюль". Но, кстати, у нас оно указано отдельно и как имя, и как тип помещения
        3. Этаж
        4. Всего - дефектовка
        5. Имя работы как в ведомостях
        6. Имя работы как в 1С
        7. ~~project_id? - нет, нам достаточно этажа и помещения, которые привязаны каждый к project_id.~~
4. В нарядах должны быть сортировка и фильтрация. Пусть все будут по алфавиту, чтобы не париться. 
5. Процесс частичной оплаты работ!!!!!
6. Статусная модель по частичным работам.
7. Требования просто просмотреть и перелопатить.
8. Важный момент - расценки указываются индивидуально для каждого мастера
    

### Картинки

Как выглядит Наряд

Как выглядит Реестр на выплату


### Backlog

1. Добавить возможность редактировать "Название наряда" или прилепить ему поле "Комментарий".
2. Темы с импортом, с экспортом, со скачиванием xlsx и pdf. Печатные формы вообще работа с документами.

1. Мы все равно будем делать версионирование. Версия - слепок шахматки на момент времени. Закрываемый наряд (в том числе касательно частичных оплат) вычисляет разницу между нынешними объемами и теми, что отражены в наряде. Логичнее, и дальше будет понятно почему, сначала вычислять разницу всех значений шахматок (ну пока только объемы годятся), а потом уже обрамлять это типа в оболочку наряда. Очень нужно версионирование, потому что после него наряды, вполне вероятно, перекромсаются.


e2e.
1. Если я у меня есть закрытие расчетные периоды 1,2,3,4, и я только что закрыла период 5. При этом, если я удалю один из предыдущих нарядов, например, 2, то просто предупреждаем, что наряды, закрытые на базе этой 2-4и (а именно, 3, 4) все они короче в троем отправятся в удаленные (останутся доступны для просмотра). Они будут доступны для просмотра, но больше никогда не будут участвовать в расчетах. И следующий за 1-ым нарядом сразу будет 6, его можно будет закрыть сразу за периоды 2-5, или по отдельности, как удобно. Чтобы корректно посчтитать разницу в объемах сделанных работ, нужно хранить слепок всех дочерних-тасок и сложным образом их обрабатывать. Мы этого хотим? Нет. ПОэтому единственной возможностью будет закрыть наряд на разность между текущим состоянием шахматки и теми объемами, что были в наряде.


### Функциональные требования

1. фыва
2. ыва
