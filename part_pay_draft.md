## Наряды и реестры на выплату. Частичное закрытие работ

### Используемые понятия

| Термин                        | Значение, синонимичные понятия | БД |
| ----------------------------- | ------------------------------ |-|
| **Реестр на выплату**         | Сводная таблица с результатами работы мастеров за некоторое характерное время с указанием объемов и расценок. Обычно в **нарядах** указывают объемы за каждую работу, а в **реестрах на выплату** - итоговую сводную сумму для каждого исполнителя. Однако у наc реализовано единое представление: и с объемами работ, и с расценками/выплатами. Называть таблицу условимся **реестрами на выплату**. Формирование реестра - то же самое, что закрытие наряда. | **payment_report** |
| **Расчетный период**          | Диапазон времени, определяющий работы, которые будут учтены при составлении реестра. | - |
| **Название работы**                    | Название работы. | **work** |
| **Работа**           | Процесс выполнения некоторой работы в некотором помещении. | **task** |
| **Запись о работе** | Определенный объем работы, попавший в реестр; одна строка в таблице реестра. | **payment_report_task** |
| **Формирование реестра** | Правильное название для **Закрытия наряда**). Процесс формирования реестра на выплату. Фактически, все наряды частичные. Процентовка - тот же процесс, но отображение объемов работ нормировано на общий объем работ (поле дефектовка) | - |


### Предложения по БД

1. Использовать существующие таблицы: **task**, **payment_report**, **payment_report_task**

###  Ключевые тезисы

1. Все дополнительные требования (относительно простого закрытия нарядов) к частичному закрытию нарядов (частичной оплате) теперь минимальны, потому что:
    1. Работы нельзя "закрыть", проставив им дату оплаты или иную отметку об оплате.
    2. Каждая работа попадает в наряды сколь угодно много раз.
    2. таски на остаток не создаются;
    2. суммарное число тасок проекта (в стандартном случае) постепенно становится равно **числу_этажей * число_комант * число_названий_работ** и больше не растет;
    3. 
2. . Удаляются только 
2. Наряды теперь сильно походят на отчеты.
2. Критерии попадания работы в наряд упрощаются с:
    1. Статус "Завершено";
    2. Указаны "Исполнители";
    3. Указаны "Объемы";
    4. Отсутствует отметка об оплате.  
    до
    1. Указаны "Исполнители";
    2. Указаны "Объемы".
2. При закрытии наряда новые записи о работах "на остаток" не создается.
3. Наряд невозможно отредактировать.
4. Наряд невозможно удалить (на текущий момент).
5. Спектр отображаемых данных в наряде необходимо расширить (в процессе обсуждения):
    1. Уже есть:
        1. Название работы
        2. Этаж
        3. Помещение
        4. Исполнитель
        5. Объем
        6. К выплате
    2. Обсуждается
        1. Остаток
        2. Всего
        1. Процентовка
        2. Расценки
6. Статусы нарядов пока не задействуются.
7. Фича может быть зааффекчена фичей "Версионирование шахматки"
8. Фича может быть зааффекчена фичей "Лимиты".
9. 
    
В-третьих "лимиты" очень близкая, еще не реализованная задача. Частичные оплаты имеет высокие шансы плавно перерасти в требования к лимитам. Даже если не перерастут, просто мое внимание туда почему-то приковывается) 

###  Требования

1. При первом входе в раздел "Закрытие нарядов" пользователь видит заглушку с кнопкой "Создать реестр"(?).
2. В разделе "Закрытие нарядов" система предоставляет пользователю возможность создать новый реестр.
3. В разделе "Закрытие нарядов" система предоставляет пользователю возможность вернуться в шахматку без создания реестра.
4. При нажатии на кнопку "Создать реестр на выплату" 
5. Фильтрация  
    1. Есть кнопка сброса всех фильтров
    2. Есть кнопки сброса каждого фильтра в отдельности
    3. Есть фильтры:
        1. По этажам и помещениям
        3. По исполнителям
        4. По названию работы
        4. ~~По статусу работы~~
6. ~~Статус работы выводится как светофор около каждой работы.~~
7. ~~Статус наряда выводится как поле в списке реестров.~~
7. Система предоставляет пользователю возможность сортировать наряды по номеру и по дате создания.
8. фыва
9. фыва
10. фыва


### Backlog

1. Импорт, экспорт в xlsx и pdf. Печатные формы, работа с документами, системный подход к печати всех доков в продукте.
2. Сортировка работ в "Видах работ" по пользовательскому упорядочению (фактически, по очередности работ).

### E2E

Пользователь (П) - технадзор.

1. **П** заходит в чужую шахматку, где он "Редактор".
2. **П** переходит в раздел "Закрытие нарядов". **П** видит все созданные ранее наряды и кнопку "Создать наряд". Если нарядов пока не было, видит заглушку, где дублируется предложение "Создать наряд". 
3. **П** запускает процесс создания (оно же закрытие) нового наряда. Видит таблицу со списком всех работ, которые есть в шахматке в данное время, у которых указаны исполнители и указаны объемы.
4. **П** выставляет фильтр по названию работы "Поклейка обоев почасовая" ("Поклейка обоев в м2" и "Поклейка обоев почасовая" - это разные работы), фильтр по месту проведения (выбрал этаж, помещения). ~~Выставялет фильтр работ "Готово"~~. Видит список работ, у которых: всевозможные названия и всевозможные исполнители.
5. **П** выбирает чекбоксами интересующие его работы, нажимает на кнопку "Продолжить". Видит экран указания расценок работ.
6. **П** вводит (если в первый раз) или обновляет расценки по работам. 
7. Система создает наряд и возвращает **П** к списку нарядов.
8. Пользователь находит только что созданный 
 



Не нашел нужную ему работу, идет в шахматку и проставляет в ней правильный статус. Возвращается и проходит все шаги 2 - 10 заново. Теперь он видит свою потерявшуюся работу.

Перечень всех полей:
1. Название работы
2. Этаж
3. Помещение
4. Исполнитель
5. Объем
6. Всего (дефектовка)
7. Процентовка (вычисляемое значение: объем / дефектовку)
8. Остаток
9. Расценка
10. К выплате