## Реестры на выплату. Частичное закрытие работ

| Термин                        | Значение, синонимы | Таблица в БД |
| ----------------------------- | ------------------------------ |------------- |
| **Реестр на выплату**, **реестр** | Сводная таблица с результатами работы мастеров за характерное время с указанием объемов и расценок. <br>Обычно объемы отдельных работ указывают при закрытии **наряда**, а итоговую сумму для исполнителей по всем работам - в **реестрах на выплату**. У наc реализовано единое представление с объемами и выплатами, поэтому понятия "формирование реестра" и "закрытие наряда" синонимичны (корректное - формирование реестра). | **payment_report** |
| **Расчетный период**          | Диапазон времени, определяющий работы, учитываемые при составлении реестра. | - |
| **Название работы**                    | Название строительной работы. | **work** |
| **Работа**           | Процесс выполнения некоторой строительной работы в некотором помещении, а также сущность системы для обозначения этого процесса. | **task** |
| **Запись о работе**   | Объем работы, попавший в реестр; одна строка в таблице реестра на выплату. | **payment_report_task** |
| **Запись об оплате**  | Объем работы, попавший в реестр в статусе "Оплачено"; одна строка в таблице реестра на выплату со статусом "Оплачено". | **payment_report_task** |


### Предложения по БД

1. Использовать существующие таблицы: **task**, **payment_report**, **payment_report_task**

###  Бизнес-требования

1. Пользователь должен иметь возможность в своей шахматке создавать и просматривать реестры для того, чтобы своевременно производить оплату труда на площадке.
2. Пользователь должен иметь возможность давать другим пользователям доступ к функционалу просмотра и/или создания/редактирования реестров.
3. Пользователи системы должны иметь возможность просматривать реестры хотя бы годичной давности для решения проблем, возникающих спустя значительное время после проведенной работы.
4. Система должна предоставлять пользователю возможность быстро найти необходимый реестр в списке реестров.
5. Пользователь должен иметь возможность жестко ограничить круг лиц, имеющих доступ к просмотру и созданию реестров, поскольку это чувствительная информация.
6. Пользователи, имеющие право на просмотр и/или редактирование реестров, должны иметь возможность просматривать и редактировать шахматку.
7. ~~Обратное неверно. Пользователь (владелец) должен иметь возможность ограничить право просмотра и/или редактирования реестров для других пользователей, при этом оставляя им право на просмотр и/или редактирование шахматки.~~  
8. ~~Пользователь должен иметь возможность дать право на просмотр и/или редактирование реестров отдельно от права на создание/редактирование замечаний.~~
9. Система запрещает пользователям (в том числе создателю реестра и владельцу шахматки), редактировать уже существующие реестры во избежание искажения или потери информации в нарядах (реестр - слепок данных шахматки на определенный момент).
10. Система не дает пользователю возможности безвозвратно удалять реестры, чтобы избежать случайной потери ценной информации.
11. Пользователи системы должны иметь возможность хранить и просматривать любые созданные реестры (даже если в них лежат неполные, некорректные, противоречащие друг другу или дублирующиеся данные) с целью гибкого использования функционала реестров.
12. Система позволяет пользователю вручную назначать реестрам статус "**Удален**", по которому пользователи смогут идентифицировать, что данный реестр более не предполагает дальнейшей работы.
13. Пользователь должен иметь возможность вручную проставить реестрам статус "**Оплачен**", благодаря чему они начнут (учитываться в системе как оплаченные) отобразаться в функциях, связанных с подсчетом расхождений факта с проектом (фича "Лимиты").
14. При создании нового реестра система присваивает ему нейтральный статус "**Сформирован**".
15. Пользователь должен иметь возможность вручную проставить реестрам нейтральный статус "**Сформирован**".
16. При формировании реестра на выплату система должна в табличном виде отображать пользователю следующую информацию:
    1. "Название работ";
    2. "Исполнитель";
    3. "Этаж";
    4. "Помещение";
    5. "Объем выполненных работ";
    6. "Расценка";
    7. "К выплате";
    8. "Накопительный итог".
17. ~~Функционал закрытия реестров будет необходим в мобильном приложении как только будет реализована интеграция с 1C. Он будет работать только если устройство онлайн.~~ Сейчас в мобильных устройствах функционал наряд не реализуется.
18. Система должна отображать в боковой панели рядом с информацией об объемах работ ("Всего"/"Дефектовка", "Выдано", "Выполнено", "Отстаток" (пока нет) или других) информацию обо всех **записях об оплате**, связанных с данной **работой**.

###  Ключевые тезисы для общего понимания

1. "Частичных оплат" более нет (частичные оплаты и полные оплаты не различимы):
    1. Каждая работа попадает в реестры сколь угодно много раз;
    2. Работы нельзя "закрыть" какой-либо оплатой - работа может получить сколь угодно много **записей об оплате**, попав в несколько разных нарядов;
    3. При формировании реестра новые записи о работах "на остаток" не создаются;
    4. Общее число работ в проекте в стандартном случае постепенно становится равно **числу_этажей * число_комнат * число_названий_работ** - и далее больше не растет.
2. Реестры на оплату сближаются по функциональности с отчетами. Однако отчеты и реестры отображают разные поля и в разном порядке - несмотря на схожесть структуры, предназначение у них разное: у отчетов - финансовое и операционное планирование, у нарядов - корректный подсчет текущих расходов на выплаты.
3. Критерии попадания работы в реестр упрощаются с:
    1. Статус "Завершено";
    2. Указаны "Исполнители";
    3. Указаны "Объемы";
    4. Отсутствует отметка об оплате.  
    до
    1. Указаны "Исполнители";
    2. Указаны "Объемы".
4. Реестр невозможно отредактировать.
5. Реестр на текущий момент невозможно жестко удалить, но можно скрыть (отправив в корзинку, поставив фильтр или как-то иначе).
6. Реестры могут иметь статусы "Сформирован", "Оплачен", "Удален":
    1. "Сформирован" - нейтральный статус, реестр отображается в списке реестров, выдается по умолчанию при создании реестра;
    2. "Оплачен" - реестр должен учитываться системой при работе с лимитами (должен отображаться в боковой панели шахматки);
    2. "Удален" - реестр непригоден или не интересен для дальнейшей работы; не отображается в списке реестров; однако может быть просмотрен пользователем где-то еще и возвращен к статусу "Сформирован" или "Оплачен";
7. Статус реестра возможно менять вручную.
8. Спектр отображаемых данных в реестре:
    1. Название работы
    2. Этаж
    3. Помещение
    4. Исполнитель
    5. Объем
    6. Расценка
    7. К выплате
    8. Накопительный итог
    9. ~~Остаток~~
    10. ~~Всего~~
    11. ~~Процентовка~~
    12. ~~Расценка~~
9. ~~Добавится фильтр по статусу работ ("Готово", "В работе", др.).~~
10. Данная фича может быть зааффекчена фичей "Версионирование шахматки"
11. Данная фича может быть зааффекчена фичей "Лимиты".

### Функциональные требования

1. Должен быть поиск по списку реестров, помогающий пользователю идентифицировать нужный реестр за определенный расчетный период (все такие реестры.)
1. При первом входе в раздел "Закрытие реестров" пользователь видит заглушку с кнопкой "Создать реестр"(?).
2. В разделе "Закрытие реестров" система предоставляет пользователю возможность создать новый реестр.
2. В разделе "Закрытие реестров" есть сортировка
    1. По статусу;
    2. По дате создания;
    3. По номеру.
2. В разделе "Закрытие реестров" есть фильтрация??
    1. По статусу;
    2. По дате создания;
    3. По номеру.
3. В разделе "Закрытие реестров" система предоставляет пользователю возможность вернуться в шахматку без создания реестра.
4. При нажатии на кнопку "Создать реестр на выплату" 
5. Фильтрация  
    1. Есть кнопка сброса всех фильтров
    2. Есть кнопки сброса каждого фильтра в отдельности
    3. Есть фильтры:
        1. По этажам и помещениям
        3. По исполнителям
        4. По названию работы
        4. ~~По статусу работы~~
6. ~~Статус работы выводится как светофор около каждой работы.~~
7. ~~Статус реестра выводится как поле в списке реестров.~~
8. Система предоставляет пользователю возможность сортировать реестры по номеру и по дате создания.
8. Кнопка для перехода в раздел "Закрытие реестров" недоступна, пока в шахматке не настроено хотя бы один справочник из списка:
    1. сам объект;
    2. список работ на объекте; 
    3. список исполнителей;
    4. список технадзоров.
9. Если на шаге 1 не выбрана ни одна работа, то по нажатии на кнопку "Продолжить" пользователь останется на экране и получит нотификацию с предложением выбрать хотя бы одрну работу. 
9. Система отображает 20 реестров на странице.
10. Если оставлено пустым на шаге 2, то пользователь видит либо
    1. НЕ красный инпут! ~~с предложением "Обязаетельно для заполнения"! Красным инпутом мы подсвечиваем некорректный формат вводимых в поле данных. Тем более если у нас 10 работ, на них всех напишется одно и то же, с нотификацией - экономичнее для красного цвета.~~
    2. Уведомление с текстом "Заполните все расценки" и, возможно, желтым треугольником, раз уж у нас такая ошибка на первом шаге.
10. фыва

### Нефункциональные требования

1. Быстродействие
2. Безопасность
3. фыва


### Backlog

1. Импорт, экспорт реестров в xlsx и pdf. Печатные формы, работа с документами. Системный подход к печати всех доков в продукте.
2. Сортировка работ в "Видах работ" по пользовательскому упорядочению.

### Пример E2E для web-версии

1. **Пользователь** (**П**) заходит в чужую шахматку, где обладает правами "Редактор". Шахматка полностью настроена, в нее внесен ряд актуальных работ. реестров для данной шахматки еще не создавалось.
2. **П** переходит в раздел "Закрытие реестров", где будут видит все созданные ранее реестры и кнопку "Создать реестр". Так как реестры еще не создавались, **П** видит заглушку, где дублируется предложение "Создать реестр на выплату". Нажимает на любую из кнопок "Создать реестр на выплату".
3. Запускается процесс создания нового реестра на выплату, в результате чего **П** видит таблицу со списком всех работ, которые есть в шахматке в данное время, у которых:
    1. указаны исполнители;
    2. указаны объемы.
4. **П** выставляет фильтр по названию работы (напр., "Поклейка обоев почасовая" И "Поклейка обоев в м2"), фильтр по месту проведения (напр., "этаж 2, все помещения"); видит список работ, у которых  приведены все исполнители для названия работы "Поклейка обоев почасовая". Для "Поклейка обоев в м2" подходящих работ не нашлось.
5. **П** выбирает с помощью чекбоксов интересующие его работы, нажимает на кнопку "Продолжить".
6. **П** видит экран, предлагающий ввести расценки для выбранной работы (1 поле, по числу различных видов работ, выбранных после фильтрации). Инпут единственной расценки, с которой **П** теперь работает ("Поклейка обоев почасовая"), не предзаполнен.
7. **П** вводит расценки по работам и нажимает кнопку "Создать". 
8. Короткое время видит заглушку "5сек", после чего видит только что созданный реестр и возвращает **П** к списку реестров, содержащий 1 реестр, содержащий:
    1. Номер реестра;
    2. Дату создания;
    3. Статус "Сформирован".
9. **П** находит только что созданный реестре, кликает его и просматривает. В реестре столько же строк, сколько было проставлено чекбоксов на шаге заполнения 1. **П** находит ошибку в фамилии исполнителя и также обнаруживает, что число работ оказалось меньше реального.
10. Переходит в список исполнителей шахматки, редактирует фамилию исполнителя (сейчас через создание нового исполнителя), сохраняет.
11. Находит на шахматке в категории "Поклейка обоев в м2" потерявшуюся работу, проставляет ей объем и исполнителя.
12. **П** возвращается в раздел "Создание реестров" (не сможет сделать ничего со старым реестром). Нажимает на кнопку "Создать реестр на выплату".
11. Далее повторяются пункты 3-8 с двумя отличиями:
    1. 4. Для "Поклейки обоев в м2" нашлась одна работа.
    2. 6. Инпут для работы "Поклейка обоев почасовая" предзаполнен. Инпут для работы "Поклейки обоев в м2" не предзаполнен.
12. **П** просматривает только что созданный реестр. В нем все корректно, и он проставляет статус "Оплачено" данному реестру (заранее). Скачивает реестр в xlsx.
13. **П** переходит в первый реестр и проставляет данному реестру статус "Удален".
13. **П** открывает скачанный xlsx корректного реестр, распечатывает его и отправляет на оплату.
