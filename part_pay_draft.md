## Наряды и реестры на выплату. Частичное закрытие работ

| Термин                        | Значение, синонимы | Таблица в БД |
| ----------------------------- | ------------------------------ |------------- |
| **Реестр на выплату**         | Сводная таблица с результатами работы мастеров за характерное время с указанием объемов и расценок. <br>~~Объемы отдельных работ обычно указывают при закрытии **нарядов**, а итоговую сводную сумму по работам для каждого исполнителя - в **реестрах на выплату**. У наc реализовано единое представление с объемами работ и с выплатами, поэтому понятия "формирование реестра" и "закрытие наряда" синонимичны. Корректное - формирование реестра.~~ | **payment_report** |
| **Расчетный период**          | Диапазон времени, определяющий работы, учитываемые при составлении реестра. | - |
| **Название работы**                    | Название строительной работы. | **work** |
| **Работе**           | Процесс выполнения некоторых работ в некотором помещении; также сущность системы для обозначения этого процесса. | **task** |
| **Запись о работе**   | Объем работы, попавший в реестр; одна строка в таблице реестра на выплату. | **payment_report_task** |
| **Запись об оплате**  | Объем работы, попавший в реестр в статусе "Оплачено"; одна строка в таблице реестра на выплату со статусом "Оплачено". | **payment_report_task** |


### Предложения по БД

1. Использовать существующие таблицы: **task**, **payment_report**, **payment_report_task**

###  Бизнес-требования

1. Пользователь должен иметь возможность в своей шахматке создавать и просматривать наряды для того, чтобы своевременно производить оплату труда на площадке.
2. Пользователь должен иметь возможность давать другим пользователям доступ к функционалу просмотра нарядов и доступ к функционалу создания/редактирования нарядов.
3. Пользователи системы должны иметь возможность просматривать наряды хотя бы годичной давности для решения проблем, возникающих после проведенной работы значительное время спустя.
4. Система должна предоставлять пользователю возможность быстро найти необходимый наряд в списке нарядов.
5. Пользователь должен иметь возможность жестко ограничить круг лиц, имеющих доступ к просмотру и созданию нарядов, поскольку это чувствительная информация.
6. Пользователи, имеющие право на просмотр нарядов и право на редактирование нарядов, должны иметь возможность просматривать и редактировать шахматку.
7. ~~Обратное неверно. Пользователь должен иметь возможность ограничить просмотр и/или редактирование нарядов для других пользователей, при этом предоставляя право на просмотр и/или редактирование шахматки.~~  
8. ~~Пользователь должен иметь возможность дать право на просмотр и/или редактирование нарядов отдельно от права на создания/редактирования замечаний.~~
9. Система ограничивает для всех пользователей возможность редактирования нарядов, в том числе для создателя и для владельца шахматки, во избежание искажения или потери информации (наряд - слепок данных шахматки на определенный момент).
10. Пользователь не может жестко удалять наряды для того, чтобы избежать случайной потери ценной информации.
11. Пользователи системы должны иметь возможность хранить и просматривать наряды, даже если в них лежат неполные данные или некорректные данные с целью гибкого использования нарядов.
12. Система позволяет пользователю вручную назначать нарядам статус "удален", по которому пользователи смогут понять, что данный наряд более не предполагает дальнейшей работы с ним.
13. Пользователь должен иметь возможность вручную проставить нарядам статус, по которому они смогут учитываться в системе как оплаченные для того, чтобы полноценно задействовать функционал системы, связанный с подсчетом расхождений факта с проектом.
14. При формировании реестра на выплату система должна отображать пользователю таблицу, содержащую "Наименование работ", "Исполнителя", "Расценку", "К выплате", а также "Накопительный итог".
14. Функционал закрытия нарядов необходим в мобильном приложении. Работает только если устройство онлайн.

###  Ключевые тезисы

1. Частичные оплаты и полные оплаты не различимы:
    1. Каждая работа попадает в наряды сколь угодно много раз;
    2. Работам нельзя проставить дату оплаты или как-то иначе организовать отметку об оплате, "закрыть" их;
    2. При закрытии наряда новые записи о работах "на остаток" не создаются;
    2. Общее число работ в проекте в стандартном случае постепенно становится равно **числу_этажей * число_комант * число_названий_работ** - далее не растет.
2. Реестры на оплату сблизятся по функциональности с отчетами, но они отображают разные поля в разном порядке. Несмотря на схожесть подачи информации, предназначение разное (у отчетов - финансовое и операционное планирование)
3. Критерии попадания работы в наряд упрощаются с:
    1. Статус "Завершено";
    2. Указаны "Исполнители";
    3. Указаны "Объемы";
    4. Отсутствует отметка об оплате.  
    до
    1. Указаны "Исполнители";
    2. Указаны "Объемы".
4. Наряд невозможно отредактировать.
5. Наряд невозможно жестко удалить (на текущий момент).
6. Спектр отображаемых данных в наряде:
        1. Название работы
        2. Этаж
        3. Помещение
        4. Исполнитель
        5. Объем
        6. Расценка
        7. К выплате
    2. ~~Обсуждаются:~~
        1. ~~Остаток~~
        2. ~~Всего~~
        1. ~~Процентовка~~
        2. ~~Расценка~~
6. Реестры создаются в статусе "Сформирован".
7. Предлагается: реестры могут иметь статусы "Сформирован", "Оплачен", "Удален".
8. Данная фича может быть зааффекчена фичей "Версионирование шахматки"
9. Данная фича может быть зааффекчена фичей "Лимиты".
10. ~~Добавится фильтр по статусу работ ("Готово", "В работе", др.).~~

### Функциональные требования

1. Должен быть поиск по списку нарядов, помогающий пользователю идентифицировать нужный наряд за определенный расчетный период (все такие наряды.)
1. При первом входе в раздел "Закрытие нарядов" пользователь видит заглушку с кнопкой "Создать реестр"(?).
2. В разделе "Закрытие нарядов" система предоставляет пользователю возможность создать новый реестр.
2. В разделе "Закрытие нарядов" есть сортировка
    1. По статусу;
    2. По дате создания;
    3. По номеру.
2. В разделе "Закрытие нарядов" есть фильтрация??
    1. По статусу;
    2. По дате создания;
    3. По номеру.
3. В разделе "Закрытие нарядов" система предоставляет пользователю возможность вернуться в шахматку без создания реестра.
4. При нажатии на кнопку "Создать реестр на выплату" 
5. Фильтрация  
    1. Есть кнопка сброса всех фильтров
    2. Есть кнопки сброса каждого фильтра в отдельности
    3. Есть фильтры:
        1. По этажам и помещениям
        3. По исполнителям
        4. По названию работы
        4. ~~По статусу работы~~
6. ~~Статус работы выводится как светофор около каждой работы.~~
7. ~~Статус наряда выводится как поле в списке реестров.~~
8. Система предоставляет пользователю возможность сортировать наряды по номеру и по дате создания.
8. Кнопка для перехода в раздел "Закрытие нарядов" недоступна, пока в шахматке не настроено хотя бы один справочник из списка:
    1. сам объект;
    2. список работ на объекте; 
    3. список исполнителей;
    4. список технадзоров.
9. Если на шаге 1 не выбрана ни одна работа, то по нажатии на кнопку "Продолжить" пользователь останется на экране и получит нотификацию с предложением выбрать хотя бы одрну работу. 
9. Система отображает 20 нарядов на странице.
10. Если оставлено пустым на шаге 2, то пользователь видит либо
    1. НЕ красный инпут! ~~с предложением "Обязаетельно для заполнения"! Красным инпутом мы подсвечиваем некорректный формат вводимых в поле данных. Тем более если у нас 10 работ, на них всех напишется одно и то же, с нотификацией - экономичнее для красного цвета.~~
    2. Уведомление с текстом "Заполните все расценки" и, возможно, желтым треугольником, раз уж у нас такая ошибка на первом шаге.
10. фыва


### Backlog

1. Импорт, экспорт реестров в xlsx и pdf. Печатные формы, работа с документами. Системный подход к печати всех доков в продукте.
2. Сортировка работ в "Видах работ" по пользовательскому упорядочению.

### Пример E2E для web-версии

1. **Пользователь** (**П**) заходит в чужую шахматку, где обладает правами "Редактор". Шахматка полностью настроена, в нее внесен ряд актуальных работ. Нарядов для данной шахматки еще не создавалось.
2. **П** переходит в раздел "Закрытие нарядов", где будут видит все созданные ранее наряды и кнопку "Создать наряд". Так как реестры еще не создавались, **П** видит заглушку, где дублируется предложение "Создать реестр на выплату". Нажимает на любую из кнопок "Создать реестр на выплату".
3. Запускается процесс создания нового реестра на выплату, в результате чего **П** видит таблицу со списком всех работ, которые есть в шахматке в данное время, у которых:
    1. указаны исполнители;
    2. указаны объемы.
4. **П** выставляет фильтр по названию работы (напр., "Поклейка обоев почасовая" И "Поклейка обоев в м2"), фильтр по месту проведения (напр., "этаж 2, все помещения"); видит список работ, у которых  приведены все исполнители для названия работы "Поклейка обоев почасовая". Для "Поклейка обоев в м2" подходящих работ не нашлось.
5. **П** выбирает с помощью чекбоксов интересующие его работы, нажимает на кнопку "Продолжить".
6. **П** видит экран, предлагающий ввести расценки для выбранной работы (1 поле, по числу различных видов работ, выбранных после фильтрации). Инпут единственной расценки, с которой **П** теперь работает ("Поклейка обоев почасовая"), не предзаполнен.
7. **П** вводит расценки по работам и нажимает кнопку "Создать". 
8. Короткое время видит заглушку "5сек", после чего видит только что созданный наряд и возвращает **П** к списку нарядов, содержащий 1 наряд, содержащий:
    1. Номер реестра;
    2. Дату создания;
    3. Статус "Сформирован".
9. **П** находит только что созданный реестре, кликает его и просматривает. В реестре столько же строк, сколько было проставлено чекбоксов на шаге заполнения 1. **П** находит ошибку в фамилии исполнителя и также обнаруживает, что число работ оказалось меньше реального.
10. Переходит в список исполнителей шахматки, редактирует фамилию исполнителя (сейчас через создание нового исполнителя), сохраняет.
11. Находит на шахматке в категории "Поклейка обоев в м2" потерявшуюся работу, проставляет ей объем и исполнителя.
12. **П** возвращается в раздел "Создание нарядов" (не сможет сделать ничего со старым нарядом). Нажимает на кнопку "Создать реестр на выплату".
11. Далее повторяются пункты 3-8 с двумя отличиями:
    1. 4. Для "Поклейки обоев в м2" нашлась одна работа.
    2. 6. Инпут для работы "Поклейка обоев почасовая" предзаполнен. Инпут для работы "Поклейки обоев в м2" не предзаполнен.
12. **П** просматривает только что созданный реестр. В нем все корректно, и он проставляет статус "Оплачено" данному реестру (заранее). Скачивает наряд в xlsx.
13. **П** переходит в первый реестр и проставляет данному реестру статус "Удален".
13. **П** открывает скачанный xlsx корректного наряд, распечатывает его и отправляет на оплату.
