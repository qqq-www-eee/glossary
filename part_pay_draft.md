## Реестры на выплату. Частичное закрытие работ

###  Используемые понятия

Контрол "Реестры на выплату" - это новое название контрола "Закрытие нарядов" в **панели действий**.

| Термин                        | Значение, синонимы | Таблица в БД |
| ----------------------------- | ------------------------------ |------------- |
| **Реестр на выплату**, **реестр** | Сводная таблица с результатами работы мастеров за характерное время с указанием объемов и расценок (обычно объемы работ указывают при закрытии **наряда**, а итоговую сумму для исполнителей - в **реестрах на выплату**. У наc реализовано единое представление с объемами и выплатами, называемое реестром). | **payment_report** |
| **Расчетный период**          | Диапазон времени, за который учитываются работы при составлении реестра. | - |
| **Название работы**                    | Название строительной работы. | **work** |
| **Работа**           | Процесс выполнения некоторой строительной работы в некотором помещении; а также сущность в системе для обозначения этого процесса. | **task** |
| **Запись о работе**   | Объем работы, попавший в реестр (одна строка реестра). | **payment_report_task** |
| **Запись об оплате**  | Объем работы, попавший в реестр в статусе "Оплачено" (одна строка реестра со статусом "Оплачено"). | **payment_report_task** |
| **Расценка**  | Стоимость работы в рублях за единицу измерения работы (час, м2 и т. д.). | **work** |

### Предложения по БД

1. Использовать существующие таблицы: **task**, **payment_report**, **payment_report_task**

###  Бизнес-требования

1. Пользователь должен иметь возможность в своей шахматке создавать и просматривать **реестры на выплату** для того, чтобы своевременно производить оплату труда на площадке.
2. Пользователи системы должны иметь возможность просматривать реестры хотя бы годичной давности для решения проблем, возникающих спустя значительное время после проведенной работы.
3. Система должна предоставлять пользователю возможность быстро найти необходимый реестр в списке реестров.
4. Пользователь должен иметь возможность давать другим пользователям доступ к функционалу просмотра и/или создания/редактирования реестров (т. е., иметь возможность жестко ограничить круг лиц, имеющих доступ к просмотру и созданию реестров), поскольку это чувствительная информация.
5. Пользователи, имеющие право на просмотр и/или редактирование реестров, должны иметь возможность просматривать и редактировать шахматку.
6. ~~Обратное неверно. Пользователь (владелец) может ограничить право просмотра и/или редактирования реестров для других пользователей, но при этом оставить им право на просмотр и/или редактирование шахматки.~~  
7. ~~Пользователь должен иметь возможность давать право на просмотр и/или редактирование реестров отдельно от права на создание/редактирование замечаний.~~
8. Система запрещает пользователям (в том числе создателю реестра и владельцу шахматки), редактировать уже существующие реестры во избежание искажения или потери информации (реестр - слепок данных шахматки на определенный момент времени).
9. Система не дает пользователю возможности безвозвратно удалять реестры, чтобы избежать случайной потери информации.
10. Пользователи системы должны иметь возможность хранить и просматривать любые созданные реестры (даже если в них лежат неполные, некорректные, противоречащие друг другу или дублирующиеся данные) с целью гибкого использования реестров.
11. Система позволяет пользователю вручную назначать реестрам статус "**Удален**", по которому пользователи смогут идентифицировать реестры, не предполагающие дальнейшей работы.
12. Система позволяет пользователю вручную назначать реестрам статус "**Оплачен**", благодаря которому реестр учитываться в системе как оплаченный - то есть, при подсчете расхождений факта с проектом (в "Лимитах").
13. Система позволяет пользователю вручную назначать реестрам нейтральный статус "**Сформирован**".
14. При создании нового реестра система присваивает ему нейтральный статус "**Сформирован**".
16. При формировании реестра система должна в табличном виде отображать пользователю следующую информацию:
    1. "Название работ";
    2. "Исполнитель";
    3. "Этаж";
    4. "Помещение";
    5. "Объем выполненных работ";
    6. "Расценка";
    7. "К выплате";
    8. "Накопительный итог".
17. Накопительный итог - это сумма всех выплат, предназначенных данному человеку. Вычисляемое значение (встретится в таблице столько раз, сколько у человека встретилось отдельных работ в данном реестре). 
18. Расценки на работу:
    1. По объёму:
        1. Расценка одна на все объекты.
        2. Для мастеров, делающих одну и ту же работу, цена не различается.
    2. По часам:
        1. У разнорабочих бывают разные расценки, из-за удалённости объекта (проще заводить новую просто работу под данный объект)
19. (?) Система должна предзаполнять инпут расценки для работ, даже если работа с таким названием еще не заполнялись на данном объекте, но заполнялась на других объектах (в work_template тоже должно быть поле "price", и оно апдейтится каждый раз, когда работа с таким же именем в некоторой шахматке обновила расценку).
20. Система должна предоставлять пользователю возможность указать разные расценки для одинаково называемых работ, если они используются на разных объектах (work имеет поле price, так что все ок).
21. ~~Функционал закрытия реестров будет необходим в мобильном приложении как только будет реализована интеграция с 1C. Он будет работать только если устройство онлайн.~~ Сейчас в мобильных устройствах функционал реестров не реализуется.
22. Система должна отображать в боковой панели рядом с информацией об объемах работ ("Всего"/"Дефектовка", "Выдано", "Выполнено", "Отстаток" (пока нет) или других) информацию обо всех **записях об оплате**, связанных с данной **работой**.

###  Ключевые тезисы

1. "Частичных оплат" более нет (частичные оплаты и полные оплаты не различимы):
    1. Каждая работа попадает в реестры сколь угодно много раз;
    2. Работы нельзя "закрыть" какой-либо оплатой - работа может получить сколь угодно много **записей об оплате**, попав в несколько разных реестров;
    3. При формировании реестра новые записи о работах "на остаток" не создаются;
    4. Общее число работ в проекте в стандартном случае постепенно становится равно **числу_этажей * число_комнат * число_названий_работ** - и далее больше не растет.
2. Реестры на оплату сближаются по функциональности с отчетами. Однако отчеты и реестры отображают разные поля и в разном порядке - несмотря на схожесть структуры, предназначение у них разное: у отчетов - финансовое и операционное планирование, у реестров - корректный подсчет текущих расходов на выплаты.
3. Критерии попадания работы в реестр упрощаются с:
    1. Статус "Завершено";
    2. Указаны "Исполнители";
    3. Указаны "Объемы";
    4. Отсутствует отметка об оплате.  
    до
    1. Указаны "Исполнители";
    2. Указаны "Объемы".
4. Реестр невозможно отредактировать.
5. Реестр на текущий момент невозможно жестко удалить, но можно скрыть (отправив в корзинку, поставив фильтр или как-то иначе).
6. Реестры могут иметь статусы "Сформирован", "Оплачен", "Удален":
    1. "Сформирован" - нейтральный статус, реестр отображается в списке реестров, выдается по умолчанию при создании реестра;
    2. "Оплачен" - реестр должен учитываться системой при работе с лимитами (должен отображаться в боковой панели шахматки);
    2. "Удален" - реестр непригоден или не интересен для дальнейшей работы; не отображается в списке реестров; однако может быть просмотрен пользователем где-то еще и возвращен к статусу "Сформирован" или "Оплачен";
7. Статус реестра возможно менять вручную.
8. Спектр отображаемых данных в реестре:
    1. Название работы
    2. Этаж
    3. Помещение
    4. Исполнитель
    5. Объем
    6. Расценка
    7. К выплате
    8. Накопительный итог
    9. ~~Остаток~~
    10. ~~Всего~~
    11. ~~Процентовка~~
    12. ~~Расценка~~
9. Данная фича может быть зааффекчена фичей "Версионирование шахматки".
10. Данная фича может быть зааффекчена фичей "Лимиты".

### Функциональные требования

1. Общие требования:
    1. Переход в раздел "Реестры на оплату" осуществляется:
        1. из шахматки через **Панель действий**, по клику на контрол "Реестр на выплату";
        2. из шахматки через **Боковую панель**, когда в **Левой панели** выбран профиль некоторой работы (но не профиль Замечаний и не профиль Вида работ) - в боковой панели в этом случае отображены ссылки на все реестры в статусе "Оплачен", в которые данная работа попадала.
    2. Пользователь с правом на "Чтение" и пользователь с правом на "Редактирование" одинаково взаимодействуют с контролами как в **Панели действий**, так и в **Боковой панели**; они попадают на одну и ту же страницу с реестрами и оба могут нажать на контролы "Создать реестр на выплату" вверху экрана или в заглушке: 
        1. Для пользователя с правом "Чтение" форма, открываемая на Шаге 1 формирования реестра, будет задизейблена; соответственно, он не сможет выбрать ни одну работу, и формирование реестра на этом остановится.
    3. "Чтец" может просматривать список реестров и просматривать содержимое реестров, но не может создать новый реестр или изменить статус существующего реестра.
        1. Создание реестра останавливается на Шаге 1, когда пользователь "Чтец" не может выбрать ни одну работу;
        2. Смена статуса существующего реестра (предположительно) останавлиается на экране просмотра наряда, где контрол смены статуса наряда будет задизейблен [как показано тут](https://zpl.io/9qAW38y).
    4. "Редактор" и "Владелец" могут просмотреть список реестров, просмотреть содержимое любого реестра, создать новый реестр и изменить статус существующего реестра.
    5. Кнопка для перехода в раздел "Закрытие реестров" недоступна, пока в шахматке не настроено хотя бы один справочник из списка:
        1. сам объект;
        2. список работ на объекте; 
        3. список исполнителей;
        4. список технадзоров.
2. Просмотр списка реестров.
    1. В разделе "Реестры" система предоставляет пользователю возможность просмотреть наряды в статусах "Удален", "Оплачен", "Сформирован". 
    2. Пользователь может скрыть реестры в статусе "Удален".
    3. По умолчанию реестры в статусе "Удален" скрыты.
    4. Система предоставляет пользователю возможность создать новый реестр на выплату.
    5. Система предоставляет пользователю возможность вернуться назад к шахматке.
    6. Если для данной шахматки еще не было создано ни одного реестра, в разделе "Реестры" отображается заглушка с контролом на создание нового реестра.
    7. Если для данной шахматки создан хотя бы один реестр, система отображает таблицу реестров, в столбцах которой:
        1. Порядковый номер реестра;
        2. Дата создания реестра;
        3. Статус реестра. 
    8. Система предоставляет пользователю возможность осуществить сортировку таблицы реестров:
        1. Порядковый номер реестра: прямой и обратный алфавитный порядок;
        2. Дата создания реестра: прямой и обратный хронологический порядок;
        3. Статус реестра: прямой и обратный алфавитный порядок. 
    9. ~~Фильтрация или Быстрый поиск в списке нарядов отсутствует. По-хорошему нужна поддержка поиска реестров, содержащих исполнителя, название работ, место проведения - так же, как это делается при создании нового наряда.~~
3. Формирование нового реестра.
    1. Шаг 1 формирования нового реестра: Работы
        1. Система предоставляет пользователю возможность выбрать одну или несколько работ шахматки, которые войдут в наряд; 
        2. Система предоставляет возможность фильтровать работы:
            1. по названию работы; 
            2. по месту проведения работ (этаж + room_group);
            3. по исполнителю.
        3. Система предоставляет возможность сортировать работы по столбцам таблицы:
            1. по названию работы;
            2. по месту проведения работ (этаж);
            3. по месту проведения работ (room_group);
            4. по исполнителю;
            5. по объемам выполненных работ;
            6. по сумме к выплате.
        4. Система должна отображать для каждой работы ее текущий статус ("Завершено", "Ожидает дефектовку") ~~(статус работы выводится как светофор около каждой работы)~~.
        5. Система должна отображать количество выбранных пользователем работ:
            1. если пользователь выбрал А работ, а результаты фильтрации/поиска вернули B работ, отображать число A.
        6. Система предоставляет возможность сбросить каждый из фильтров к исходному состоянию.
        7. Система предоставляет возможность выбрать все отфильтрованные работы с сохранением выбранных ранее позиций.
        8. Система предоставляет возможность снять выделение с отфильтрованных работ с вычитанием этих позиций из перечня ранее выбранных позиций.
        9. Если не выбрана ни одна работа, то по нажатии на кнопку "Продолжить" пользователь останется на экране и увидит уведомление с предложением выбрать хотя бы одрну работу ("желтое").
    2. Шаг 2 формирования нового реестра: Расценки
        1. Система предоставляет пользователю возможность указать расценку для каждой из названий работ, попавших в реестр.
            1. Расценка на работу зависит от названия работы ~~и от объекта (но мы и так работаем в рамках одного объекта)~~;
            2. Расценка на работу для разных мастеров ~~на одном и том же объекте~~ одинакова.
        2. Если пользователь выставил при фильтрации A названий работ, а нашлось B названий работ, указать расценку можно только для B работ.
        3. Если расценка на работу с данным именем и на данном объекте:
            1. ранее указывалась пользователем в этой шахматке, предзаполнить поле "Цена" этим значением;
            2. ранее не указывалась пользователем в этой шахматке, оставить поле "Цена" непредзаполненным.
        4. Порядок отображения полей "Цена" - алфавитный.
        5. Система позволяет пользователю вернуться на экран выбора работ для наряда без сохранения значений полей "Цена", даже если они были заполнены пользователем.
        6. Если хотя бы для одной работы поле "Цена" не заполнено, система отрисовывает ошибку для этих инпутов и не позволяет перейти далее (**сейчас инпут подписывается и горит красным, но нужно "желтое" уведомление для единообразия опыта. В любом случае, тот же вопрос "Красный инпут vs уведомление" существует и при вводе телефона и кодов при регистрации, нужно, скорее всего, одно решение на всех**). Показать желтое уведомление с текстом "Заполните все расценки" и треугольником.
    3. Шаг 3 формирования нового реестра: Реестр создан
        1. Во время создания реестра, показывается заглушка в ширину экрана;
        2. После успешного создания система возвращает пользователя к списку реестров, в котором содержится новый реестр:
            1. Новому реестру автоматически присваивается порядковый номер, больший чем самый большой порядковый номер существующих реестров на 1.
            2. Новому реестру автоматически проставляются текущие дата и время.
            3. Новому реестру автоматически проставляются статус "Сформирован".
4. Просмотр реестра и смена статуса реестра.
    1. Система позволяет пользователю перейти из списка реестров в конкретный реестр через клик по строке таблицы.
    2. Система отображает конкретный реестр как таблицу со столбцами:
        1. Название работы;
        2. Этаж;
        3. Помещение;
        4. Исполнитель;
        5. Объем;
        6. **Расценка**;
        7. К выплате;
        8. **Накопительный итог** - сумма всех выплат, предназначенных данному исполниителю (встретится в таблице столько раз, сколько в данном реестре нашлось работ для данного исполниителя).
    3. ~~Система позволяет направить реестр на выплату в 1С.~~
    4. Система позволяет скачать файл в формате xlsx ~~и pdf~~.
        1. ~~Система должна выгрузить полный xlsx с полями "Расценка", "К оплате", "Накопительный итог".~~
        2. ~~Система должна выгрузить частичный pdf без полей "Расценка", "К оплате", "Накопительный итог".~~
5. Отображение **записей об оплате** в **боковой панели**.
    1. В интерфейсе шахматки: если в **левой панели** выбрана некоторая работа и в **рабочей области** выбрана некоторая ячейка/ячейки, в **боковой панели** система отображает данные по всем **записям об оплате** (payment_report_task) для данной комбинации **название_работы** + **этаж** + **room_group**, если связанный с ней наряд имеет статус "Оплачено". Отображаемые данные:
        1. ~~Номер наряда~~ (если помещается);
        2. Дата наряда без времени;
        3. Исполнитель;
        4. Объем;
        5. ~~К выплате~~ (если помещается).
    2. Порядок сортировки записей об оплате - хронологический. Самые недавние записи раполагаются выше, самые старые - ниже.
    3. Данные кликабельны. По клику на строку осуществляется переход к просмотру соответствующего реестра.
        1. Возврат назад в шахматку осуществляется пока через список реестров ("Назад к списку" -> "Назад к шахматке").

### Нефункциональные требования

1. Быстродействие - будет постепенно уточняться.
2. Безопасность:
    1. Доступ к просмотру и редактированию реестров необходимо в будущих версиях настраивать отдельно от просмотра / редактирования самой шахматки, иначе либо редакторов будет мало, либо знать они будут слишком много.

### Backlog

1. Импорт, экспорт реестров в xlsx и pdf. Печатные формы, работа с документами. Системный подход к печати всех доков в продукте.
2. Функционал создания выписки по всем записям о работе и всем записям об оплате для конкретного исполнителя. 
3. Чтобы не терять наполнение работ исполнителями надо дать пользователю возможность редактировать списки технадзоров и исполнителей. 
4. (?) "Пользовательская" сортировка работ (по бизнес-последовательности, не по алфавиту).
5. (?) Массовое действие из шахматки: выбрать несколько ячеек и сформировать по ним всем реестр (и только по ним). 
6. (?) Приводить информацию из реестров в боковой панели шахматки: не только по объемам, но и по расценкам, особенно, если они изменились.
7. (?) Система должна предоставлять пользователю возможность быстро найти необходимый реестр в списке реестров. Фильтрация или Быстрый поиск в списке нарядов отсутствует. По-хорошему нужен поиск реестров, содержащих исполнителя, название работ, место проведения - так же, как при создании нового наряда. Должен быть поиск по списку реестров, помогающий пользователю идентифицировать нужный реестр за определенный расчетный период (все такие реестры.)
8. (?) Возможность закрыть работу руками, чтобы она больше в реестры не попадала.

### Непростой пример E2E (web-версии)

1. **Пользователь** (**П**) заходит в чужую шахматку, где обладает правами "Редактора". Шахматка полностью настроена, в нее внесен ряд актуальных работ. Реестров на базе данной шахматки еще не создавалось.
2. **П** переходит в раздел "Реестр на выплату", где сможет увидеть все созданные реестры и кнопку "Создать реестр". Так как реестров не создавались, сейчас **П** видит заглушку, где дублируется предложение "Создать реестр на выплату". Нажимает на любую из кнопок "Создать реестр на выплату".
3. Запускается процесс создания нового реестра, в результате чего **П** видит таблицу со списком всех работ, которые есть в шахматке в данное время. У них:
    1. указаны исполнители;
    2. указаны объемы.
4. **П** выставляет фильтр по названию работы ("Поклейка обоев почасовая" И "Поклейка обоев в м2"), а также фильтр по месту проведения ("этаж 2, все помещения"). Видит только работу "Поклейка обоев почасовая", для которой приведены всевозможные исполнители. Для "Поклейка обоев в м2" подходящих работ не нашлось.
5. **П** выбирает с помощью чекбоксов интересующие его работы (например, все 5 досутпных), нажимает на кнопку "Продолжить".
6. **П** видит экран, предлагающий ввести расценку в инпут для единственного названия работы, для которого нашлись работы, общую по всем исполнителям. Инпут не предзаполнен.
7. **П** вводит расценку по работе и нажимает кнопку "Создать". 
8. Система короткое время показывает заглушку "5сек", после чего возвращает **П** к списку реестров, содержащий 1 реестр, для которого указаны:
    1. Номер реестра;
    2. Дата создания;
    3. Статус "Сформирован".
9. **П** кликает на только что созданный реестр и просматривает его. В реестре столько же строк, сколько было проставлено чекбоксов на Шаге 1. **П** видит ошибку в фамилии исполнителя, а также обнаруживает, что число работ оказалось меньше желаемого (не учтена одна сдельная работа), а еще что у одной работы должна была быть другая расценка (крайне редкое исключение).
10. **П** переходит "Назад к шахматке" и затем переходит в список исполнителей шахматки, где редактирует фамилию исполнителя (сейчас через создание нового исполнителя!), сохраняет. В работах, где этот исполнитель был указан, сейчас поле заменилось на null.
11. **П** в шахматке переходит в левой панели в профиль "Поклейка обоев почасовая". В тех ячейках, где был указан исполнитель с неверной фамилией, теперь можно указать исполнителя с корректной фамилией, что **П** и делает. Каждый раз сохраняет.
12. **П** в шахматке переходит в левой панели в профиль "Поклейка обоев в м2". Далее на 2-ом этаже в одном помещении проставляет исполнителя и объем.
13. Заходит в справочник работ и создает новую работу "Поклейка обоев почасовая Люберцы-102", сохраняет.
14. **П** в шахматке переходит в левой панели в профиль "Поклейка обоев почасовая". В одном из помещений удаляет все заполненные поля, в том числе Исполнитель и Объем.
15. **П** в шахматке переходит в левой панели в профиль "Поклейка обоев почасовая Люберцы-102". Далее на 2-ом этаже в том же помещении, где работал в п.13, в работе ручками проставляет все поля, в том числе исполнителя и объем.
16. **П** возвращается в раздел "Создание реестров". Проставляет старому реестру статус "Удален", после чего реестр скрывается из списка реестров. Нажимает на кнопку "Создать реестр на выплату".
17. Далее повторяются пункты 3-8 с двумя отличиями:
    - 4. Для "Поклейки обоев в м2" нашлась одна новая работа;
    - 4. Для "Поклейка обоев почасовая Люберцы-102" нашлась одна новая работа;
    - 4. Для "Поклейка обоев почасовая" фамилии всех исполнителей теперь написаны корректно и их на одну меньше, чем ранее (4);
    - 5. **П** выбирает все доступные работы (все 6);
    - 6. Инпут для работы "Поклейка обоев почасовая" предзаполнен. Инпут для работы "Поклейки обоев в м2" и "Поклейка обоев почасовая Люберцы-102" не предзаполнены.
18. **П** просматривает только что созданный реестр. В нем все корректно, и он проставляет статус "Оплачено" данному реестру (заранее). Скачивает реестр в xlsx.
19. **П** открывает скачанный xlsx, перепроверяет его. Переносит руками столбцы в 1C. Распечатывает реестр, чтобы убедиться, что данные не потеряются.
20. **П** хочет оценить, скорость и стоимость работы. Для этого он хочет сравнить три цифры:
    1. Как "расчетный период" относится к "количеству дней до дедлайна" - в разрезе конкретной работы.
    2. Как "общая сумма выплат в реестре" соотносится со "суммой в смете" - в разрезе конкретной работы. 
    3. Как "выполненный объем работ" соотносится с "общим объемом работ согласно проектому плану" - в разрезе конкретной работы.
    Чем больше соотношение п.2 к п.1 (или, что то же почти самое, п.3 к п.1), тем лучше идут дела. Можно даже такой хитрый коэффициент ввести.
