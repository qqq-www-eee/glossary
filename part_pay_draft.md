## Наряды и реестры на выплату. Частичное закрытие работ

### Используемые понятия

1. **Наряд** - таблица, отражающая объёмы выполненных работ за определенный период по всем работникам секции. Закрывается технадзором: после приемки работ, приемки отработанных замечаний, если они были, и фиксации всех фактических показателей работ. Выглядит приблизительно [так]() или [так]().
2. **Реестр на выплату** (**реестр**) - документ, формируемый после закрытия наряда руководителем координации. Это финансовая выжимка наряда с указанием сумм к выплате, направляемая в бухгалтерию. Выглядит [так]().
3. **Расчетный период** - период времени, за который составляется наряд и соответствующий реестр на выплату. Как правило, по бизнесу пользователю расчетный период заранее известен и не изменяется (обычно 7 дней). Система между периодами никак не итерируется - даты расчетного периода имеют символическое значение и подбираются автоматически при формировании наряда.
4. **Работа** (родительская работа) - проведение определенного наименования работ в определенном помещении. Может длиться один или нескольких расчетных периодов. Работа может быть разбита на "частичные работы". Не путать с наименованием работ, которые приведены в справочнике. Работа однозначно определяется по комбинации **work_id** + **storey** + **room_group** и по сути есть слайс помещения под конкретную работу. 
5. **Частичная работа** - часть работы, длящаяся 1 расчетный период. У частичной работы за время ее жизни по бизнесу исполнитель подразумевается неизменным. Поля "Выдано работ" и "Выполнено" принадлежат именно частичной работе.
6. **Частичное закрытие наряда** (иногда **процентовка**) - процесс сбора и подготовки информации по объекту для взаиморасчета с мастерами за 1 расчетный период (т. е. за 1 частичную работу).  
7. **Перерасход** - состояние работы, при котором сумма значений "объем выполненных работ" по всем ее частичным работам превышает значение ее поля "Дефектовка".
8. ~~**Частичный перерасход** - состояние частичной работы, при котором текущий объем выполненных работ превышает значение поля "Выдано". Это скорее не перерасход, а это ошибка - зачесть работы и не учесть, куда взяты материалы. Пока нет смысла на этом фокусироваться.~~

### Некоторые тезисы

1. Для описания частичного закрытия нарядов недостаточно "таски". Таски необходимо разделить на две сущности с более понятными атрибутами и статусной моделью. Что приводит к таким мыслям:
    1. "Ожидает дефектовку" и "Готово к работе" - неясно, чем отличаются.
    2. Более того, статус "Ожидает дефектовку" по смыслу для созданной и несозданной таски отличаются. Сначала "Ожидает дефектовку" = "Таски нет, статуса нет", если таска не создана, а если создана (например была указана дефектовка = 0) то это становится реальным статусом задачи "Ожидает дефектовку".
    3. Три серых цвета - ок?
    4. Дефектовка - это история, которую делают в самом начале объекта, когда принимают его. Из-за передачи фронта работ дефектовка все-таки ближе к работе, чем к помещению, но она точно не относится к рабочему флоу частично закрываемых нарядов. 
    5. При этом новые замечания технадзоры оставляют каждый расчетный период.
    6. Статусы об оплате работают с периодом недели, но главное, что должен быть флаг, отличающий оплаченную порцию работы от неоплаченной. То есть это "статус" либо "булев атрибут" той сущности, которая попадает в частичные наряды и в рамках них закрывается.
    7. Главное - статусы надо крепить к работе, не к частичной работе (у нас так и сделано). Почему? Потому что "Вид работ" будет становиться зеленым тогда, когда по-настоящему закончен целый срез работ. Зелеными фасолины станут только в самом конце, что приведет к покраске и ячейки "Вида работ".
    8. Как же тогда понять, что частичная работа готова к оплате? За счет другого, промежуточного статуса - это самое просто решение.
2. За частичную работу платят в рамках одного отдельно взятого расчетного периода (и наряда). После закрытия этого наряда для вошедших в него частичных работ, **если основная работа еще себя не исчерпала, пересоздаются новые сущности частичных работ "на остаток"** - чтобы уже оплаченные работы больше ни в один наряд не попали. При этом система должна знать, когда остановиться, иначе в конце каждой работы будут вечно висящие таски, которые еще, возможно, все время будут попадаться в нарядах.
    1. Какие частичные работы попадут в наряд? - Только те, что находятся в правильном статусе (но не в "completed", а скорее в "readyToPay"), у них указаны исполнитель и объем произведенных работ.
    2. Когда перестаем создавать таски на остаток?
        1. opt1: Хотя значение дефектовки можно спокойно редактировать, при пересоздании частичных работ мы можем полагаемся именно на это поле. Тогда Пользователю необходимо подстветитьи объяснить эту логику - что мол свободный ввод данных в поле дефектовка не значит, что мы на нее не смотрим - мы смотрим. А еще пользователь может захотеть вести в шахматке ситуацию с контролируемым перерасходом, и она подтолкнет к тому, что надо будет в дефектовке вводит ненастоящие значения, потом давать кнопку для создания таски и пр. Непростой вариант.
        2. opt2: Альтернативой может быть - всегда пересоздавать таску на остаток, но дать пользователю прямую кнопку, как убить таску.
        3. opt3: Опять же статус. Пользователь просто переводит работы у специальный статус "Готово1", при котором таска будет пересоздаваться на остаток (readyToPay), или переводит в другой статус "Готово2", при котором таска на остаток пересоздаваться не будет (completed). Первая на вкладке "Обзор", скажем, покрасит фасолину в синий, а вторая - в ярко-зеленый. Это позволит пользователю отличать во вкладке обзор работы, которые "Готовы в рамках периода" от тех, что "Совсем прям готовы".
    3. Как вычислять, кого из частичных работ мы в наряд кладем?
        1. Те, что readyToPay. У них создастся новая частичная работа на остаток.
        2. Те, что completed. Просто завершаются.
    3. Еще раз наглядно пройдем. Кашу из статусов надо было разделить по трем сущностям: "помещение", "родительская работа" и "частичная работа".
        1. Полный список:
            1. Ожидает дефектовку
            2. ~~Отдефектовано (может совпадать с "Готово к работе")~~
            2. Готово к работе.
            3. В работе.
            4. Ожидает технадзор.
            5. Есть замечания.
            6. Завершено.
            7. ~~Готово к оплате (может совпадать с "Завершено")~~
            8. Оплачено
        2. Распределение:
            1. Частичной работе достается bool: "Оплачено" - "Не оплачено".
            2. "В работе", "Ожидает технадзор", "Есть замечания", "Завершено" достаются работе. "Готово к оплате" тоже достаются работе. "Ожидает дефектовку" тоже достается работе.
                1. "Дефектовка" - параметр для родительской таски, так как хотим относить к каждому "типу работ + помещение" отдельную дефектовку, в частности, для передачи фронтов работ. ХОтя было близко к тому, чтобы попасть в атрибуты помещения. Поэтому "ожидает дефектовку" и "Отдефектовано" (= готов к работе) достанутся родительской работе. Это может быть просто заполненное или не заполненное поле?
            3. "Помещению" не досталось ничего.
        3. Возникают ограничения:
            1. Сначала создается шахматка, в ней вообще нет работ. 
            2. Если уже здесь выйти на вкладку обзор - будут представлены пустые серые фасолины (по числу наименований работ в группе "Вид работ", например 5 шт) (~~подписана первая работа в этой группе? по алфавиту, не по бизнес-логике. Зачем мы показываем рандомную работу?~~). Если все фасолины статусе "ожидает дефектовку" (пустые серые) И поля в них не были заполнены, то в правой панели должна показывать заглушка про отсутствие работ.
            3. Как только хотя бы одна работа в виде работ получает заполненное поле, создается работа + частичная работа. Все "объемы" и "выдано" идут в частную работу, а значения по дефектовке должны относиться к родительской работе. Точно так же, как только хотя бы одна работа получила статус, отличный от "ожидает дефектовку", тоже создается работа + частичная работа. Каков смысл этого статуса, если цифра дефектовки не указана? Можно использовать "Готово к работе" как эвфемизм для "Ожидает дефектовку", но с проставленной дефектовкой. Тем более, довольно странно выглядит, что одна и та же серая фасолина может являться как штукой без таски, так и штукой с таской.
            4. ~~Число фасолин, кстати, вычисляется почему-то на основе работ, уже представленных в шахматке. То есть если в виде работ у нас 6 наименований работ, то 6 будут только если заполнены все 6 из них хоть где-то. Наверное, это тоже баг.~~
            5. Потом у самих фасолин начинают меняться статусы. Этот статус может стать "Готово к работе" (дефектовку мол провели), потом в работе, потом ожидает технадзор, потом замечания, потом снова в работе-ожидает_тезнадзор-замечания, так несколько раз и потом только в самом конце это должно быть "Готово". Это готово, фактически, нужно именно для вкладки "Обзор". 
            6. Поэтому статусная модель предполагается очень даже похожей.
4. То есть возникли вопросы.
    1. Что такое красный цвет фасолины?
    2. Хотим ли мы, чтобы ячейка "Вида работ" с фасолинами закрашивалась зеленым, когда у нас одно наименование работ выполнено полностью, а все остальные - наполовину, на треть и так далее? То есть норм, что в момент закрытия наряда все ячейки будут становиться зелеными, а в понедельник снова они все будут становиться серыми? Или мы хотели бы видеть ячейку в масштабе "Вида работ" зеленой только тогда, когда все работы уже точно сделаны полностью? МЫ на самом деле можем сделать одновременно и так, и так.
4. Работа имеет статусы "Ожидает дефектовку"/"Готово к работе"/"В работе"/"Ожидает технадзор"/"Есть замечания"/"Завершено" и др., никаких статусов об оплате. Статус "Ожидает дефектовку", лучше бы напрямую значил, что таски нет. То есть таска заводилась бы вместе с дефектовкой? ну нет.
5. В общем, ключевой момент - разнести "статус рабочего процесса" и "статус оплаты", потому что они попросту независимы. Вторая сущности нужна для нарядов внутри, первая - для вкладки "Обзор".
6. Считаем, что дата создания наряда совпадает с датой окончания расчетного периода.
9. Наряд - неизменяемая штука (ни пользователем, ни системой). ~~В ней, возможно, можно будет редактировать коммент-название и статус, но не факт, что они появятся.~~ 
10. Смежным лейтмотивом идет вложенность/невложенность project, storey, room_goup. Таски должны убиваться и создаваться на остаток при частичном закрытии наряда. А вот Работа должна жить до тех пор, пока живут три сущности:
    1. ее этаж
    2. ее рум_груп
    3. ее наименование работ.
    Зачем это? Это позволит делать удобные и логичные селекты для сбора "всех частичных работ, относимых к данному наименованию работ в данном помещении" (по айдишнику, а не по совокупности общих характеристик типа этаж + room_group + наименование работы).  
11. Частичная работа готова к оплате когда? Всегда? То есть сформировали наряд, и в него попадают все текущие частичные работы, статус ОСНОВНОЙ работы у которых завершено? нет.  статус ОСНОВНОЙ работы у которых "Готов к оплате"? ОЧЕНЬ похоже на правду. Либо должен быть доступ до статуса частичных работ "WIP-ready-paid". То есть нам нужны два статуса "Завершено". Одно из них readyToPay, фактически. Также у частичных работ может быть просто булев флаг о том, что они таки были оплачены.
12. Как будет обнуляться статус после закрытия наряда? Сразу в WIP.
14. Фасолина будет, например, синей, когда все частичные работы в составе фасолины либо оплачены, либо готовы к оплате. То есть как минимум "ready". А если они готовы прям совсем-совсем, то статус уже красим в зеленый, но и у фасолины он тоже зеленый. Когда все фасолины зеленые, красится зеленым клетка "Вида работ".
16. Еще один поинт в пользу частичных оплат - это подозрение, что мы можем хотеть в будущем иметь в одном помещении несколько тасок на одну и ту же работу под разными исполнителями. Кейс - ночные смены или даже 3 смены в сутки - для экстренно закрываемых строительных кейсов. Это может быть решено иначе (через создание дополнительных этажей или дополнительных проектов), но в целом мы не против принципиально иметь возможность нескольких тасок в одной работе одновременно.
19. В наряды кладутся частичные работы. Больше одного раза пользователь частичную работу в наряды положить не может. Общая работа при этом может относиться к нескольким нарядам. Мы теперь даже можем собирать все наряды, которые относятся к одной и той же работе с какой-нибудь коварной продуктовой целью.
20. Пользователю необходимо давать возможность выбрать конечную дату закрытия наряда. Это формальность, но эта возможность должна быть у пользователя. 
21. Дата начала расчетного периода определяется автоматически по дате закрытия последнего из предыдущих нарядов по этой же родительской-работе! 
    1. Если удаляем наряд, то удаляем все наряды, дата закрытия которых позже этого. Это просто решение кучи задач с головоной болью, например, чтобы не вводить "элементарную работу" - работу за один день, а то, может, и за час.
    2. Если дать пользователю выбирать обе даты, он может наотмечать там какие угодно дни и сколь угодно "дыряво". Это сложно учесть грамотно, а еще сложно объяснить пользователю, как оно работает. И там как раз элементарные работы возмникают.
    3. Можно дать пользователю возможнось итерироваться по расчетным периодам, в качестве альтернативы, но тогда надо еще где-то настройку расчетных периодов прикрутить? Сильно ограничивает пользователя. 
    4. По умолчанию предзаполнение должно быть с последнего наряда по сегодня или с последнего наряда + неделя?
22. В один момент времени в одной работе (родительской работе) может быть быть только одна частичная работа (таска). 
23. Частичные оплаты очень сильно связаны с функционалом версионирования шахматки. Нам нужна будет настройка - как часто сохраняем состояние шахматки? По умолчанию каждый день. Или просто по нажатию кнопки "Зафиксирвоать текущую версию". Либо и ручное, и автосохранение работают вместе... Только ручное насчегда а автоматическое, например, 2 месяца. Тогда можно будет закрывать наряд на разницу между последним закрытым нарядом и любым из сохраненных состояний шахматки.
24. Пока что можно закрыть наряд на разницу между прошлым нарядом и 
25. Важный момент - расценки указываются индивидуально для каждого мастера.
3. Строительные работы бывают сдельными (подавляющее большинство) и почасовыми (представлены мелкими доработками). К почасовым прибегают не на каждом объекте. Технически работа сдельщиков и часовщиков реализуется одинаково, отличие в единицах измерения - у сдельных работ это всегда час. Разделять сдельные и почасовые работы при закрытии нарядов можно через выставление фильтра по единицам измерения - в частности, делать два отдельных наряда.

### Предложения по БД:
1. Различать живую частичную работу от строки в наряде. Потому что первые, например, удаляются вместе с родительской работой, они отображают обновления в пользователях, в исполнителях, в объемах и т. д. А вторые - никогда и никак уже не изменяются. Могут быть только полностью ретированы через удаление наряда полностью. Ни наряд, ни нарядная дочерняя работа не редактируемы. Родительская работа и простая дочерняя работа - меняются.
3. Частичная работа должна иметь свой id, ссылаться на id родительской работы, содержать объем~~/расценки/всего_денег~~ на момент создания наряда и флаг "is_paid". Чуть ли не 4 полей должно хватить.

### Выводы 
1. Дефектовка - это характеристика родительской работы в лучшем случае (близко к тому, это вообще характеристика помещения). 


###  Action points:
1. Добавить единицу измерения "час" и список почасовых работ.
2. В таблицу с пользователями:
    1. добавить должность пользователя
    2. заменить три поля под ФИО на одно поле "full_name"

### Базовые функциональные требования

1. НАРЯД - у него тоже есть специфические поля:
    1. Нужны поля:
        1. Номер наряда
        2. Дата-время создания
        3. id создателя
        4. project_id
        5. Окончание расчетного периода (часто будет совпадать с полем "дата-время создания")
    2. Кажется, эти поля не нужны:
        1. Начало расчетного периода (оно всегда совпадает с окончанием расчетного периода предыдущей дочерней-таски! Поэтому будем брать оттуда джоином вместо того, чтобы следить, что в обоих полях консистентно лежит одно и то же)
        3. ФИО автора
        4. Должность автора
        5. Статус (сформирован, оплачен, удален)
        6. Название наряда
    3. Какие поля будут отображаться в списке нарядов:
        1. Номер
        2. Дата создания
        3. Дата создания предыдущего наряда по этой работе
        4. Автор (ФИО + Должность)
2. ЧАСТИЧНАЯ РАБОТА В ШАХМАТКЕ (то есть дочерняя таска~~, и оно же то, что в наряде у нас составляет одну строку - только статуса об оплате пока нема~~):
    1. Частичная работа не может же быть отрицательной! Поэтому чтобы не было казусов, пусть в полях отражается то что в текущем расчетном периоде будет учтено, если вдруг прям сейчас наряд закрыть. То есть мы про боковую панель говорим.
    2. ВАЖНО ОТЛИЧАТЬ ЧАСТИЧНУЮ РАБОТУ ОТ ЧАСТИЧНОЙ РАБОТЫ, ЗАФИКСИРОВАННОЙ В НАРЯДЕ. Первая должна держать id исполнителя и разные поля, такие как объем выполненных работ (а вот id работы, этажа и рум-группы все равно не поменяются), а вторая должна фиксануть чисто значения полей на момент подачи наряда. К сожалению, нужен дубль. Почему их нельзя объединять? Потому что что work_name и select-join name по work_id будут разными! Ну и что? Работу вообще нельзя пока менять. Зато можно удалять! И из нарядов оно пропадать не должно! Хотя бы поэтому.
    3. Нужны поля:
        1. id Исполнителя
        2. id РОДИТЕЛЬСКОЙ-ТАСКИ (а в ней же будут ссылки и на работу как в шахматке/ведомостях, и как в 1С заказчика, если надо, и единицы измерения, и дефектовка, и подтаскивание всех предыдущих частичных работ для высчитывания того, что готово)
        3. ~~Расценка - просто не нужна~~
        3. Объемы - которые он сделал
        4. is_Paid - была ли уже эта дочерняя-таска оплачена? Если true, то она старая. Если false, то это последняя актальная работка
            1. Надо отметить, что если наряд отпавляется в коризину, то присовокупленные таски должны:
                2. Либо нафиг удалиться, если нам неважно, кто и чего раньше делал.
                3. либо потерять статус is_Paid, если нам захочется потом как-то восстановить историю.
3. ЧАСТИЧНАЯ РАБОТА В НАРЯДЕ (~~то есть дочерняя таска, и оно же то, что~~ в наряде у нас составляет одну строку - только статуса об оплате пока нема):
    1. Сейчас в наряд попадут работы, у которых:
            1. в дочерней-задаче указан Исполнитель,
            2. в дочерней-задаче указан выполненный объём
            3. дочерняя-задача не попала в сформированные ранее наряды.
            4. Родительская-таска имеет рабочий статус «Завершено»???????? НЕТ! Скорее всего, статус должен быть "В работе". Потому что замечания оставляются раз в работа, а не каждую неделю. Ожидает дефектовку и проходит дефектовку работа тоже только один раз в работу, а не в частичную работу!
            14. id наряда, в которых он попал. Надо подумать. Попадание в наряд - хороший критерий оплаченности! Но и наличие закостенелого брата тоже хороший критерий оплаченности!
    1. Нужны поля:
        1. Исполнитель / Сотрудник - на момент формирования наряда
        2. Вид работ / Вид работ по ведомости - на момент формирования наряда (эти господа, вероятно, не меняются)
        3. Вид работ по 1С - потом потребуется - на момент формирования наряда (эти господа, вероятно, не меняются)
        4. Единица измерения - Выносятся отдельно ради сортировки и фильтрации - на момент формирования наряда (эти господа, вероятно, не меняются)
        5. Тип помещения (помещение) - на момент формирования наряда (эти господа, вероятно, не меняются)
        6. Этаж  - на момент формирования наряда (эти господа, вероятно, не меняются)
        7. Объем выполненных работ - на момент формирования наряда
        8. ВСЕГО - дефектовка  - на момент формирования наряда
        9. (Процентовка - высчитывается!)
        10. (Остаток - высчитывается!)
        11. Расценка - на момент формирования наряда
        12. (К выплате - высчитывается!)
        13. Свой собственный id
        14. id наряда, в которых он попал. Надо подумать. Попадание в наряд - хороший критерий оплаченности.
    2. Отметим, что все те поля, которые вероятно не меняются вообще завязаны на родительскую таску. Часть из них вообще справочники.
4. РАБОТА (РОДИТЕЛЬСКАЯ ТАСКА)
        1. id родительской таски - то есть свой id
        2. Помещение - строка, например "Квартира" / "МОП" / "ЛК" / "ЛХ" / "Вестибюль". Но, кстати, у нас оно указано отдельно и как имя, и как тип помещения
        3. Этаж
        4. Всего - дефектовка
        5. Имя работы как в ведомостях
        6. Имя работы как в 1С
        7. ~~project_id? - нет, нам достаточно этажа и помещения, которые привязаны каждый к project_id.~~
4. В нарядах должны быть сортировка и фильтрация. Пусть все будут по алфавиту, чтобы не париться. 
5. Процесс частичной оплаты работ!!!!!
6. Статусная модель по частичным работам.
7. Требования просто просмотреть и перелопатить.
8. Важный момент - расценки указываются индивидуально для каждого мастера
    

### Картинки

Как выглядит Наряд

Как выглядит Реестр на выплату


### Backlog

1. Добавить возможность редактировать "Название наряда" или прилепить ему поле "Комментарий".
2. Темы с импортом, с экспортом, со скачиванием xlsx и pdf. Печатные формы вообще работа с документами.

1. Мы все равно будем делать версионирование. Версия - слепок шахматки на момент времени. Закрываемый наряд (в том числе касательно частичных оплат) вычисляет разницу между нынешними объемами и теми, что отражены в наряде. Логичнее, и дальше будет понятно почему, сначала вычислять разницу всех значений шахматок (ну пока только объемы годятся), а потом уже обрамлять это типа в оболочку наряда. Очень нужно версионирование, потому что после него наряды, вполне вероятно, перекромсаются.


e2e.
1. Если я у меня есть закрытие расчетные периоды 1,2,3,4, и я только что закрыла период 5. При этом, если я удалю один из предыдущих нарядов, например, 2, то просто предупреждаем, что наряды, закрытые на базе этой 2-4и (а именно, 3, 4) все они короче в троем отправятся в удаленные (останутся доступны для просмотра). Они будут доступны для просмотра, но больше никогда не будут участвовать в расчетах. И следующий за 1-ым нарядом сразу будет 6, его можно будет закрыть сразу за периоды 2-5, или по отдельности, как удобно. Чтобы корректно посчтитать разницу в объемах сделанных работ, нужно хранить слепок всех дочерних-тасок и сложным образом их обрабатывать. Мы этого хотим? Нет. ПОэтому единственной возможностью будет закрыть наряд на разность между текущим состоянием шахматки и теми объемами, что были в наряде.
5. У работ в группе "Вид работ" нет сейчас бизнес-сортировки, она в целом нужна. Наверное, подумаем отдельной фичей?


### Функциональные требования

1. фыва
2. ыва
