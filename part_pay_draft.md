## Наряды и реестры на выплату. Частичное закрытие работ

### Используемые понятия

1. **Наряд** - таблица, отражающая объёмы выполненных работ за определенный период (часто неделя) по всем работникам секции. Закрывается технадзором. Это означает, что технадзор осуществил приемку работ, приемку отработанных замечаний, если они были, и зафиксировал все фактически показатели работы. Выглядит приблизительно [так]() или [так]().
2. **Реестр на выплату** (**реестр**) - документ, формируемый по закрытии наряда руководителем координации. Это финансовая выжимка наряда с указанием сумм к выплате, направляемая в бухгалтерию. Выглядит [так]().
3. **Расчетный период** - период времени, за который составляется наряд и реестр на выплату. Как правило, бизнесу заранее известен и не изменяется (7 дней). Системе заранее неизвестен, подбирается автоматически при формировании нарядов.
4. **Работа** - процесс проведения определенного наименования работ в определенном помещении. Может длиться один или нескольких расчетных периодов. Работа разбивается на "частичные работы" (они же "таски", "задачи"). Работ - это "глобальная таска". Не путать с наименованием работ, которые в справочнике.
5. **Частичная работа** - часть работы, длящаяся 1 расчетный период. У частичной работы за время ее жизни по бизнесу исполнитель подразумевается неизменным.  
5. **Частичное закрытие наряда** (иногда **процентовка**) - процесс сбора и подготовки информации по объекту для расчета с мастерами за 1 расчетный период (за 1 частичную работу).


### Прохладные истории

1. Дефектовка происходит только в начале работы (один раз в работу), а Замечания ТН оставляют каждый расчетный период ("один" раз в частичную работу).
2. Работы бывают сдельными (подавляющее большинство) и почасовыми (представлены мелкими доработками). К почасовым работам прибегают не на каждом объекте. Технически работа сдельщиков и часовщиков реализуется одинаково, отличие в единицах измерения - у сдельных работ это всегда час. Разделить работы сдельные и почасовые при закрытии нарядов можно через выставление фильтра по единицам измерения.
2. Т.н. "таска", содержит информацию о работе, за которую хотят заплатить в рамках одного отдельно взятого наряда, одного отдельно взятого расчетного периода. После закрытия наряд для вошедших в него частичных работ пересоздадутся такик же сущность "на остаток" - чтобы уже оплаченные работы больше ни в один наряд не попали.
3. Работа - однозначно определяется по комбинации **work_id** + **storey** + **room_group** и по сути есть слайс помещения под конкретную работу. Имеет статусы "Дефектовка"/"В работе"/"Замечания"/"Готова" и др., но не имеет статусов об оплате! Такая родительская таска собирает все обычные наши таски воедино.
6. Самый ключевой момент - разнести "статус рабочего процесса" и "статус оплаты", потому что они попросту независимы! Вторая сущности нужна для нарядов, если мы не хотим все время доставать таски по одной и той же работе, в одном и том же помещении сложными запросами в БД. Это простое логическое их объединение.
7. Так как сложно определиться с терминологием, буду называть далее первую сущность "**Дочерней таской**", а вторую - "**Родительской таской**".

### Коротко о важном
2. Считаем, что дата создания наряда совпадает с датой окончания расчетного периода.
3. Наряд - неизменяемая штука (ни пользователем, ни системой). ~~В ней, возможно, можно будет редактировать коммент-название и статус, но не факт, что они появятся.~~ 
4. НАМ НЕДОСТАТОЧНО для описания частичных работ одной только ТАСКИ.

5. Смежным лейтмотивом идет вложенность/невложенность project, storey, room_goup. Таски должны убиваться и создаваться на остаток при частичном закрытии наряда. А вот новая сущность "РАБОТА" должна жить до тех пор, пока живут три сущности:
    1. ее этаж
    2. ее рум_груп
    3. ее наименование работ.
Это позволит нам удобно объединять две, три, десять тасок, проводимых в одном и том же помещении.
5. В наряды кладутся дочерние-таски, и больше одного раза пользователь дочернюю-таску в наряды положить не может (а вот родительская-таска может относиться к нескольким нарядам)
6. В помещении больше одной родительской-таски для данного наименования работ быть не может (и не надо)!
7. Пользователю необходимо давать возможность выбрать конечную дату закрытия наряда. Мы никак без этого обойтись не можем.
8. Дата начала расчетного периода определяется автоматически по дате закрытия последнего из предыдущих нарядов по этой же родительской-таске! 
    1. Если удаляем наряд и в нем лежат ссылки на связанные следующие прицепленные наряды, то они тоже удалятся!
    2. Мы все это делаем, чтобы не вводить "элементарную работу" - работу за один день.
    3. Потому что если дать пользователю выбирать обе даты, он может наотмечать там какие угодно дни и как угодно "дыряво". Это можно учеть. Но мы не хотим переусложнять. Поэтому.
    4. Даем пользователю возможнось итерироваться по расчетным периодам??? тогда надо еще где-то настройку расчетных периодов прикрутить? Будем считать, что он может вольно устанавлиивать. Все.
7. В один момент времени в одной родительской-таске может быть быть только одна дочерняя-таска. Если я у меня есть закрытие расчетные периоды 1,2,3,4, и я только что закрыла период 5. При этом, если я удалю один из предыдущих нарядов, например, 2, то просто предупреждаем, что наряды, закрытые на базе этой 2-4и (а именно, 3, 4) все они короче в троем отправятся в удаленные (останутся доступны для просмотра). Они будут доступны для просмотра, но больше никогда не будут участвовать в расчетах. И следующий за 1-ым нарядом сразу будет 6, его можно будет закрыть сразу за периоды 2-5, или по отдельности, как удобно. Чтобы корректно посчтитать разницу в объемах сделанных работ, нужно хранить слепок всех дочерних-тасок и сложным образом их обрабатывать. Мы этого хотим? Нет. ПОэтому единственной возможностью будет закрыть наряд на разность между текущим состоянием шахматки и теми объемами, что были в наряде.
8. Частичные оплаты очень сильно связаны с функционалом версионирования шахматки. Нам нужна будет настройка - как часто сохраняем состояние шахматки? По умолчанию каждый день. Или просто по нажатию кнопки "Зафиксирвоать текущую версию". Либо и ручное, и автосохранение работают вместе... Только ручное насчегда а автоматическое, например, 2 месяца. Тогда можно будет закрывать наряд на разницу между последним закрытым нарядом и любым из сохраненных состояний шахматки.
9. Пока что можно закрыть наряд на разницу между прошлым нарядом и 
10. Важный момент - расценки указываются индивидуально для каждого мастера
11. 


### Предложения по БД:
1. Разнести зафиксированную дочернюю-работу (это у нас строки в наряде) и живую дочернюю работу!
2. Наряд и нарядная дочерняя работа - не меняются
3. Родительская работа и простая дочерняя работа - меняются.
4. Таска должна иметь свой id, ссылаться на id родительской таски, содержать объем~~/расценки/всего_денег~~ на момент создания наряда и флаг "is_paid". Чуть ли не 4 полей должно хватить.

###  Action points:
1. Добавить единицу измерения "час" и список почасовых работ.
2. В таблицу с пользователями:
    1. добавить должность пользователя
    2. заменить три поля под ФИО на одно поле "full_name"
3. 











### Базовые функциональные требования

1. НАРЯД - у него тоже есть специфические поля:
    1. Нужны поля:
        1. Номер наряда
        2. Дата-время создания
        3. id создателя
        4. project_id
        5. Окончание расчетного периода (часто будет совпадать с полем "дата-время создания")
    2. Кажется, эти поля не нужны:
        1. Начало расчетного периода (оно всегда совпадает с окончанием расчетного периода предыдущей дочерней-таски! Поэтому будем брать оттуда джоином вместо того, чтобы следить, что в обоих полях консистентно лежит одно и то же)
        3. ФИО автора
        4. Должность автора
        5. Статус (сформирован, оплачен, удален)
        6. Название наряда
    3. Какие поля будут отображаться в списке нарядов:
        1. Номер
        2. Дата создания
        3. Дата создания предыдущего наряда по этой работе
        4. Автор (ФИО + Должность)
2. ЧАСТИЧНАЯ РАБОТА В ШАХМАТКЕ (то есть дочерняя таска~~, и оно же то, что в наряде у нас составляет одну строку - только статуса об оплате пока нема~~):
    1. Частичная работа не может же быть отрицательной! Поэтому чтобы не было казусов, пусть в полях отражается то что в текущем расчетном периоде будет учтено, если вдруг прям сейчас наряд закрыть. То есть мы про боковую панель говорим.
    2. ВАЖНО ОТЛИЧАТЬ ЧАСТИЧНУЮ РАБОТУ ОТ ЧАСТИЧНОЙ РАБОТЫ, ЗАФИКСИРОВАННОЙ В НАРЯДЕ. Первая должна держать id исполнителя и разные поля, такие как объем выполненных работ (а вот id работы, этажа и рум-группы все равно не поменяются), а вторая должна фиксануть чисто значения полей на момент подачи наряда. К сожалению, нужен дубль. Почему их нельзя объединять? Потому что что work_name и select-join name по work_id будут разными! Ну и что? Работу вообще нельзя пока менять. Зато можно удалять! И из нарядов оно пропадать не должно! Хотя бы поэтому.
    3. Нужны поля:
        1. id Исполнителя
        2. id РОДИТЕЛЬСКОЙ-ТАСКИ (а в ней же будут ссылки и на работу как в шахматке/ведомостях, и как в 1С заказчика, если надо, и единицы измерения, и дефектовка, и подтаскивание всех предыдущих частичных работ для высчитывания того, что готово)
        3. ~~Расценка - просто не нужна~~
        3. Объемы - которые он сделал
        4. is_Paid - была ли уже эта дочерняя-таска оплачена? Если true, то она старая. Если false, то это последняя актальная работка
            1. Надо отметить, что если наряд отпавляется в коризину, то присовокупленные таски должны:
                2. Либо нафиг удалиться, если нам неважно, кто и чего раньше делал.
                3. либо потерять статус is_Paid, если нам захочется потом как-то восстановить историю.
3. ЧАСТИЧНАЯ РАБОТА В НАРЯДЕ (~~то есть дочерняя таска, и оно же то, что~~ в наряде у нас составляет одну строку - только статуса об оплате пока нема):
    1. Сейчас в наряд попадут работы, у которых:
            1. в дочерней-задаче указан Исполнитель,
            2. в дочерней-задаче указан выполненный объём
            3. дочерняя-задача не попала в сформированные ранее наряды.
            4. Родительская-таска имеет рабочий статус «Завершено»???????? НЕТ! Скорее всего, статус должен быть "В работе". Потому что замечания оставляются раз в работа, а не каждую неделю. Ожидает дефектовку и проходит дефектовку работа тоже только один раз в работу, а не в частичную работу!
            14. id наряда, в которых он попал. Надо подумать. Попадание в наряд - хороший критерий оплаченности! Но и наличие закостенелого брата тоже хороший критерий оплаченности!
    1. Нужны поля:
        1. Исполнитель / Сотрудник - на момент формирования наряда
        2. Вид работ / Вид работ по ведомости - на момент формирования наряда (эти господа, вероятно, не меняются)
        3. Вид работ по 1С - потом потребуется - на момент формирования наряда (эти господа, вероятно, не меняются)
        4. Единица измерения - Выносятся отдельно ради сортировки и фильтрации - на момент формирования наряда (эти господа, вероятно, не меняются)
        5. Тип помещения (помещение) - на момент формирования наряда (эти господа, вероятно, не меняются)
        6. Этаж  - на момент формирования наряда (эти господа, вероятно, не меняются)
        7. Объем выполненных работ - на момент формирования наряда
        8. ВСЕГО - дефектовка  - на момент формирования наряда
        9. (Процентовка - высчитывается!)
        10. (Остаток - высчитывается!)
        11. Расценка - на момент формирования наряда
        12. (К выплате - высчитывается!)
        13. Свой собственный id
        14. id наряда, в которых он попал. Надо подумать. Попадание в наряд - хороший критерий оплаченности.
    2. Отметим, что все те поля, которые вероятно не меняются вообще завязаны на родительскую таску. Часть из них вообще справочники.
4. РАБОТА (РОДИТЕЛЬСКАЯ ТАСКА)
        1. id родительской таски - то есть свой id
        2. Помещение - строка, например "Квартира" / "МОП" / "ЛК" / "ЛХ" / "Вестибюль". Но, кстати, у нас оно указано отдельно и как имя, и как тип помещения
        3. Этаж
        4. Всего - дефектовка
        5. Имя работы как в ведомостях
        6. Имя работы как в 1С
        7. ~~project_id? - нет, нам достаточно этажа и помещения, которые привязаны каждый к project_id.~~
4. В нарядах должны быть сортировка и фильтрация. Пусть все будут по алфавиту, чтобы не париться. 
5. Процесс частичной оплаты работ!!!!!
6. Статусная модель по частичным работам.
7. Требования просто просмотреть и перелопатить.
8. Важный момент - расценки указываются индивидуально для каждого мастера
    

### Картинки

Как выглядит Наряд

Как выглядит Реестр на выплату


### Backlog

1. Добавить возможность редактировать "Название наряда" или прилепить ему поле "Комментарий".
2. Темы с импортом, с экспортом, со скачиванием xlsx и pdf. Печатные формы вообще работа с документами.

1. Мы все равно будем делать версионирование. Версия - слепок шахматки на момент времени. Закрываемый наряд (в том числе касательно частичных оплат) вычисляет разницу между нынешними объемами и теми, что отражены в наряде. Логичнее, и дальше будет понятно почему, сначала вычислять разницу всех значений шахматок (ну пока только объемы годятся), а потом уже обрамлять это типа в оболочку наряда. Очень нужно версионирование, потому что после него наряды, вполне вероятно, перекромсаются.
