To do:

> Необходимо добавить почасовые работы:
> - добавить в таблицу units единицу измерения "час"
> - добавить в список работ следующие 9 работ:
>   - Ремонт наливного пола ЛК (ЧАС)
>   - Монтаж панелей албес после демонтажа смежниками (ЧАС)
>   - Монтаж подрезков плитки и кабанчика (ЧАС)
>   - Зачеканка некратных мест (ЧАС)
>   - Замазка штроб и подрозетников (ЧАС)
>   - Подготовка под покраску калошницы ЛК (ЧАС)
>   - Мелкие работы по подвалу (ЧАС)
>   - Шлифовка ступеней ЛК (ЧАС)
>   - Реставрация (ЧАС) - данныq пункт обобщает все доработки/исправления работ после смежников, доделки мелкие, пусть тоже будет.

To do:

> - Расценки выставляются индивидуально для каждого мастера (БД, front, back).
> - При выдаче доступа из пользователей надо убрать Имя и Должность - в них нет смысла, они все равно заменятся системными, можно указывать только телефон.
> - При формировании наряда надо сделать фильтр по сдельным и почасовым работам - то есть "Фильтр по единицам измерения" для работ.
> - Файл наряда должен со временем стать pdf вместо xlsx, либо поддерживать оба формата.  
> - Процентовка в реестрах не нужна, а в нарядах нужна, так будет понимание по качеству.
> - В идеале, можно переименовать некоторые статусы тасок, т.к. названия немного нечитабельные и все разнородные, некоторые устарели.
> - В шахматке закрашенным образом нам хотелось бы видеть **прогресс по таске целиком** (а не прогресс по объему работ, выданных исполнителю на **текущую** неделю) - поэтому в полях "Выдано работ" и "Выполнено" хотим попросить пользователя поддерживать именно кумулятивну картину по работам.

To do:

> - Необходимо реализовать "Статус наряда" с возможностью для пользователя с правами "Редактирование" / "Владелец" их менять ("Сформирован" / "Оплачен" / "Удален"~~/ м.б. позже добавится "Отправлено на оплату"~~). 
> - Статус 'ReadytoPay' необходимо убрать из рабочих статусов тасок.
> - Для реализации частичной оплаты необходимо ввести (помимо существующего payment_report_task) сущность "подзадача" / sub-task, у которой будет свой_id + task_id + день календаря + статус ("Не оплачена" / "Оплачена") + ссылка на payment_report_task в состав которого она вошла. Эта сущность соответствует одному дню, когда исполнялась работа. Это атомарная временная величина измерения работы.
> - Таблица подзадач (сабтасок) актуализируется каждый раз при создании или смене статуса какого-либо наряда.
> - Таблица payment_report_task актуализируется каждый раз при создании или смене статуса какого-либо наряда.
> - При создании нового наряда по умолчанию статус наряда - "Не оплачен".
> - При создании нового наряда в первую очередь устанавливаются даты, за которые производится расчет.
> - Затем актуализируется таблица, содержащая саб-таски, - в нее добавляются строки, соответствующие всем работам в наряде и каждому дню в новом наряде (максимальное число = число дней * число работ), за вычетом тех строк, которые уже представлены в таблице в статусе "Не оплачена". 
> - При создании новой сабтаски по умолчанию статус сабтаски - "Не оплачена".
> - Затем определяются все саб-таски, которые имеют право войти в этот расчетный период - все только что добавленные, плюс все старые, которые попадают под выбранный список работ и выбранный диапазон дат. Они сначала назначаются какой-то определенной сущности payment_report_task (ее мы создаем прямо под наряд).
> - У payment_report_task нет статусов. Строки в таблице payment_report_task должны создаваться при создании наряда и оставаться такими, как в момент создания наряда, навсегда. Строки в payment_report_task пока не удаляются никак, даже когда наряд получает статус "Удален". 
> - При смене статуса наряда необходимо всегда производить проверку, что абсолютно все саб-таски в его составе все еще имеют статус "Не оплачена". Потому что если имеют какой-то другой, ВЕСЬ НАРЯД МОЖЕТ БЫТЬ ОТПРАВЛЕН на выброс.
> - Если статус наряда меняется на "Оплачен", всем сабтаскам в его составе проставляется статус "Оплачена".
> - Если статус наряда меняется на "Не оплачен", всем сабтаскам в его составе проставляется статус "Не оплачена".
> - Если статус наряда меняется на "Удален", всем сабтаскам в его составе проставляется статус "Удалена" ~~(возможно, их тогда надо просто совсем стирать, надо обсудить)~~.
> - Подзадачи (сабтаски, сущность для реализации частичных оплат), статус которых "Оплачена", будут высвечиваться в боковой панели интерфейса при работе пользователя с основными тасками.
> - Мы не хотим рождать наряды железобетонно только по неделям. Еще и неизвестно от пн до пн, или со среды до среды и пр., а может, на одной и той же стройке график сдвинулся. Поэтому даты в какой-то момент мы дадим выбирать пользователю. Пока что даты начала и конца система выставить автоматически - первая выставляется последним закрытым нарядом (или началом существования шахматки), а конечная - выставляется по сегодняшнему числу.
> - в payment_report_task у нас помечаются те таски, которые по датам идут не сплошняко
> - в payment_report_task у нас помечаются те таски, которые не полностью покрывают диапазон для наряда.


To do "Обучение пользователя":
> - Так как пользователь должен перед созданием наряда сам все интересующие его работы перевести в статус "Завершено", а также проставить объемы и исполнителей, хорошо бы его этому обучить.  
> - Необходимо обучение пользователя работе с фильтром по "сдельным" и "почасовым" работам (по единицам измерения).  
> - Пользователю надо объяснить, что в боковой панели он вводит не задание исполнителю на неделю, а общую цифру по всем исполнителям данной работы! Чтобы проще понимать прогресс по помещению, этажу, секции.

Сразу приведем корнер-кейс, который имеет смысл держать в виду по ходу дальнейшего рассуждения:  

> 1. ПРИМЕР КОЛЛИЗИИ, с которой система должна успешно справиться: 
>     - Пользователь закрыл наряд за 1-7 число месяца (статус наряда №1 "Оплачено).
>     - Пользователь закрыл наряд за 8-14 числа месяца (статус наряда №2 "Оплачено).
>     - Сегодня 22 число того же месяца. Пользователь закрывает наряд за 15-21 числа месяца (статус наряда №3 "Оплачено")
>     - Пользователь переводит наряд №2 в статус "Сформирован" или в статус "Удален".
>     - Итог: система должна не дать пользователю закрыть наряд за 8-21 число, ТОЛЬКО за 8-14! 
>     - Также если позволить создавать наряды в неограниченном количестве и не осуществлять поиск дублей для одного и того же дня: по каждому новому наряду будет создаваться груда подтасок, куча дублей.

Обработка коллизий в боковой панели, связанных с вводом статусов оплаты у нарядов/реестров (предложения):

> 2. Если часть работ оплачена, но пользователь хочет уменьшить в боковой панели объем **выполненной работы** до значения, которое меньше объемов, за которые уже заплачено:
>     - В момент сохранения данных для помещения нужна нотификация с обратной связью (в духе "У вас сейчас случится перерасход или введено ошибочное значение для объема выполненных работ"), так как система стала неконсистентна - пользователю нужно либо скорректировать данные по помещению, либо перевести статус одного из оплаченных реестров в notPaid;
>     - рядом с полем "Выполнено" теперь должен гореть знак, например, небольшой (!), подсвечивающий перерасход.
> 3. Если часть работ оплачена, но пользователь хочет уменьшить в боковой панели объем **дефектовки** до значения, которое меньше объемов, за которые уже заплачено:
>     - В момент сохранения данных для помещения возникает Нотификация "У вас перерасход или ошибка!";
>     - рядом с полем "Дефектовка" должен теперь гореть знак (!), подсвечивающий перерасход.

> Важный момент по определениям
> - элементарная работа (subtask) лежит в новой таблице subtask.
> - частичная работ (payment_report_task) лежит в существующей таблице payment_report_task.
> - работа (task) лежит в существующей таблице task.
> - наряды (payment_report) лежит в существующей таблице payment_report.
> Из важного - у элементарной работы будет статус и у нарядов будет статус. Оба про оплату, но немножко разные. Плюс останутся статусы у работ (task) - это совсем другое, про ход выполнения работ в нашем блокноте.

<br>

## Наряды и реестры на выплату. Частичное закрытие работ

## Введение

### Определения

1. **Наряд** - таблица, отражающая объёмы любых выполненных работ (сдельных, почасовых) за определенный период (обычно за последнюю неделю) одновременно по всем работникам в данной секции. Наряды закрывются технадзорами.  
2. **Реестр на выплату** - документ, формируемый по закрытии наряда руководителем координации - человеком, который их проверяет и уже сам отправляет в бухгалтерию - с указанием в нем сумм к выплате, например:

| ФИО                       | Начислено  | Удержано | Оплачено | К оплате  |
| ------------------------- | ---------- | -------- | -------- | --------- |
| Арутюнян Абдулла Саидович | 1 026,00   |          | 1 026    |           |
| Арутюнян Анна Иванована   | 197 097,80 |          |          | 197 097,8 |

В реестре на выплату:  
- ФИО каждого мастера/бригадира/подрядчика встречается 1 раз;  
- содержится информация только о причитающихся человеку суммах;  
- Имеет строку с подытогом по всем исполнителям.  

Далее реестр на выплату идет в бухгалтерию, в проводки.  

Работы бывают: **сдельными** (подавляющее большинство) и **почасовыми**. Почасовые работы, как правило, представлены мелкими доработками. К почасовым работам прибегают не на каждом объекте.  
Технически работу сдельщиков и часовщиков мы реализуем (в тасках, отчетах, нарядах, реестрах и пр.) одинаково - их разделение при закрытии нарядов реализуется через выставление соответствующих фильтров.

Каджая работа должна быть закончена и оплачена. Однако, она может делаться по частям (более одной недели) и даже каждую неделю иметь нового исполнителя. Процесс частичной оплаты труда иногда называют **процентовкой**, иногда - **частичным закрытием наряда**.

> Отметим, что в некоторых строительных организациях процентовку проводят раз в месяц, в некоторых строительных организациях частичная оплата труда производится каждую неделю (в пике это каждая пт), но если есть возможность строить отчеты по дням - мы не хотим терять эту аудиторию. Может быть, какие-то строители гаражей, сараев или каркасных домов захотят закрывать отчеты каждый день? Там главное, что текучка должна быть еще более жесткая, чем на стройке, а само строительство долгим...

### О реестрах, нарядах и отчетах

**Реестр на выплату**:

<img width="1000" alt="new list of orders" src="reestr.png">

"Реестр на выплату" - это финансовая выжимка на основе наряда.  
"Оплаченная часть работ" - связующее звено между нарядами и реестрами на выплату. Связь между нарядами и реестрами получается очень жесткой, поэтому реестр - просто форма представления наряда - основной сущности с детализацией.

**Пример наряда в процессе заполнения:**

| № | Дата подачи | Секция | Этаж | Тип помещения | Вид работ по ведомости | Вид работ по 1С | Выполненный объем | Всего | Остаток | Ед. изм | Исполнитель | Тип работы | Кол-во часов при по часовой работе|
|-|-|-|-|-|-|-|-|-|-|-|-|-|-|
|1|25.01.2023|Секция 2|7|Квартира|Шпатлевка стен|Подготовка под финишное покрытие стен (шпатлевка по ГКЛ) (Шпатлёвка стен по ГКЛ с грунтованием (МОП, Квартиры, СТК, и дверные перемычки))||120,58900|32,77600|м2| | | |
|2|25.01.2023|Секция 2|8|Квартира|Шпатлевка стен|Подготовка под финишное покрытие стен (шпатлевка по ж/б, штукатурке)/ шпаклевка с ошкуриванием||590,47600|0,00000|м2||||			
|47|25.01.2023|Секция 4|12|МОП|Укладка керамогранита на пол|Укладка керамогранита на пол|8,00000|78,20000|8,00000|м2|Петров Иван Сидорович|Сдельная||
|48|25.01.2023|Секция 4|9|МОП|Установка плинтуса из керамогранита|Установка плинтуса из керамогранита|82,00000|82,00000|0,00000|м.пог.|Петров Иван Сидорович|Сдельная||

**Отчет**

"Отчет" - это таблично-текстовая развертка всей актуальной информации о шахматке на текущий момент времени с сылками на актуальные работы, исполнителей и т. д. Периодов и дат нет.  

Сейчас нас будут интересовать только наряды. Отчеты уже реализованы, а Реестр на выплату может быть сгенерирован на базе Нарядов в последующих релизах.  

## Требования к НАРЯД (в рамках списка нарядов):

Одно из ключевых свойств наряда - его неизменность: никакие его данные невозможно редактировать, кроме Статуса ("Сформирован", "Оплачен", "Удален") и Названия (по умолчанию "Наряд № [3] от [24 января 2023]").  
В наряде нигде не используются ссылки на какие-либо сущности БД, потому что наряд - слепок определенного состояния шахматки за определенное время.  
В настоящее время удаление наряда пока невозможно ни из UI, ни напрямую из БД.  

### Атрибуты наряда

| №   | Название                 | Комментарий                                        | Изменяемое? |
| --- | ------------------------ | -------------------------------------------------- | ----------- |
| 1   | **Номер наряда**         | Натуральное число для удобства нумерации в UX      | -           |
| 2   | **Дата-время создания**  | Дата-время создания наряда                         | -           |
| 3   | **Начало периода**       | Поле "За период" - стартовая дата-время            | -           |
| 4   | **Окончание периода**    | Поле "За период" - дата-время окончания периода (пока совпадает с датой создания) | -           |
| 5   | **id создателя**         | uuid автора                                        | -           |
| 6   | **ФИО автора**           | Как автор наряда звался на момент создания наряда у себя в учетной записи (сейчас совпадает с именем, как отображается у владельца шахматки) | -           |
| 7   | **Должность автора**     | Как записано на момент создания наряда у автора наряда в учетной записи (сейчас совпадает с должностью, как отображается у владельца шахматки) | -           |
| 8   | **Статус**               | "Сформирован" / "Оплачен" / "Удален"               | YES         |
| 9   | **Название наряда**      | Текст в сободной форме, до 255 символов            | YES         |
| 10  | ~~**Дата оплаты**~~      |~~Пока нет смысла отслеживать~~                     | -           |
| 11  | ~~**Тип работ**~~        |~~Решили не разделять наряды по типу работ, используем фильтры~~     | -           |
| 12  | ~~**Ссылка на реестр**~~ | ~~Генерируется на основе данных того же наряда. Пока нам не нужен~~ | -           |
| 13  | **Секция (id объекта)**  | К какому объекту относится наряд (project_id) |

- Пока считаем, что дата создания наряда совпадает с конечной датой того периода времени, за который формируется наряд.
- Если будем делать просмотр "Реестров на выплату": вполне возможно сделать его по-другому, например, доступным изнутри конкретного наряда (но добавится лишний клик).   

<br>

**Как сейчас:**  

<img width="1000" alt="old list of orders" src="photo_2023-01-26_18-05-36.jpg">

**Пример реализации с учетом требований:**  

<img width="1000" alt="new list of orders" src="Frame 12.png">

<br>

## Требования к РАБОТА (отображение внутри наряда)

**Сейчас** наряд - это список работ, которые:
1. находятся в рабочем статусе «Завершено»,
2. у них указаны Исполнители,
3. у них указаны выполненные объёмы,
4. они **не попали в сформированные ранее наряды**.

> - Больше одного раза пользователь задачу в наряды положить не может;  
> - В помещении больше одной работы данного типа быть не может (и не надо).

**Требуется**, чтобы в наряды попадали работы, обладающие свойствами:
1. находятся в рабочем статусе «Завершено»,
2. у них указаны Исполнители,
3. у них указаны выполненные объёмы
4. в **объемах** выполненной работы есть **изменения относительно предыдущих закрытых нарядов** ("закрытый наряд" = находятся в статусе  "Оплачен" ~~или "Отправлен на оплату"~~). Говорим здесь только про поле "Объем" (изменения в полях "Всего" (дефектовка) или "Остаток" (что останется на следующую неделю) или сколько "Выдано" исполнителю или любых других системе безразличны).

> - Многократное попадание работы в разные наряды позволит не пересоздавать работу в случае частичного выполнения, а продолжить работу с той же сущностью.  

### Атрибуты работы

| №   | Название                                                        | Комментарий                                                                            | Изменяемое? |
| --- | --------------------------------------------------------------- | -------------------------------------------------------------------------------------- | ----------- |
| 1   | **Исполнитель** / **Сотрудник**                                 | ФИО мастера                                                                            | -           |
| 2   | **Вид работ** / **Вид работ по ведомости**                      | Как в шахматке (как у подрядчика)                                                      | -           |
| 3   | ~~**Вид работ по 1С**~~                                         | ~~Как в бухгалтерии у закачика, напр. у "ПИК"а - будет позже~~                         | -           |
| 4   | **Единица измерения**                                           | Выносятся отдельно ради сортировки и фильтрации                                        | -           |
| 5   | **Тип помещения**                                               | "Квартира" / "МОП" / "ЛК" / "ЛХ" / "Вестибюль"                                         | -           |
| 6   | **Этаж**                                                        | Storey                                                                                 | -           |
| 7   | **Помещение**                                                   | Она же "Ячейка". Иногда в ней пишут всякий ад: "Тамбур1,2,3" или "3,4,5,16эт 8кв" или "3-5,16кв8" или "МОП01,06" или "19-22, 28,30,31МОП", т.к. лень вводить одно и то же. У нас автозаполнение, здесь лежит наименование room group  | -           |
| 8   | **Объем** / **Объем выполненных работ** / **Выполненный объем** | ... мастером за последнюю неделю. Фиксирует технадзор.                                 | -           |
| 9   | **Всего**                                                       | Дефектовка перед началом работы. Данная цифра от наряда к наряду не должна меняться.   | -           |
| 10  | **Процентовка**                                                 | Значение, вычисляемое значение на основе полей "Объем" и "Всего" (отношение в %).      | -           |
| 11  | **Остаток**                                                     | Объем работ, который осталось сделать, начиная со следующей недели.                    | -           |
| 12  | **Расценка**                                                    | Удельная стоимость работы для данного исполнителя.                                     | -           |
| 13  | **К выплате**                                                   | Произведение расценки на объем.                                                        | -           |

<br>

**Как сейчас:**

**Шаг 1**:

<img width="1000" alt="old order" src="old_work.png">

**Шаг 2**:

<img width="1000" alt="old order" src="old_work_step_2.png">

<br>

**Пример реализации с учетом требований:**

**Шаг 1**:

<img width="1000" alt="new order" src="Frame 49.png">

На шаге 1 формирования наряда со временем надо отражать больше информации:
- **подтянуть последние 3 ссылки на предыдущие наряды по этому объекту, ушедшие на оплату**.
- **за какой диапазон дат создается наряд** (+ сколько в итоге дней накапало) - на основе данных последнего **закрытого наряда**.
- какой это объект (секция) - иначе распечатают и забудут
- кто создает
- ~~возможность задать имя~~
- **на данной иллюстрации не отрисованы фильтры, фильтры тоже должны быть**.

**Шаг 2**:

<img width="1000" alt="new order" src="Frame 48.png">

На шаге 2 внимание:
- договоренности по оплате с разными работниками разные!

**Шаг 3**:

<img width="1000" alt="new order" src="Frame 47.png">

У сформированного наряда
- можно изменять **Название**
- можно изменять **Статус оплаты**.
    - Если наряд имеет статус "Оплачен", то все подзадачи, входящие в него, имеют статус "Оплачена".
    - Если наряд имеет статус "Не оплачен" / "Сформирован", то все подзадачи, входящие в него, имеют статус "Не оплачена".
    - Если наряд имеет статус "Удален", то все подзадачи, входящие в него, имеют статус "Удалена".
- В будущих релизах будут отображены перерасходы.

Где-то в списках нарядов или в самом наряде (в статусах?) должна предоставляться возмножность "Удалить" наряд.  
Функционально между нарядом в статусе "Сформирован" и "Удален" нет никакой разницы, но отображение на фронте для пользователя нужно.  
Либо давайте дадим возможность жестко удалять наряды.

## Сортировка и фильтрация в нарядах

При создании наряда (называется пока "реестр на выплату", но это именно наряд):
- поддерживается **сортировка** на двух этапах:
    - при его создании на **Шаге 1** в списке работ-задач;
    - в готовом наряде.  
- поддерживается **фильтрация**:
    - при создании наряда на **Шаге 1** в списке работ:  
        - по месту проведения работ;
        - по исполнителю;
        - по работам;
        - по единицам измерения.

По какому принципу осуществляется сортировка:

| N   | Поле таблицы               | Принцип                       |
| --- | -------------------------- | ----------------------------- |
| 1   | **Исполнитель**            | По алфавиту: ASC, DESC        |
| 2   | **Вид работ по ведомости** | По алфавиту: ASC, DESC        |
| 3   | **Вид работ по 1С**        | По алфавиту: ASC, DESC        |
| 4   | **Этаж**                   | по полю *level*               |
| 5   | **Помещение**              | по полю *number*              |
| 6   | **Тип помещения**          | По алфавиту: ASC, DESC        |
| 7   | **Объем**                  | алф (числа)                   |
| 8   | **Всего**                  | алф (числа)                   |
| 9   | **Процентовка**            | алф (числа)                   |
| 10  | **Остаток**                | алф (числа)                   |
| 11  | **Единица измерения**      | По id (если не придем к uuid) |
| 12  | **Расценка**               | алф (числа)                   |
| 13  | **К выплате**              | алф (числа)                   |


## Частичная оплата работ

1. Мы не принуждаем пользователя отчитываться строго по неделям. Ему могут быть удобны расчеты и раз в 2 недели, и раз в месяц, и другие кратные неделе периоды.
2. Даже если итерироваться по неделям, мы не знаем, по ПН у пользователя отчетность, по ПТ или еще когда-то. На одном и том же проекте сроки отчетности могут сдвинуться.
3. Мы не хотим случайно потерять аудиторию, которая по каким-то причинам работает 2х2, рассчитывается каждый день или использует еще какой-то нестандартный график.
4. Это подталкивает к тому, что рано или поздно **пользователь сможет выставлять даты отчетного периода произвольным образом**.  

> Такая свобода приводит к колизиям. Пример:  
> Коллега закрывает наряд за пн-ср, потом основной пользователь закрывает пн-пт и отправляет на оплату; позже коллега также отправляет свой наряд на оплату. В подобных случаях информация в проводках бухгалтерии имеет шанс задублироваться - и в целом столь неосмотрительное поведение может разочаровать пользователя.   
> Предлагается осуществлять дополнительные проверки при формировании нарядов и при отображении оплаченных работ в боковой панели в шахматке.

**Для поддержки частичной оплаты работ реализуем структуру, поддерживающую вложенность "частичных работ" в "основные работы".**

> На верхнем уровне можно найти несколько подходов, например:
> - Каждую неделю все текущие таски закрываются и пересоздаются таски на остаток - но тогда раз в неделю вся шахматка будет целиком принудительно обновляться (будет сложно версионировать? сложно читать логи? сложно проводить аналитику? зато не нужно вводить новые сущности).
> - Разделить сущности - "работа" и "частичная работа", причем первая - "пустой контейнер", в котором всегда лежит как минимум одна частичная работа, а вторая - основная сущность со всеми статусами: "Ожидает дефектовку"/.../.../.../"Завершено"/"Готово к оплате". Таска только собирает подзадачи вместе, обеспечивая читаемость процессов, а подзадача (саб-таска) все так же пересоздается каждую неделю с закрытием наряда.
> - Разделить сущности - "работа" и "частичная работа", причем **вложенной подтаске делегировать только статус оплаты**, оставив остальные свойства за основной таской.  

> **Идем по третьему пути**.  
> Структура уже существующей таблицы **payment_report_task** дополнительно подталкивает к этому.    

> Еще остаются проблемы, которые придется решить: 
> - В одной и той же шахматке создаются по каждому новому наряду множество "частичных работ", пересекающихся друг с другом по нескольким дням или (часто) вообще полностью дублирующие друг друга. Если частичная работа попала в разные наряды с разными статусами, то какой статус побеждает? Самый последний? Самый оплаченный?
> - Если часть работ в наряде уже была кем-то оплачена, весь наряд идет насмарку, его надо пересоздавать (благо, это несложно). Лечится это обучением пользователя - созданный наряд желательно сразу же переводить в статус "Оплачено", если не хотите, чтобы коллеги сделали ваш наряд устаревшим. Печать, подпись - все потом.

В общем-то смысл всего происходящего вкратце - использовать знания об оплатах по данной работе в боковой панели интерфейса в шахматке (для лимитов).

Пересоздание тасок на остаток - реально дешевая альтернатива, укладывающаяся в нашу философию предоставления свободы пользователю.

Однако если таски на остаток не пересоздавать, сейчас нет привязки ни к каким датам. В один и тот же день можно создать кучу новых нарядов, в которых появились изменения относительно предыдущих закрытых нарядов.  

**Необходимо ввести элементарную работу и однозначно идентифицировать ее сквозным образом через всю систему** - нужна уникальная сущность для *работы в данный день в данном помещении*.  

Будем считать, что меньше, чем один день, работа длиться не может. **Тогда для каждого календарного дня и для каждой таски существует только одна элементарная работа.**

В дальнейшем обсуждении будут задействованы 5 таблиц, 3 из которых уже существуют, а предлагается 2 добавить, и они имеют очень простую структуру.  

Существуют: **payment_report**, **task** и связывающая их **payment_report_task**.  
Необходимо создать **subtask** и связывающую ее частичными работами **subtask_payment_report_task**.

### SUBTASK - элементарная работа (новая таблица)

Сущность соответствует одному дню конкретной работы. Предлагаемые поля:

| Имя                    | Комментарий                                                    | unique? | null?    | type |
| ---------------------- | -------------------------------------------------------------- | ------- | -------- | ---- |
| subtask_id             | Первичный ключ                                                 | unique  | not null | uuid |
| task_id                | Частью какой таски (работы, задачи) является данная подзадача  | -       | not null | uuid |
| date                   | Дата, когда производилась работа                               | -       | not null | date |
| статус / is_paid       | Был ли этот день по данной работе оплачен                      | -       | not null | bool |

Одна такая элементарная работа может попасть во многие частичные работы, то есть строки payment_report_task (и она будет это делать до тех пор, пока какой-нибудь из нарядов не перейдет с статус "Оплачен", проставив этой связанной элементарной работе статус is_paid = true).

### SUBTASK_PAYMENT_REPORT_TASK - связь элементарных и частичных работ (новая таблица)

У **payment_report_task** и **subtask** соотношение многие-ко-многим. Значит, потребуется таблица для их соединения:

| Имя                    | Комментарий                       | unique? | null?    | type |
| ---------------------- | --------------------------------- | ------- | -------- | ---- |
| sprt_id                | Первичный ключ для связи          | unique  | not null | uuid |
| subtask_id             | Идентификатор элементарной работы | -       | not null | uuid |
| payment_report_task_id | Идентификатор частичной работы    | -       | not null | uuid |

### PAYMENT_REPORT_TASK - частичная работа (таблица уже существует)

Сущность соответствует отдельной строке в наряде (оплаченного, не оплаченного, удалённого - все равно) и возникает при создании наряда. Нужна в том числе для фильтрации и сортировки работ в наряде и в целом является неотъемлемой структурной частью наряда.  

> У частичных работ нет статусов - в каком-то смысле их можно получить join'ами из нарядов (payment_order), к которым они относятся.  
> Дату начала и дату окончания расчетного периода для частичных работ также нужно доставать join'ами из родительского наряда.

При создании payment_report_task в нее войдут те элементарные работы, которые:
- имеют тот task_id, какой нас интересует (из текущего состояния шахматки);
- попадают в диапазон дат (из наряда),
- которые еще не были оплачены (их поле is_paid = false).

Создается новый наряд:  
0. При создании наряда на старте нам известны id всех тасок шахматки. Из их числа мы выбираем завершенные, с объемами, с исполнителями. Осталось отбросить уже оплаченные работы. Для этого:
1. Вычисляются даты для наряда либо пользователь вводит их руками.
2. Из таблицы с элементарными работами система получает выборку всех саб-тасок с подходящими датами и одновременно прикрепленных к нужным нам task_id (посредством частичных работ) и статус которых is_paid = false, сгруппировать по task_id и посчитать число вошедших дней.
3. Создать новый наряд
4. Создать новые строки в payment_report_task со всеми интересующими нас параметрами на базе числа пока неоплаченных дней, связать наряд с частичными работами, которые в него войдут.
5. Связать выбранные элементарные работы с частичными работами.

Наряду проставляют статус "Оплачен":  
1. Система проверяет, можно ли перевести наряд в статус "Оплачен" - все частичные работы внутри него должны быть полностью НЕ ОПЛАЧЕННЫМИ - это выясняется через неоплаченность всех связанных с ними элементарных работ, иначе нотификация "Наряд содержит оплаченные ранее работы. Предыдущую оплату нужно аннулировать или этот наряд надо удалить".
2. Всем элементарным работам, связанным с этим нарядом через частичные работа, проставляем статус is_paid = true
3. Определить пул тех частичных работ, которые содержали в себе дни, только что ставшие оплаченными, и всем нарядам, связанным с этими частичными работами проставить статус "Удален".

Наряду обратно проставляют статус "Сформирован":
1. Система требует подтверждения от пользователя - осознанно ли он подходит к данному вопросу
2. Всем элементарным работам в составе частичных работ в составе наряда - статус не оплачена

Наряду проставляют статус "Удален": 
Не отличается от "Сформирова" кроме визуальной составляющей. В этот статус попадают заранее бракованные наряды - содержащие уже оплаченные работы.

> И если что, всегда можно создать наряд с начала времен по сей день - он соберет в себя все случайно потерявшиеся таски.

```sql
select
task_id
from subtask
where
  date > last_prev_closed_payment_date and
  date < now() and
  task_id = task_id_from_chess and
  is_paid = false
```

**Атрибуты payment_report_task** (корректировка) 

Вообще ничего не меняем, так норм

| Имя                         | Комментарий                                                                     | unique? | null?    | type         |
| --------------------------- | ------------------------------------------------------------------------------- | ------- | -------- | ------------ |
| payment_report_task_id      | Первичный ключ                                                                  | unique  | not null | uuid         |
| work_name                   | Наименование работ, как было на момент формирования родительского наряда        | -       | not null | varchar(255) |
| storey_number (storey_name) | Название или номер этажа как было на момент формирования наряда (строка)        | -       | not null | varchar(255) |
| room_group_name             | Название или номер помещения как было на момент формирования наряда (строка)    | -       | not null | varchar(255) |
| executor_user_full_name     | ФИО исполнителя как было на момент формирования наряда (строка)                 | -       | not null | varchar(255) |
| volume                      | Объем работ, вычисленный для наряда                                             | -       | not null | float4       |
| total_price                 | Сумма к выплате для данного исполнителя по данному куску работы                 | -       | -        | float4       |
| task_id                     | uuid работы-таски, на базе которой создается частичная работа в наряд           | -       | not null | uuid         |
| payment_report_id           | uuid родительского наряда                                                       | -       | not null | uuid         |
| unit_id                     | uuid единицы измерения - оставляем id, потому что единицы измерения неизменяемы | -       | not null | uuid         |



<br>

Когда наряд получает статус "Оплачен" происходит апдейт статусов элементарных работ:

```sql
update subtask
set is_paid = true
where 
  (select с выбором всех тасок, которые относятся к payment_report, получившему статус "Оплачен", через payment_report_task)
returning *;
```

### - Атрибуты payment_report_task

Приведем также структуру **payment_report**, раз ее тоже минорные обновления:

| Имя                    | Комментарий                                                                      | unique? | null?    | type         |
| ---------------------- | -------------------------------------------------------------------------------- | ------- | -------- | ------------ |
| payment_report_id      | Первичный ключ наряда                                                            |         |          |              |
| status                 | Статус (по умолчанию "Сформирован"/'unPaid'). Еще может быть 'deleted' и 'paid'. |         |          |              |
| created                | Дата создания                                                                    |         |          |              |
| updated                | Дата последнего обновления???                                                    |         |          |              |
| ~~author_id~~          | ~~идентификатор создателя наряда~~                                               |         |          |              |
| code_number            | Порядковый номер наряда в UX                                                     |         |          |              |
| project_id             | uuid объекта (секции)                                                            |         |          |              |
| **report_start_date**  | **Начало расчетного периода (NEW)**                                              | -       | not null | timestamptz  |
| **report_finish_date** | **Конец расчетного периода (NEW)**                                               | -       | not null | timestamptz  |
| **name**               | **Название/Комментарий (NEW)**                                                   | -       | not null | varchar(255) |
| **author_full_name**   | **ФИО автора на момент создания наряда (NEW)**                                   | -       | not null | varchar(255) |
| **job_title**          | **Должность автора на момент создания наряда (NEW)**                             | -       | not null | varchar(255) |

<br>

<br>

## Статусы их всех троих (работ, частичных работ, элементарных работ)

Взаимосвязь **статуса оплаты** со **статусом выполнения** работ отсутствует.  

Внутри каждого из статусов разрешены переходы из любого состояния в любое состояние. Переходы сейчас осуществляются пользователем вручную.


- 1 **Статус выполнения** работ (**progress-status** у таски):

| Значение поля status              | Комментарий                     |
| --------------------------------- | ------------------------------- |
| 'volumeEdit'                      | 'Ожидает дефектовку'            |
| 'draft'                           | 'Готово к работе'               |
| 'inProgress'                      | 'В работе'                      |
| 'readyToCheckTechnicalSupervisor' | 'Ожидает технадзор'             |
| 'hasRevisions'                    | 'Есть замечания'                |
| 'completed'                       | 'Завершено'                     |

- 2.1 **Статус оплаты** (**payment-status**) для элементарной работы для **subtask**, поле 'is_paid':  

| Значение поля is_paid | UI                                                                                      |
| --------------------- | --------------------------------------------------------------------------------------- |
| true                  | Данная частичная работа (определенное наименование работ в определенный день) оплачена. |
| false                 | Данная частичная работа была проведена, но еще не была оплачена.                        |  

- 2.2 **Статус оплаты** (**payment-status**) частичных работ для **payment_report_task**:

У частичных работ нет статусов - их надо смотреть join'ами от нарядов, в рамках которых они созданы (payment_order). Аналогичная история с датами расчетного периода.

- 2.2 **Статус оплаты** (**payment-status**) нарядов **payment_report**, поле 'status':

| Значение поля status  | UI                                                                                     |  
| --------------------- | -------------------------------------------------------------------------------------- |
| 'notPaid'        | 'Сформирован' - частичная работа еще не оплачена. Дефолтное состояние при формирования наряда. |
| ~~'readyToPay'~~ | ~~'Отправлен на оплату' (потребуется ближе к 1С, но можно и сразу внедрить). По прикладному смыслу не отличается от 'paid'.~~ |
| 'paid'           | 'Оплачен' - пользователь переводит наряд в этот статус пока вручную. Все элементарные работы, до которых наряд сможет дотянуться, становятся со статусом 'is_paid' = true. При смене статуса наряда на любой другой статус из этого списка - все элементарные работы, до которых наряд сможет дотянуться, получают статус 'is_paid' = false. ~~При интеграйции с 1С факт оплаты сможет проставляться автомтачиеки.~~ | 
| 'deleted'        | 'Удален' - статус отчасти избыточный. Нужен только для front-end, чтобы пользователю отметить откровенно не нужные ему наряды - черновики и наряды, содержащие в которых часть работ оплачена. |  

### Атрибуты payment_report_task

К полям таблицы payment_report_task, как минимум, необходимо добавить статус оплаты, чтобы при отображении лимитов и перерасходов в боковой панели пользователя учитывать только реально состоявшиеся в бухгалтерии проводки.
Какая информация требуется для корректного описания payment_report_task:

| Имя                   | Комментарий                                                                                                                                                             |
| --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| task_id               | По какой работе (задаче, таске) выполняются взаиморасчеты? Должна удаляться при удалении соответствующей таски.                                                         |
| ~~work_id~~           | ~~id работы~~                                                                                                                                                           |
| ~~price_id~~          | ~~id расценки за работу на момент проведения взаиморасчетов~~                                                                                                           |
| ~~payment_date~~   | ~~Дата проведения оплаты может не совпасть с датой формирования наряда и не совпасть с датой окончания расчетного периода, но первые две нам по-настоящему, не интересны~~ |
| ~~worker_id или user_id~~ | ~~Зависит от очередности реализации нами данной фичи и работы с пользователями и доступами - сейчас user_id, но по-хорошему сразу должен быть worker_id~~           |
| work_name             | Наименование работ                                                                                                                                                      |
| worker_name           | ФИО исполнителя                                                                                                                                                         |
| volume                | Объем произведенных работ (как записано в родительской таске на момент подачи наряда на оплату МИНУС все предыдущие оплаченные объемы)                                  |
| total_price           | Общая сумма выплат за проведенную работу. Расценку на момент проведения взаиморасчетов можно вычислить отсюда.                                                          |
| status                | Статус, отоображающий, была ли данная часть работы уже в реальности оплачена или нет ("Сформирована" / "Оплачена")                                                      |

А вот зачем в payment_report_task нужны комната и этаж - не понятно. Нам вроде бы всегда достаточно id таски для всех задач (нет функционала отвязки таски от объекта, этажа, комнаты)

### - Отображение оплаченных payment_report_task нужно в боковой панели шахматки для корректного подсчета лимитов.

## Требования

1. Пользователь с правами доступа "Редактирование" или "Владелец" может создать новый наряд. Заполняемые атрибуты нового наряда:
    - Номер наряда
    - Дата-время создания (пока совпадает с окончанием расчетного периоа)
    - Начало расчетного периода:
        - проставляется системой автоматически по последнему закрытому наряду;
    - Окончание расчетного периода:
        - проставляется системой автоматически - сейчас текущая дата;
    - author_id - идентификатор создателя
    - ФИО автора
    - Должность автора
    - Статус (по умолчанию "Сформирован")
    - Секция (id объекта)
    - Название
2. Пользователь с правами доступа "Редактирование" или "Владелец" может менять статус наряда:
    - "Сформирован", "Оплачен", "Удален".
    - Нужна кнопка для смены статуса наряда "Оплачен".
3. По умолчанию саб-таски (элементарные работы) имеют статус "Не оплачена".
4. Если наряд имеет статус оплачено, то все саб-таски, входящие в него, имеют статус "Оплачена".
5. Пользователь с правами доступа "Редактирование" или "Владелец" может редактировать название наряда:
    - название по умолчанию "Наряд № (3) от (24 января 2023)".
    - По умолчанию "Комментарий" / "Имя наряда" будет "Реестр на выплату № ХХХХХ от YYYY января 2023".
6. Пользователь с правами доступа "Чтение", "Редактирование" или "Владелец" может просматривать список всех нарядов, прикрепленных к данной шахматке (т. е., секции, объекту) с возможностью сортировки.
7. Пользователь с правами доступа "Чтение"/"Редактирование"/"Владелец" может просматривать наряды данной шахматки с осуществлением сортировки данных
8. Взаимосвязи статусов друг с другом нет: разрешены переходы из любого состояния в любое состояние.

При создании нового наряда:  

9. Система должна предоставлять пользователю возможность быстро сбросить все фильтры вместе.  
10. Система должна предоставлять пользователю возможность быстро сбросить каждый из фильтров по отдельности.  
11. Система должна предоставлять пользователю возможность добавить работы, которые он видит, к списку выбранных.  
12. Система должна отображать корректное число работ, выбранных пользователем даже если он видит сейчас их отфильтрованную выдачу.  
13. Система должна позволять пользователю установить расценки для каждой из работ индивидуально для каждого исполнителя - из числа связанных с выбранными задачами (Если мы нашли 50 задач за эту неделю, и они все относятся к одному из 15 наименований работ и были выполнены одним из 5 исполнителей, то максимум, сколько расценок нам система предложит внести - это min(15*5, 50) = 50 расценок). Из декартова произведения выживают только те, которые друг с другом связаны через реальную задачу в наряде.  
14. При запросе расценок у пользователя система предзаполняет все расценки, которые может, на основе раанее введенных данных данных.  
15. После подтверждения пользователем расценок, они обновляются в базе и в текущем наряде для данного наименования работ и данного исполнителя.  

Доп. требования по работам и частичному закрытию работ

16. Если дефектовка не указана или выданный объем работ не указан, то значения атрибутов работ "Процентовка", "Всего", "Остаток" недоступны.
17. Для почасовых работ в наряде поля "Процентовка", "Всего", "Остаток" всегда недоступны.
18. В боковой панели, если работа выбрана почасовая, а значение поля "Всего" заполнено, рядом должна гореть подсказка, что для почасовых работ нет плана.
19. Если у нас перерасход (Значение поля "Объем" больше значения поля "Всего"), наряд должен это отражать - соответствующая работа должна быть подсвечена (красным)? Тем не менее, в наряд такие работы попасть обязательно должны, как и все остальные, если новый объем работ у нас больше, чем объем работ в последнем созданном наряде. 
20. В нардяы попадают только работы в статусе "Завершено" (пользователь руками проставляет).  
21. Взаимосвязи **статуса оплаты** со с**татусом выполнения** работ нет.  
22. Внутри каждого из статусов разрешены переходы из любого состояния в любое состояние.

23. Если работа находится в статусе выполнения «Завершено», это не значит, что потом нельзя ее перевести в другой статус. Можно - в любой.  
24. При этом перевод статусов оплаты должен быть строгим (то есть перевод статуса наряда, вместе со всеми его подтасками)! При смене статуса наряда руками дожна вылезать модалка с подтерждением (или должен быть оч. строгий сопровождающий текст) - мол работы этого наряда будут учитываться как получившие полную или частичную оплату! А если отменяем статус оплачено: работы этого наряда больше не будут считаться оплаченными, что повлечет мол за собой недоразумения и коллизии различные в шахматке и боковой панели.
25. Все сабтаски должны удалаться при удалении родительской таски.

26. Номер наряда - для каждого нового наряда это следующее натуральное число.
27. Если когда-либо будет реализовано удаление наряда (жесткое), все равно номер продолжает возрастать по отношению к максимальному текущему номеру среди существующих нарядов для данного объекта.
28. При смене данных шамхатки, тасок, пользователей и пр. данные в наряде никогда не меняются.
29. При пролистывании наряд вниз заголовки таблицы должны прилипнуть к верхней части экрана.
30. Ссылка для скачивания реестра на выплату должна быть прицеплена к каждому конкретному наряду.

Пока считаем, что дата создания наряда совпадает с конечной датой того периода времени, за который формируется наряд.
**Из минусов - такой подход каждому новому наряду будет создавать груду подтасок.**

Будущие релизы:
- Наряды можно скачать:
    - в pdf
    - в xlsx
- Реестр на выплату можно скачать:
    - в pdf
    - в xlsx
- Наряд должен подсвечивать перерасходы (и возможно вообще статус готовности отображать)

---

**P.S.**
Обычно:  
1. **Заказ-наряд (наряд)** - формируемый перед началом работ документ, содержащий название-описание предстоящих работ для конкретного работника (обычно на ближайшую неделю), в которой ставится его подпись и подпись выдавшего работу начальника (прораба, мастера участка). В конце, после выполнения работ, подпись в наряде также ставит приемщик работ (технадзор) и в конце кто-то из бухгалтерии. Наряд - это срез вдоль работ в определенный момент времени.  
Обычно в ПИК эта формальная процедура опускается: наряды раздаются людям в устрой форме в штабе.  
2. **Табель** - таблица учета почасовых (поденных, повременных и пр.) работ; вид работа один и тот же. Табель - это срез вдоль времени для конкретной работы. Также табель - это уже закрытый график по часам за период.  
3. На основании наряда или табеля в 1С создаются **ведомости на счета** ("ведомость на выплату заработной платы на счета сотрудников") и **начисления**.

> В нарядах для каждого помещения необходимо отразить тип помещения. Но пользователь может указывать их самостоятельно - строкой! Поэтому ничего не делаем:
> - "Квартира",
> - "МОП",
> - "ЛК",
> - "ЛХ",
> - "Вестибюль".

> Не принципиально, как хранить всю конструкцию в БД - создать ли отдельную таблицу под саб-таски с полем под родительскую таску; создать ли отдельную таблицу для связей таски-сабтаски; просто хранить одну таблицу с "транзакциями" оплат. Необходимо обсуждение? 
> В любом случае возникает много коллизий, связанных с пересечением дат.

мусор ~~Требования чисто по частичным оплатам:~~

1. ~~Если у сабтаски (элементарной работы) есть из-за какого-то наряда положительный статус об оплате, ее больше нельзя включить ни в один наряд~~!
5. У саб-таски есть конкретный день, за который она отвечает, и конкретная работа (таска), за которую она отвечает. у саб-таски должна быть элементарная единица измерения труда и оплаты. Это день. 
4. При создании наряда сначала устанавливаются даты, за которые наряд будет сформирован.
10. Каждый раз при создании наряда у нас на базе неоплаченных саб-тасок формируются строки для таблицы payment_report_task.
11. ~~Как только статус для наряда становится оплаченным, а значит, оплаченным становится payment_report_task, всем прикрепленным к нему саб-таскам тоже выставляется статус оплачено.~~
26. Подзадачи (сабтаски, сущность для реализации частичных оплат), статус которых "оплачена", будут высвечиваться в боковой панели интерфейса при работе пользователя с тасками (лимитами).
27. Если когда-то будет поддержка алиасов для пользователей - а нарядах нам все равно нужно сквозное отображение авторов - все редакторы друг друга должны все идентифицировать однозначно. Это поинт в пользу того, что вообще не нужны нам алиасы.




---

<br>

---


