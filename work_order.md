> В нарядах для каждого помещения необходимо отразить тип помещения:
> - "Квартира",
> - "МОП",
> - "ЛК",
> - "ЛХ",
> - "Вестибюль".

> Необходимо добавить почасовые работы:
> - добавить в таблицу units единицу измерения "час"
> - добавить в список работ следующие 9 работ:
>   - Ремонт наливного пола ЛК (ЧАС)
>   - Монтаж панелей албес после демонтажа смежниками (ЧАС)
>   - Монтаж подрезков плитки и кабанчика (ЧАС)
>   - Зачеканка некратных мест (ЧАС)
>   - Замазка штроб и подрозетников (ЧАС)
>   - Подготовка под покраску калошницы ЛК (ЧАС)
>   - Мелкие работы по подвалу (ЧАС)
>   - Шлифовка ступеней ЛК (ЧАС)
>   - Реставрация (ЧАС) - данные пункт обобщает все доработки/исправления работ после смежников, доделки мелкие.

> - Важно: расценки - индивидуальная вещь! Нужно новое поле и некоторые переработки на фронте и на бэке.
> - При выдаче доступа из пользователей надо убрать Имя и Должность - в них нет смысла, можно просто указать телефон. 
> - реализовать "статусы наряда" с возмоностью пользователю их мернять. 
> - ReadytoPay нужно убрать из рабочих статусов тасок.
> - Для реализации частичной оплаты еобходимо ввести новую сущность с отдельным статусом об оплате: "Не оплачено", "Отправлено на оплате", "Оплачено".   
> - Так как пользователь должен перед созданием наряда сам все интересующие его работы перевести в статус "Завершено" - хорошо бы его этому прямо обучить.  
> - Обучение по фильтрам по "сдельным" и "почасовым" работам.  
> - Файл наряда должен со временем стать pdf вместо xlsx.   
> - Процентовка в реестрах не нужна, а вот в нарядах вполне да, так будет понимание по качеству
> - В идеале, надо переименовать некоторые статусы тасок - некоторые из них нечитабельные. Но это жирок.
 
> Обработка коллизий, связанный с вводом статусов оплаты у нарядов/реестров:
> - Если часть работ оплачена, но пользователь хочет уменьшить или уже уменьшил в боковой панели объем выполненной работы:
>     - В момент сохранения данных боковой панели для помещения, Нотификация с обратной связью ("У вас перерасход!"), так как система либо неконсистентна - пользователю нужно либо скорректировать данные по помещению, либо перевести статус одного из оплаченных реестров в notPaid);
>     - рядом с полем "Выполнено" должен гореть знак, например, небольшой (!), подсвечивающий перерасход.
> - Если часть работ оплачена, но пользователь хочет уменьшить или уже уменьшил в боковой панели объем дефектовки:
>     - В момент сохранения данных боковой панели для помещения возникает Нотификация "У вас перерасход!";
>     - рядом с полем "Дефектовка" должен гореть знак, например, небольшой (!), подсвечивающий перерасход.

## Наряды и реестры на выплату. Частичное закрытие работ

## Введение и определения

1. **Наряд** - таблица, отражающая объёмы любых выполненных работ (сдельных, почасовых) за определенный период (обычно за последнюю неделю) одновременно по всем работникам в данной секции. Наряды закрывются технадзорами.  
2. **Реестр на выплату** - документ, формируемый по закрытии наряда руководителем координации - человеком, который их проверяет и уже сам отправляет в бухгалтерию - с указанием в нем сумм к выплате, например:

| ФИО                       | Начислено  | Удержано | Оплачено | К оплате  |
| ------------------------- | ---------- | -------- | -------- | --------- |
| Арутюнян Абдулла Саидович | 1 026,00   |          | 1 026    |           |
| Арутюнян Анна Иванована   | 197 097,80 |          |          | 197 097,8 |

В реестре на выплату:  
- ФИО каждого мастера/бригадира/подрядчика встречается 1 раз;  
- содержится информация только о причитающихся человеку суммах;  
- Имеет строку с подытогом по всем сотрудника.  

Далее реестр на выплату идет в бухгалтерию, в проводки.  

Работы бывают: **сдельными** (подавляющее большинство) и **почасовыми**. Почасовые работы, как правило, представлены мелкими доработками. Почасовые работы представлены не всегда. Технически мы реализуем работу сдельщиков и часовщиков (в тасках, отчетах, нарядах, реестрах и пр.) одинаково. Их разделение реализуется через выставление правильных фильтров при закрытии нарядов.

Каджая работа должна быть закончена и оплачена. Однако, она может делаться по частям (более одной недели), а также каждую неделю иметь нового исполнителя. Процесс частичной оплаты труда иногда называют **процентовкой**, а иногда - **частичным закрытием наряда**.

---

## Лирическое отступление о реестрах, нарядах и отчетах

### Как должен выглядеть Реестр на выплату:

<img width="1000" alt="new list of orders" src="reestr.png">

"Реестр на выплату" - это финансовая выжимка на основе наряда.  
"Оплаченность" важна именно в разрезе какой-то определенной работы или части этой работы, поэтомусвязь нарядов с реестрами на выплату должна быть железная, то есть реестр - это скорее просто форма представления наряда - основной сущности с детализацией ~~и ссылками на реально выполненными частичными работами в БД~~.

### Как выглядит Наряд в процессе заполнения:

| № | Дата подачи | Секция | Этаж | Тип помещения | Вид работ по ведомости | Вид работ по 1С | Выполненный объем | Всего | Остаток | Ед. изм | Исполнитель | Тип работы | Кол-во часов при по часовой работе|
|-|-|-|-|-|-|-|-|-|-|-|-|-|-|
|1|25.01.2023|Секция 2|7|Квартира|Шпатлевка стен|Подготовка под финишное покрытие стен (шпатлевка по ГКЛ) (Шпатлёвка стен по ГКЛ с грунтованием (МОП, Квартиры, СТК, и дверные перемычки))||120,58900|32,77600|м2| | | |
|2|25.01.2023|Секция 2|8|Квартира|Шпатлевка стен|Подготовка под финишное покрытие стен (шпатлевка по ж/б, штукатурке)/ шпаклевка с ошкуриванием||590,47600|0,00000|м2||||			
|47|25.01.2023|Секция 4|12|МОП|Укладка керамогранита на пол|Укладка керамогранита на пол|8,00000|78,20000|8,00000|м2|Петров Иван Сидорович|Сдельная||
|48|25.01.2023|Секция 4|9|МОП|Установка плинтуса из керамогранита|Установка плинтуса из керамогранита|82,00000|82,00000|0,00000|м.пог.|Петров Иван Сидорович|Сдельная||

### Об отчетах

Отчет - таблично-текстовая развертка шахматки на текущий момент времени с сылками на актуальные работы. Никаких периодов нет. 

<br>

---

<br>

## Требования к НАРЯД (в рамках списка нарядов):

### Атрибуты наряда

Одно из ключевых свойств наряда - его неизменяемость. Никакие его данные невозможно редактировать, кроме статуса ("Сформирован", "Оплачен", "Удален") и названия (по умолчанию "Наряд № (3) от (24 января 2023)"). В наряде нигде не используются ссылки на какие-либо сущности базы данных. Наряд - слепок определенного состояния шахматки за определенное время.  
В настоящее время удаление наряда (из БД) невозможно.  

| №   | Название                 | Комментарий                                        | Изменяемое? |
| --- | ------------------------ | -------------------------------------------------- | ----------- |
| 1   | **Номер наряда**         | Натуральное число для удобства нумерации в UX      | -           |
| 2   | **Дата-время создания**  | Дата-время создания наряда                         | -           |
| 3   | **Начало периода**       | Поле "За период" - стартовая дата-время            | -           |
| 4   | **Окончание периода**    | Поле "За период" - дата-время окончания периода    | -           |
| 5   | **id создателя**         | uuid автора                                        | -           |
| 6   | **ФИО автора**           | Как автор звался на момент создания наряда у себя в учетной записи (сейчас совпадает с именем, как отображается у владельца) | -           |
| 7   | **Должность автора**     | Как записано на момент создания наряда у автора в учетной записи (сейчас совпадает с должностью, как отображается у владельца) | -           |
| 8   | **Статус**               | "Сформирован" / "Оплачен" / "Удален"               | YES         |
| 9   | **Название наряда**      | То же, что и комментарий к наряду, до 255 символов | YES         |
| 10  | ~~**Дата оплаты**~~      |~~Разумно, но пока не отслеживаем~~                 | -           |
| 11  | ~~**Тип работ**~~        |~~Решили не разделять наряды по типу работ, используем фильтры~~ | -           |
| 12  | ~~**Ссылка на реестр**~~ | ~~Генерируется на основе данных того же наряда. Пока не нужен~~ | -           |

Если делать просмотр "Реестра на выплату": вполне возможно сделать его, например, доступным изнутри конкретного наряда.   

<br>

**Как сейчас:**  

<img width="1000" alt="old list of orders" src="photo_2023-01-26_18-05-36.jpg">

**Пример реализации с учетом требований:**  

<img width="1000" alt="new list of orders" src="Frame 12.png">

<br>

## Требования к РАБОТА (отображение в нарядах)

**Сейчас** наряд - это список работ, которые:
1. находятся в рабочем статусе «Завершено»,
2. у них указаны Исполнители,
3. у них указаны выполненные объёмы,
4. они не попали в сформированные ранее наряды.

> Сейчас:  
> - Больше одного раза пользователь задачу в наряды положить не может;  
> - В помещении больше одной работы данного типа быть не может (и не надо).

**Требуется**, чтобы в наряды попадали работы, обладающие свойствами:
1. находятся в рабочем статусе «Завершено»,
2. у них указаны Исполнители,
3. у них указаны выполненные объёмы
4. в **объемах** выполненной работы есть **изменения относительно предыдущих закрытых нарядов** (т.е. они находятся в статусе  "Оплачен" ~~или "Отправлен на оплату"~~). Мы говорим здесь про поле "Объем"; а вот поля "Всего" (дефектовка) или "Остаток" (что останется на следующую неделю) или сколько "Выдано" исполнителю - системе безразлично.

> - Многократное попадание работы в разные наряды позволяет не пересоздавать работу в случае ее частичного выполнения, а продолжить работу с той же сущностью.  

### Атрибуты работы

| №   | Название                                                        | Комментарий                                                                            | Изменяемое? |
| --- | --------------------------------------------------------------- | -------------------------------------------------------------------------------------- | ----------- |
| 1   | **Исполнитель** / **Сотрудник**                                 | ФИО мастера.                                                                           | -           |
| 2   | **Вид работ** / **Вид работ по ведомости**                      | Как в шахматке (как у подрядчика).                                                     | -           |
| 3   | ~~**Вид работ по 1С**~~                                         | ~~Как в бухгалтерии у закачика, напр. у "ПИК"а - будет позже~~                         | -           |
| 4   | **Единица измерения**                                           | Выносятся отдельно ради сортировки и фильтрации.                                       | -           |
| 5   | **Тип помещения**                                               | "Квартира" / "МОП" / "ЛК" / "ЛХ" / "Вестибюль".                                        | -           |
| 6   | **Этаж**                                                        | Storey.                                                                                | -           |
| 7   | **Помещение**                                                   | Она же "Ячейка". Иногда в ней пишут всякий ад: "Тамбур1,2,3" или "3,4,5,16эт 8кв" или "3-5,16кв8" или "МОП01,06" или "19-22, 28,30,31МОП", т.к. лень вводить одно и то же. У нас автозаполнение, здесь лежит наименование room group. | -           |
| 8   | **Объем** / **Объем выполненных работ** / **Выполненный объем** | ... мастером за последнюю неделю. Фиксирует технадзор.                                 | -           |
| 9   | **Всего**                                                       | Дефектовка перед началом работы. Данная цифра от наряда к наряду не должна меняться.   | -           |
| 10  | **Процентовка**                                                 | Значение, вычисляемое значение на основе полей "Объем" и "Всего" (отношение в %).      | -           |
| 11  | **Остаток**                                                     | Объем работ, который осталось сделать, начиная со следующей недели.                    | -           |
| 12  | **Расценка**                                                    | Удельная стоимость работы для данного исполнителя.                                     | -           |
| 13  | **К выплате**                                                   | Произведение расценки на объем.                                                        | -           |

<br>

### Как сейчас:

**Шаг 1**:

<img width="1000" alt="old order" src="old_work.png">

**Шаг 2**:

<img width="1000" alt="old order" src="old_work_step_2.png">

<br>

### Пример реализации с учетом требований:

**Шаг 1**:

<img width="1000" alt="new order" src="Frame 49.png">

На шаге 1 формирования наряда со временем надо отражать больше информации:
- **подтянуть последние 3 ссылки на предыдущие наряды по этому объекту, ушедшие на оплату**.
- **за какой диапазон дат создается наряд** (+ сколько в итоге дней накапало) - на основе данных последнего **закрытого наряда**.
- какой это объект (секция) - иначе распечатают и забудут
- кто создает
- ~~возможность задать имя~~
- **на данной иллюстрации не отрисованы фильтры, фильтры тоже должны быть**.

**Шаг 2**:

<img width="1000" alt="new order" src="Frame 48.png">

На шаге 2 обращаем внимание:
- договоренности по оплате с разными работниками разные.

**Шаг 3**:

<img width="1000" alt="new order" src="Frame 47.png">

У сформированного наряда
- можно изменять **Название**
- можно изменять **Статус оплаты**.
    - Если наряд имеет статус оплачено, то все подзадачи, входящие в него, имеют статус "Оплачена".
- В будущих релизах будут отображены перерасходы.

## Сортировка и фильтрация в нарядах

При создании наряда (называется пока "реестр на выплату", но это именно наряд):
- поддерживается **сортировка** на двух этапах:
    - при его создании на **Шаге 1** в списке работ-задач;
    - в готовом наряде.  
- поддерживается **фильтрация**:
    - при создании наряда на **Шаге 1** в списке работ:  
        - по месту проведения работ;
        - по исполнителю;
        - по работам.

По какому принципу осуществляется сортировка:

| N   | Поле таблицы               | Принцип                  |
| --- | -------------------------- | ------------------------ |
| 1   | **Исполнитель**            | По алфавиту: ASC, DESC   |
| 2   | **Вид работ по ведомости** | По алфавиту: ASC, DESC   |
| 3   | **Вид работ по 1С**        | По алфавиту: ASC, DESC   |
| 4   | **Этаж**                   | по полю *level*          |
| 5   | **Помещение**              | по полю *number*         |
| 6   | **Тип помещения**          | По алфавиту: ASC, DESC   |
| 7   | **Объем**                  | алф (будут только числа) |
| 8   | **Всего**                  | алф (будут только числа) |
| 9   | **Процентовка**            | алф (будут только числа) |
| 10  | **Остаток**                | алф (будут только числа) |
| 11  | **Единица измерения**      | По алфавиту: ASC, DES    |
| 12  | **Расценка**               | алф (будут только числа) |
| 13  | **К выплате**              | алф (будут только числа) |

## Частичная оплата работ

"**Частичная оплата работ**" подталкивает создать в БД структуру, имитирующую вложенность частичных задач в основные задачи.  

Видится 3 возможные реализации по БД:
- Каждую неделю таски закрываются и пересодаются таски на остаток - тогда раз в неделю, фактически, вся шахматка целиком принудительно обновляется (будет сложно версионировать? Сложно читать логи? Сложно проводить аналитику? зато не нужно вводить новые сущности)
- Сделать две сущности - работы (пустой контейнер, в котором всегда лежит как минимум одна частичная работа) и частичные работы (основная сущность со всеми статусами "Ожидает дефектовку"/.../.../.../"Завершено"/"Готово к оплате"), тогда подзадачи - основная сущность, а таска только собирает их воедино, обеспечивая лучшую читаемость процессов;
- Сделать две сущности - работа и подработа, но **вложенной подтаске отдать только статус об оплате**. Остальные все свойства останутся с главной таской, как раньше. **Предлагается пойти по третьему пути**. 

> Не принципиально, как в целом хранить всю конструкцию в БД - создать ли отдельную таблицу под сабтаски с полем под родительскую такску; или создать отдельную таблицу для связи тасками с сабтасками; или даже просто хранить одну таблицу с "транзакциями" родительских тасок. Необходимо обсудить.  
> Взаимосвязи статусов друг с другом нет.
> Также внутри каждого статус разрешены переходы из любого состояния в любое состояние.

Статус оплаты предлагается отделить от таски и обогатить:

- **Статус оплаты** частичных работ (**payment-status** у сабтаски):

| Database       | UI                                                                              |
| -------------- | ------------------------------------------------------------------------------- |
| notPaid        | "Сформирован" - работа еще не оплачена. Дефолтное состояние. |
| ~~readyToPay~~ | ~~"Отправлен на оплату" (потребуется ближе к 1С, но можно и сразу внедрить)~~ |
| paid           | "Оплачен" - пользователь переводит подтаски в этот статус вручную при смене статуса наряда. ~~При интеграйции с 1С факт оплаты может быть проставлен автомтачиеки~~ |     

- **Статус выполнения** работ (**progress-status** у таски):

| Database                        | UI                                |
| ------------------------------- | --------------------------------- |
| volumeEdit                      | "Ожидает дефектовку"              |
| draft                           | "Готово к работе"                 |
| inProgress                      | "В работе"                        |
| readyToCheckTechnicalSupervisor | "Ожидает технадзор"               |
| hasRevisions                    | "Есть замечания"                  |
| completed                       | "Завершено"                       |

## Требования

- Пользователь может создать новый наряд. Заполняемые атрибуты нового наряда:
    - Номер наряда
    - Дата-время создания 
    - За какое время наряд (начало)
    - За какое время наряд (окончание)
    - author_id - идентификатор создателя
    - ФИО

    - Статус наряда (по умолчанию "Сформирован").
- Пользователь может менять статус наряда:
    - "Сформирован", "Оплачен", "Удален".
- Пользователь может редактировать название наряда:
    - название по умолчанию "Наряд № 3 от 24 января 2023".
- Секция лучше бы где-то заголовке была - а то распечатают наряд и забудут, откуда он и куда.
- Все документы вроде как предпочтительнее сгружать в pdf.
- У сформированного наряда можно изменять имя и статус оплаты. Если наряд имеет статус оплачено, то все подзадачи, входящие в него, имеют статус "Оплачена".
- ~~Наряд должен подсвечивать перерасходы (в будущих релизах)~~
- При создании нового наряда:
    3. Система должна предоставлять пользователю возможность быстро сбросить все фильтры вместе.
    4. Система должна предоставлять пользователю возможность быстро сбросить каждый из фильтров по отдельности.
    5. Система должна предоставлять пользователю возможность добавить работы, которые он видит, к списку выбранных.
    6. Система должна отображать число работ, выбранных пользователем (может быть больше тех, что он видит).
    7. Система должна позволять пользователю установить расценки для каждой из работ индивидуально для каждого исполнителя - из числа связанных с выбранными задачами. Если мы нашли 100 задач за эту неделю, и они все относятся к одному из 5 наименований работ и были выполнены одним из 15 исполнителей, то максимум, сколько расценок нам система предложит внести - это 15*5 = 75 расценок. Из этого декартова произведения отображаются только те, которые друг с другом связаны через реальную актуальную задачу, которую пользователь хочет отразить в наряде.
    8. При запросе расценок у пользователя система предзаполняет все расценки, которые может, на основе последних данных.
    9. После подтверждения пользователем расценок, они обновляются в базе для данного наименования работ и данного исполнителя.  
- Взаимосвязи статусов друг с другом нет: разрешены переходы из любого состояния в любое состояние.

### Доп требования по работам и частичному закрытию работ

1. Если дефектовка не указана или выданный объем работ не указан, то что станет с "Процентовкой", "Всего", "Остаток"? Они должны быть недоступными. БОлее того, эта их недоступность должна как-то визуально отличаться от почасовых работ!
2. Если у нас перерасход, список работ должен это отражать! Почему это в закрытие наряда не должа попасть работа, которая уже на 120% сделана? Она должна попасть, если новый объем работ у нас больше, чем объем работ в последнем созданном наряде, 
3. Пользователь сам должен перед созданием наряда надо все интересующие его работы перевести именно в статус "Завершено".  
4. Так а в чем в итоге проблема с постоянным пересозданием задач на остаток?
5. По умолчанию "Комментарий" / "Имя наряда" будет "Реестр на выплату № ХХХХХ от YYYY января 2023".
6. КАЖДЫЙ РАЗ, КАК ПОЛЬЗОВАТЕЛЬ (СОЗДАТЕЛЬ ИЛИ РЕДАКТОР) создает наряд, система должна создавать подтаски, если не сказать, что существовать они должны вообще с самого начала.
    - смысл ровно в том, что в наряд залетает подтаска, имеющая параметры, как указано прямо сейчас в таске. Хэппи-пас заключается в том, что она станет оплаченной, зафиксируется и будет потом учитываться в метриках по родительской таске. Этот статус оплаченной подтаски можно и отменить. Но это жесть полная. Фактически, мы предлагаем сделать таки транзакцию - на основе состояния системы, которое может быть сколь угодно неконсистентным.
7. Каждый раз, когда пользователь меняет в боковой панели объем готовых работ, он не может их уменьшить, если у него есть проводки по данной таске в нарядах!!!
8. Пользователь может переводить статус некоторых подтасок в ~~"Кандидат на оплачено" или даже сразу~~ "Оплачено" ручками, когда посылает закрываемый наряд координирующему лицу или в бухгалтерию. Все подтаски внутри него во-первых, создадутся, а во-вторых сразу получат статус "Оплачено" (а других, выходит, и не нужно иметь).
9. Если работа находится в статусе выполнения «Завершено», это не значит, что потом нельзя ее перевести в другой статус. Можно - в любой.  
10. При этом перевод статусов оплаты должен быть строгим (то есть перевод статуса наряда, вместе со всеми его подтасками)! При смене статуса наряда руками дожна вылезать модалка с подтерждением (или должен быть оч. строгий сопровождающий текст) - мол работы этого наряда будут учитываться как получившие полную или частичную оплату! А если отменяем статус оплачено: работы этого наряда больше не будут считаться оплаченными, что повлечет мол за собой недоразумения и коллизии различные в шахматке и боковой панели.
11. Нужна где-то жирная кнопка - пол статус наряда делаем "Оплачен". Эту кнопку можно отжать, получив что-то вроде отката.




1. Номер наряда - для каждого нового наряда это следующее натуральное число.
2. Если когда-либо будет реализовано удаление наряда (жесткое, прямо из базы), все равно номер продолжает возрастать по отношению к максимальному текущему номеру среди существующих нарядов для данного объекта.
3. При смене данных шамхатки, тасок, пользователей и пр. - данные в наряде не меняются.
4. Если когда-то будет поддержка алиасов для пользователей - а нарядах нам все равно нужно сквозное отображение авторов - все редакторы друг друга должны все идентифицировать однозначно. Это поинт в пользу того, что вообще не нужны нам алиасы.


1. Другие требования: когда пролистываешь наряд вниз, заголовки должны прилипнуть к верхней части. При этом подумать, как быть с правой частью.
2. У каждой таски есть, получаетя какой-то айдишник в разрезе конкретного наряда. Наверное, он должен генерироваться и голову можно не морочить.
3. Элементы списка нарядов (наряды) удаляются жестко.
4. Система должна предложить отменить действие хотя бы 5 секунд
5. Очень напрашивается система версионирования на проработку - в том числе с этими логами и пр. 
6. Вообще важный момент, что мы таки указываем сдельные работы в нарядах.
7. ССЫЛКА НА РЕЕСТР НА ВЫПЛАТУ С ВОЗМОЖНОСТЬЮ СКАЧАТЬ ДОЛЖНА БЫТЬ ПРИЦЕПЛЕНА К НАРЯДУ. и реестр на выплату также как бы держит внутри данные, актуальные на какой-то момент и неизменяемые.



---


Обычно:  
1. **Заказ-наряд (наряд)** - формируемый перед началом работ документ, содержащий название-описание предстоящих работ для конкретного работника (обычно на ближайшую неделю), в которой ставится его подпись и подпись выдавшего работу начальника (прораба, мастера участка). В конце, после выполнения работ, подпись в наряде также ставит приемщик работ (технадзор) и в конце кто-то из бухгалтерии. Наряд - это срез вдоль работ в определенный момент времени.  
Обычно в ПИК эта формальная процедура опускается: наряды раздаются людям в устрой форме в штабе.  
2. **Табель** - таблица учета почасовых (поденных, повременных и пр.) работ; вид работа один и тот же. Табель - это срез вдоль времени для конкретной работы. Также табель - это уже закрытый график по часам за период.  
3. На основании наряда или табеля в 1С создаются **ведомости на счета** ("ведомость на выплату заработной платы на счета сотрудников") и **начисления**.







